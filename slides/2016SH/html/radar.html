<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="data:application/x-javascript;base64,KGZ1bmN0aW9uKCkgewogIC8vIElmIHdpbmRvdy5IVE1MV2lkZ2V0cyBpcyBhbHJlYWR5IGRlZmluZWQsIHRoZW4gdXNlIGl0OyBvdGhlcndpc2UgY3JlYXRlIGEKICAvLyBuZXcgb2JqZWN0LiBUaGlzIGFsbG93cyBwcmVjZWRpbmcgY29kZSB0byBzZXQgb3B0aW9ucyB0aGF0IGFmZmVjdCB0aGUKICAvLyBpbml0aWFsaXphdGlvbiBwcm9jZXNzICh0aG91Z2ggbm9uZSBjdXJyZW50bHkgZXhpc3QpLgogIHdpbmRvdy5IVE1MV2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cyB8fCB7fTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gYSB2aWV3ZXIgcGFuZS4gSWYgbm90LCB3ZSdyZSBpbiBhIHdlYiBicm93c2VyLgogIHZhciB2aWV3ZXJNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnZpZXdlck1vZGUgPQogICAgICAvXGJ2aWV3ZXJfcGFuZT0xXGIvLnRlc3Qod2luZG93LmxvY2F0aW9uKTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gU2hpbnkgbW9kZS4gSWYgbm90LCBpdCdzIGEgc3RhdGljIGRvY3VtZW50LgogIC8vIE5vdGUgdGhhdCBzdGF0aWMgd2lkZ2V0cyBjYW4gYXBwZWFyIGluIGJvdGggU2hpbnkgYW5kIHN0YXRpYyBtb2RlcywgYnV0CiAgLy8gb2J2aW91c2x5LCBTaGlueSB3aWRnZXRzIGNhbiBvbmx5IGFwcGVhciBpbiBTaGlueSBhcHBzL2RvY3VtZW50cy4KICB2YXIgc2hpbnlNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnNoaW55TW9kZSA9CiAgICAgIHR5cGVvZih3aW5kb3cuU2hpbnkpICE9PSAidW5kZWZpbmVkIiAmJiAhIXdpbmRvdy5TaGlueS5vdXRwdXRCaW5kaW5nczsKCiAgLy8gV2UgY2FuJ3QgY291bnQgb24galF1ZXJ5IGJlaW5nIGF2YWlsYWJsZSwgc28gd2UgaW1wbGVtZW50IG91ciBvd24KICAvLyB2ZXJzaW9uIGlmIG5lY2Vzc2FyeS4KICBmdW5jdGlvbiBxdWVyeVNlbGVjdG9yQWxsKHNjb3BlLCBzZWxlY3RvcikgewogICAgaWYgKHR5cGVvZihqUXVlcnkpICE9PSAidW5kZWZpbmVkIiAmJiBzY29wZSBpbnN0YW5jZW9mIGpRdWVyeSkgewogICAgICByZXR1cm4gc2NvcGUuZmluZChzZWxlY3Rvcik7CiAgICB9CiAgICBpZiAoc2NvcGUucXVlcnlTZWxlY3RvckFsbCkgewogICAgICByZXR1cm4gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhc0FycmF5KHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpCiAgICAgIHJldHVybiBbXTsKICAgIGlmICgkLmlzQXJyYXkodmFsdWUpKQogICAgICByZXR1cm4gdmFsdWU7CiAgICByZXR1cm4gW3ZhbHVlXTsKICB9CgogIC8vIEltcGxlbWVudCBqUXVlcnkncyBleHRlbmQKICBmdW5jdGlvbiBleHRlbmQodGFyZ2V0IC8qLCAuLi4gKi8pIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgdGFyZ2V0W3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CgogIC8vIElFOCBkb2Vzbid0IHN1cHBvcnQgQXJyYXkuZm9yRWFjaC4KICBmdW5jdGlvbiBmb3JFYWNoKHZhbHVlcywgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmICh2YWx1ZXMuZm9yRWFjaCkgewogICAgICB2YWx1ZXMuZm9yRWFjaChjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgdmFsdWVzW2ldLCBpLCB2YWx1ZXMpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZXBsYWNlcyB0aGUgc3BlY2lmaWVkIG1ldGhvZCB3aXRoIHRoZSByZXR1cm4gdmFsdWUgb2YgZnVuY1NvdXJjZS4KICAvLwogIC8vIE5vdGUgdGhhdCBmdW5jU291cmNlIHNob3VsZCBub3QgQkUgdGhlIG5ldyBtZXRob2QsIGl0IHNob3VsZCBiZSBhIGZ1bmN0aW9uCiAgLy8gdGhhdCBSRVRVUk5TIHRoZSBuZXcgbWV0aG9kLiBmdW5jU291cmNlIHJlY2VpdmVzIGEgc2luZ2xlIGFyZ3VtZW50IHRoYXQgaXMKICAvLyB0aGUgb3ZlcnJpZGRlbiBtZXRob2QsIGl0IGNhbiBiZSBjYWxsZWQgZnJvbSB0aGUgbmV3IG1ldGhvZC4gVGhlIG92ZXJyaWRkZW4KICAvLyBtZXRob2QgY2FuIGJlIGNhbGxlZCBsaWtlIGEgcmVndWxhciBmdW5jdGlvbiwgaXQgaGFzIHRoZSB0YXJnZXQgcGVybWFuZW50bHkKICAvLyBib3VuZCB0byBpdCBzbyAidGhpcyIgd2lsbCB3b3JrIGNvcnJlY3RseS4KICBmdW5jdGlvbiBvdmVycmlkZU1ldGhvZCh0YXJnZXQsIG1ldGhvZE5hbWUsIGZ1bmNTb3VyY2UpIHsKICAgIHZhciBzdXBlckZ1bmMgPSB0YXJnZXRbbWV0aG9kTmFtZV0gfHwgZnVuY3Rpb24oKSB7fTsKICAgIHZhciBzdXBlckZ1bmNCb3VuZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3VwZXJGdW5jLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKICAgIH07CiAgICB0YXJnZXRbbWV0aG9kTmFtZV0gPSBmdW5jU291cmNlKHN1cGVyRnVuY0JvdW5kKTsKICB9CgogIC8vIEFkZCBhIG1ldGhvZCB0byBkZWxlZ2F0b3IgdGhhdCwgd2hlbiBpbnZva2VkLCBjYWxscwogIC8vIGRlbGVnYXRlZS5tZXRob2ROYW1lLiBJZiB0aGVyZSBpcyBubyBzdWNoIG1ldGhvZCBvbgogIC8vIHRoZSBkZWxlZ2F0ZWUsIGJ1dCB0aGVyZSB3YXMgb25lIG9uIGRlbGVnYXRvciBiZWZvcmUKICAvLyBkZWxlZ2F0ZU1ldGhvZCB3YXMgY2FsbGVkLCB0aGVuIHRoZSBvcmlnaW5hbCB2ZXJzaW9uCiAgLy8gaXMgaW52b2tlZCBpbnN0ZWFkLgogIC8vIEZvciBleGFtcGxlOgogIC8vCiAgLy8gdmFyIGEgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2ExJyk7IH0KICAvLyAgIG1ldGhvZDI6IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnYTInKTsgfQogIC8vIH07CiAgLy8gdmFyIGIgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2IxJyk7IH0KICAvLyB9OwogIC8vIGRlbGVnYXRlTWV0aG9kKGEsIGIsICJtZXRob2QxIik7CiAgLy8gZGVsZWdhdGVNZXRob2QoYSwgYiwgIm1ldGhvZDIiKTsKICAvLyBhLm1ldGhvZDEoKTsKICAvLyBhLm1ldGhvZDIoKTsKICAvLwogIC8vIFRoZSBvdXRwdXQgd291bGQgYmUgImIxIiwgImEyIi4KICBmdW5jdGlvbiBkZWxlZ2F0ZU1ldGhvZChkZWxlZ2F0b3IsIGRlbGVnYXRlZSwgbWV0aG9kTmFtZSkgewogICAgdmFyIGluaGVyaXRlZCA9IGRlbGVnYXRvclttZXRob2ROYW1lXTsKICAgIGRlbGVnYXRvclttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFyZ2V0ID0gZGVsZWdhdGVlOwogICAgICB2YXIgbWV0aG9kID0gZGVsZWdhdGVlW21ldGhvZE5hbWVdOwoKICAgICAgLy8gVGhlIG1ldGhvZCBkb2Vzbid0IGV4aXN0IG9uIHRoZSBkZWxlZ2F0ZWUuIEluc3RlYWQsCiAgICAgIC8vIGNhbGwgdGhlIG1ldGhvZCBvbiB0aGUgZGVsZWdhdG9yLCBpZiBpdCBleGlzdHMuCiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgdGFyZ2V0ID0gZGVsZWdhdG9yOwogICAgICAgIG1ldGhvZCA9IGluaGVyaXRlZDsKICAgICAgfQoKICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgLy8gSW1wbGVtZW50IGEgdmFndWUgZmFjc2ltaWxpZSBvZiBqUXVlcnkncyBkYXRhIG1ldGhvZAogIGZ1bmN0aW9uIGVsZW1lbnREYXRhKGVsLCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewogICAgICByZXR1cm4gZWxbImh0bWx3aWRnZXRfZGF0YV8iICsgbmFtZV07CiAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMykgewogICAgICBlbFsiaHRtbHdpZGdldF9kYXRhXyIgKyBuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gZWw7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldyb25nIG51bWJlciBvZiBhcmd1bWVudHMgZm9yIGVsZW1lbnREYXRhOiAiICsKICAgICAgICBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0KICB9CgogIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzQ0NjE3MC9lc2NhcGUtc3RyaW5nLWZvci11c2UtaW4tamF2YXNjcmlwdC1yZWdleAogIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOwogIH0KCiAgZnVuY3Rpb24gaGFzQ2xhc3MoZWwsIGNsYXNzTmFtZSkgewogICAgdmFyIHJlID0gbmV3IFJlZ0V4cCgiXFxiIiArIGVzY2FwZVJlZ0V4cChjbGFzc05hbWUpICsgIlxcYiIpOwogICAgcmV0dXJuIHJlLnRlc3QoZWwuY2xhc3NOYW1lKTsKICB9CgogIC8vIGVsZW1lbnRzIC0gYXJyYXkgKG9yIGFycmF5LWxpa2Ugb2JqZWN0KSBvZiBIVE1MIGVsZW1lbnRzCiAgLy8gY2xhc3NOYW1lIC0gY2xhc3MgbmFtZSB0byB0ZXN0IGZvcgogIC8vIGluY2x1ZGUgLSBpZiB0cnVlLCBvbmx5IHJldHVybiBlbGVtZW50cyB3aXRoIGdpdmVuIGNsYXNzTmFtZTsKICAvLyAgIGlmIGZhbHNlLCBvbmx5IHJldHVybiBlbGVtZW50cyAqd2l0aG91dCogZ2l2ZW4gY2xhc3NOYW1lCiAgZnVuY3Rpb24gZmlsdGVyQnlDbGFzcyhlbGVtZW50cywgY2xhc3NOYW1lLCBpbmNsdWRlKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoaGFzQ2xhc3MoZWxlbWVudHNbaV0sIGNsYXNzTmFtZSkgPT0gaW5jbHVkZSkKICAgICAgICByZXN1bHRzLnB1c2goZWxlbWVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQoKICBmdW5jdGlvbiBvbihvYmosIGV2ZW50TmFtZSwgZnVuYykgewogICAgaWYgKG9iai5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZnVuYywgZmFsc2UpOwogICAgfSBlbHNlIGlmIChvYmouYXR0YWNoRXZlbnQpIHsKICAgICAgb2JqLmF0dGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBvZmYob2JqLCBldmVudE5hbWUsIGZ1bmMpIHsKICAgIGlmIChvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcikKICAgICAgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jLCBmYWxzZSk7CiAgICBlbHNlIGlmIChvYmouZGV0YWNoRXZlbnQpIHsKICAgICAgb2JqLmRldGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICAvLyBUcmFuc2xhdGUgYXJyYXkgb2YgdmFsdWVzIHRvIHRvcC9yaWdodC9ib3R0b20vbGVmdCwgYXMgdXN1YWwgd2l0aAogIC8vIHRoZSAicGFkZGluZyIgQ1NTIHByb3BlcnR5CiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL3BhZGRpbmcKICBmdW5jdGlvbiB1bnBhY2tQYWRkaW5nKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gIm51bWJlciIpCiAgICAgIHZhbHVlID0gW3ZhbHVlXTsKICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDEpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMF0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzBdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDIpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDMpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDQpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzNdfTsKICAgIH0KICB9CgogIC8vIENvbnZlcnQgYW4gdW5wYWNrZWQgcGFkZGluZyBvYmplY3QgdG8gYSBDU1MgdmFsdWUKICBmdW5jdGlvbiBwYWRkaW5nVG9Dc3MocGFkZGluZ09iaikgewogICAgcmV0dXJuIHBhZGRpbmdPYmoudG9wICsgInB4ICIgKyBwYWRkaW5nT2JqLnJpZ2h0ICsgInB4ICIgKyBwYWRkaW5nT2JqLmJvdHRvbSArICJweCAiICsgcGFkZGluZ09iai5sZWZ0ICsgInB4IjsKICB9CgogIC8vIE1ha2VzIGEgbnVtYmVyIHN1aXRhYmxlIGZvciBDU1MKICBmdW5jdGlvbiBweCh4KSB7CiAgICBpZiAodHlwZW9mKHgpID09PSAibnVtYmVyIikKICAgICAgcmV0dXJuIHggKyAicHgiOwogICAgZWxzZQogICAgICByZXR1cm4geDsKICB9CgogIC8vIFJldHJpZXZlcyBydW50aW1lIHdpZGdldCBzaXppbmcgaW5mb3JtYXRpb24gZm9yIGFuIGVsZW1lbnQuCiAgLy8gVGhlIHJldHVybiB2YWx1ZSBpcyBlaXRoZXIgbnVsbCwgb3IgYW4gb2JqZWN0IHdpdGggZmlsbCwgcGFkZGluZywKICAvLyBkZWZhdWx0V2lkdGgsIGRlZmF1bHRIZWlnaHQgZmllbGRzLgogIGZ1bmN0aW9uIHNpemluZ1BvbGljeShlbCkgewogICAgdmFyIHNpemluZ0VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcigic2NyaXB0W2RhdGEtZm9yPSciICsgZWwuaWQgKyAiJ11bdHlwZT0nYXBwbGljYXRpb24vaHRtbHdpZGdldC1zaXppbmcnXSIpOwogICAgaWYgKCFzaXppbmdFbCkKICAgICAgcmV0dXJuIG51bGw7CiAgICB2YXIgc3AgPSBKU09OLnBhcnNlKHNpemluZ0VsLnRleHRDb250ZW50IHx8IHNpemluZ0VsLnRleHQgfHwgInt9Iik7CiAgICBpZiAodmlld2VyTW9kZSkgewogICAgICByZXR1cm4gc3Audmlld2VyOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNwLmJyb3dzZXI7CiAgICB9CiAgfQoKICAvLyBAcGFyYW0gdGFza3MgQXJyYXkgb2Ygc3RyaW5ncyAob3IgZmFsc3kgdmFsdWUsIGluIHdoaWNoIGNhc2Ugbm8tb3ApLgogIC8vICAgRWFjaCBlbGVtZW50IG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IGV4cHJlc3Npb24gdGhhdCB5aWVsZHMgYQogIC8vICAgZnVuY3Rpb24uIE9yLCBjYW4gYmUgYW4gYXJyYXkgb2Ygb2JqZWN0cyB3aXRoICJjb2RlIiBhbmQgImRhdGEiCiAgLy8gICBwcm9wZXJ0aWVzOyBpbiB0aGlzIGNhc2UsIHRoZSAiY29kZSIgcHJvcGVydHkgc2hvdWxkIGJlIGEgc3RyaW5nCiAgLy8gICBvZiBKUyB0aGF0J3MgYW4gZXhwciB0aGF0IHlpZWxkcyBhIGZ1bmN0aW9uLCBhbmQgImRhdGEiIHNob3VsZCBiZQogIC8vICAgYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhZGRlZCBhcyBhbiBhZGRpdGlvbmFsIGFyZ3VtZW50IHdoZW4gdGhhdAogIC8vICAgZnVuY3Rpb24gaXMgY2FsbGVkLgogIC8vIEBwYXJhbSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgInRoaXMiIGZvciBlYWNoIGZ1bmN0aW9uCiAgLy8gICBleGVjdXRpb24uCiAgLy8gQHBhcmFtIGFyZ3MgQXJyYXkgb2YgYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgZnVuY3Rpb25zLiAoVGhlCiAgLy8gICBzYW1lIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBhbGwgZnVuY3Rpb25zLikKICBmdW5jdGlvbiBldmFsQW5kUnVuKHRhc2tzLCB0YXJnZXQsIGFyZ3MpIHsKICAgIGlmICh0YXNrcykgewogICAgICBmb3JFYWNoKHRhc2tzLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgdmFyIHRoZXNlQXJncyA9IGFyZ3M7CiAgICAgICAgaWYgKHR5cGVvZih0YXNrKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRoZXNlQXJncyA9IHRoZXNlQXJncy5jb25jYXQoW3Rhc2suZGF0YV0pOwogICAgICAgICAgdGFzayA9IHRhc2suY29kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHRhc2tGdW5jID0gZXZhbCgiKCIgKyB0YXNrICsgIikiKTsKICAgICAgICBpZiAodHlwZW9mKHRhc2tGdW5jKSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXNrIG11c3QgYmUgYSBmdW5jdGlvbiEgU291cmNlOlxuIiArIHRhc2spOwogICAgICAgIH0KICAgICAgICB0YXNrRnVuYy5hcHBseSh0YXJnZXQsIHRoZXNlQXJncyk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdFNpemluZyhlbCkgewogICAgdmFyIHNpemluZyA9IHNpemluZ1BvbGljeShlbCk7CiAgICBpZiAoIXNpemluZykKICAgICAgcmV0dXJuOwoKICAgIHZhciBjZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiaHRtbHdpZGdldF9jb250YWluZXIiKTsKICAgIGlmICghY2VsKQogICAgICByZXR1cm47CgogICAgaWYgKHR5cGVvZihzaXppbmcucGFkZGluZykgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUubWFyZ2luID0gIjAiOwogICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLnBhZGRpbmcgPSBwYWRkaW5nVG9Dc3ModW5wYWNrUGFkZGluZyhzaXppbmcucGFkZGluZykpOwogICAgfQoKICAgIGlmIChzaXppbmcuZmlsbCkgewogICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICAgIGlmIChjZWwpIHsKICAgICAgICBjZWwuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICAgIHZhciBwYWQgPSB1bnBhY2tQYWRkaW5nKHNpemluZy5wYWRkaW5nKTsKICAgICAgICBjZWwuc3R5bGUudG9wID0gcGFkLnRvcCArICJweCI7CiAgICAgICAgY2VsLnN0eWxlLnJpZ2h0ID0gcGFkLnJpZ2h0ICsgInB4IjsKICAgICAgICBjZWwuc3R5bGUuYm90dG9tID0gcGFkLmJvdHRvbSArICJweCI7CiAgICAgICAgY2VsLnN0eWxlLmxlZnQgPSBwYWQubGVmdCArICJweCI7CiAgICAgICAgZWwuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsgcmV0dXJuIGNlbC5vZmZzZXRXaWR0aDsgfSwKICAgICAgICBnZXRIZWlnaHQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY2VsLm9mZnNldEhlaWdodDsgfQogICAgICB9OwoKICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLndpZHRoID0gcHgoc2l6aW5nLndpZHRoKTsKICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gcHgoc2l6aW5nLmhlaWdodCk7CgogICAgICByZXR1cm4gewogICAgICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsgcmV0dXJuIGVsLm9mZnNldFdpZHRoOyB9LAogICAgICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7IHJldHVybiBlbC5vZmZzZXRIZWlnaHQ7IH0KICAgICAgfTsKICAgIH0KICB9CgogIC8vIERlZmF1bHQgaW1wbGVtZW50YXRpb25zIGZvciBtZXRob2RzCiAgdmFyIGRlZmF1bHRzID0gewogICAgZmluZDogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgcmV0dXJuIHF1ZXJ5U2VsZWN0b3JBbGwoc2NvcGUsICIuIiArIHRoaXMubmFtZSk7CiAgICB9LAogICAgcmVuZGVyRXJyb3I6IGZ1bmN0aW9uKGVsLCBlcnIpIHsKICAgICAgdmFyICRlbCA9ICQoZWwpOwoKICAgICAgdGhpcy5jbGVhckVycm9yKGVsKTsKCiAgICAgIC8vIEFkZCBhbGwgdGhlc2UgZXJyb3IgY2xhc3NlcywgYXMgU2hpbnkgZG9lcwogICAgICB2YXIgZXJyQ2xhc3MgPSAic2hpbnktb3V0cHV0LWVycm9yIjsKICAgICAgaWYgKGVyci50eXBlICE9PSBudWxsKSB7CiAgICAgICAgLy8gdXNlIHRoZSBjbGFzc2VzIG9mIHRoZSBlcnJvciBjb25kaXRpb24gYXMgQ1NTIGNsYXNzIG5hbWVzCiAgICAgICAgZXJyQ2xhc3MgPSBlcnJDbGFzcyArICIgIiArICQubWFwKGFzQXJyYXkoZXJyLnR5cGUpLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICByZXR1cm4gZXJyQ2xhc3MgKyAiLSIgKyB0eXBlOwogICAgICAgIH0pLmpvaW4oIiAiKTsKICAgICAgfQogICAgICBlcnJDbGFzcyA9IGVyckNsYXNzICsgIiBodG1sd2lkZ2V0cy1lcnJvciI7CgogICAgICAvLyBJcyBlbCBpbmxpbmUgb3IgYmxvY2s/IElmIGlubGluZSBvciBpbmxpbmUtYmxvY2ssIGp1c3QgZGlzcGxheTpub25lIGl0CiAgICAgIC8vIGFuZCBhZGQgYW4gaW5saW5lIGVycm9yLgogICAgICB2YXIgZGlzcGxheSA9ICRlbC5jc3MoImRpc3BsYXkiKTsKICAgICAgJGVsLmRhdGEoInJlc3RvcmUtZGlzcGxheS1tb2RlIiwgZGlzcGxheSk7CgogICAgICBpZiAoZGlzcGxheSA9PT0gImlubGluZSIgfHwgZGlzcGxheSA9PT0gImlubGluZS1ibG9jayIpIHsKICAgICAgICAkZWwuaGlkZSgpOwogICAgICAgIGlmIChlcnIubWVzc2FnZSAhPT0gIiIpIHsKICAgICAgICAgIHZhciBlcnJvclNwYW4gPSAkKCI8c3Bhbj4iKS5hZGRDbGFzcyhlcnJDbGFzcyk7CiAgICAgICAgICBlcnJvclNwYW4udGV4dChlcnIubWVzc2FnZSk7CiAgICAgICAgICAkZWwuYWZ0ZXIoZXJyb3JTcGFuKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZGlzcGxheSA9PT0gImJsb2NrIikgewogICAgICAgIC8vIElmIGJsb2NrLCBhZGQgYW4gZXJyb3IganVzdCBhZnRlciB0aGUgZWwsIHNldCB2aXNpYmlsaXR5Om5vbmUgb24gdGhlCiAgICAgICAgLy8gZWwsIGFuZCBwb3NpdGlvbiB0aGUgZXJyb3IgdG8gYmUgb24gdG9wIG9mIHRoZSBlbC4KICAgICAgICAvLyBNYXJrIGl0IHdpdGggYSB1bmlxdWUgSUQgYW5kIENTUyBjbGFzcyBzbyB3ZSBjYW4gcmVtb3ZlIGl0IGxhdGVyLgogICAgICAgICRlbC5jc3MoInZpc2liaWxpdHkiLCAiaGlkZGVuIik7CiAgICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSAiIikgewogICAgICAgICAgdmFyIGVycm9yRGl2ID0gJCgiPGRpdj4iKS5hZGRDbGFzcyhlcnJDbGFzcykuY3NzKCJwb3NpdGlvbiIsICJhYnNvbHV0ZSIpCiAgICAgICAgICAgIC5jc3MoInRvcCIsIGVsLm9mZnNldFRvcCkKICAgICAgICAgICAgLmNzcygibGVmdCIsIGVsLm9mZnNldExlZnQpCiAgICAgICAgICAgIC8vIHNldHRpbmcgd2lkdGggY2FuIHB1c2ggb3V0IHRoZSBwYWdlIHNpemUsIGZvcmNpbmcgb3RoZXJ3aXNlCiAgICAgICAgICAgIC8vIHVubmVjZXNzYXJ5IHNjcm9sbGJhcnMgdG8gYXBwZWFyIGFuZCBtYWtpbmcgaXQgaW1wb3NzaWJsZSBmb3IKICAgICAgICAgICAgLy8gdGhlIGVsZW1lbnQgdG8gc2hyaW5rOyBzbyB1c2UgbWF4LXdpZHRoIGluc3RlYWQKICAgICAgICAgICAgLmNzcygibWF4V2lkdGgiLCBlbC5vZmZzZXRXaWR0aCkKICAgICAgICAgICAgLmNzcygiaGVpZ2h0IiwgZWwub2Zmc2V0SGVpZ2h0KTsKICAgICAgICAgIGVycm9yRGl2LnRleHQoZXJyLm1lc3NhZ2UpOwogICAgICAgICAgJGVsLmFmdGVyKGVycm9yRGl2KTsKCiAgICAgICAgICAvLyBSZWFsbHkgZHVtYiB3YXkgdG8ga2VlcCB0aGUgc2l6ZS9wb3NpdGlvbiBvZiB0aGUgZXJyb3IgaW4gc3luYyB3aXRoCiAgICAgICAgICAvLyB0aGUgcGFyZW50IGVsZW1lbnQgYXMgdGhlIHdpbmRvdyBpcyByZXNpemVkIG9yIHdoYXRldmVyLgogICAgICAgICAgdmFyIGludElkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZXJyb3JEaXZbMF0ucGFyZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50SWQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvckRpdgogICAgICAgICAgICAgIC5jc3MoInRvcCIsIGVsLm9mZnNldFRvcCkKICAgICAgICAgICAgICAuY3NzKCJsZWZ0IiwgZWwub2Zmc2V0TGVmdCkKICAgICAgICAgICAgICAuY3NzKCJtYXhXaWR0aCIsIGVsLm9mZnNldFdpZHRoKQogICAgICAgICAgICAgIC5jc3MoImhlaWdodCIsIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgICB9LCA1MDApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNsZWFyRXJyb3I6IGZ1bmN0aW9uKGVsKSB7CiAgICAgIHZhciAkZWwgPSAkKGVsKTsKICAgICAgdmFyIGRpc3BsYXkgPSAkZWwuZGF0YSgicmVzdG9yZS1kaXNwbGF5LW1vZGUiKTsKICAgICAgJGVsLmRhdGEoInJlc3RvcmUtZGlzcGxheS1tb2RlIiwgbnVsbCk7CgogICAgICBpZiAoZGlzcGxheSA9PT0gImlubGluZSIgfHwgZGlzcGxheSA9PT0gImlubGluZS1ibG9jayIpIHsKICAgICAgICBpZiAoZGlzcGxheSkKICAgICAgICAgICRlbC5jc3MoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICAkKGVsLm5leHRTaWJsaW5nKS5maWx0ZXIoIi5odG1sd2lkZ2V0cy1lcnJvciIpLnJlbW92ZSgpOwogICAgICB9IGVsc2UgaWYgKGRpc3BsYXkgPT09ICJibG9jayIpewogICAgICAgICRlbC5jc3MoInZpc2liaWxpdHkiLCAiaW5oZXJpdCIpOwogICAgICAgICQoZWwubmV4dFNpYmxpbmcpLmZpbHRlcigiLmh0bWx3aWRnZXRzLWVycm9yIikucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sCiAgICBzaXppbmc6IHt9CiAgfTsKCiAgLy8gQ2FsbGVkIGJ5IHdpZGdldCBiaW5kaW5ncyB0byByZWdpc3RlciBhIG5ldyB0eXBlIG9mIHdpZGdldC4gVGhlIGRlZmluaXRpb24KICAvLyBvYmplY3QgY2FuIGNvbnRhaW4gdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogIC8vIC0gbmFtZSAocmVxdWlyZWQpIC0gQSBzdHJpbmcgaW5kaWNhdGluZyB0aGUgYmluZGluZyBuYW1lLCB3aGljaCB3aWxsIGJlCiAgLy8gICB1c2VkIGJ5IGRlZmF1bHQgYXMgdGhlIENTUyBjbGFzc25hbWUgdG8gbG9vayBmb3IuCiAgLy8gLSBpbml0aWFsaXplIChvcHRpb25hbCkgLSBBIGZ1bmN0aW9uKGVsKSB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgcGVyCiAgLy8gICB3aWRnZXQgZWxlbWVudDsgaWYgYSB2YWx1ZSBpcyByZXR1cm5lZCwgaXQgd2lsbCBiZSBwYXNzZWQgYXMgdGhlIHRoaXJkCiAgLy8gICB2YWx1ZSB0byByZW5kZXJWYWx1ZS4KICAvLyAtIHJlbmRlclZhbHVlIChyZXF1aXJlZCkgLSBBIGZ1bmN0aW9uKGVsLCBkYXRhLCBpbml0VmFsdWUpIHRoYXQgd2lsbCBiZQogIC8vICAgY2FsbGVkIHdpdGggZGF0YS4gU3RhdGljIGNvbnRleHRzIHdpbGwgY2F1c2UgdGhpcyB0byBiZSBjYWxsZWQgb25jZSBwZXIKICAvLyAgIGVsZW1lbnQ7IFNoaW55IGFwcHMgd2lsbCBjYXVzZSB0aGlzIHRvIGJlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBwZXIKICAvLyAgIGVsZW1lbnQsIGFzIHRoZSBkYXRhIGNoYW5nZXMuCiAgd2luZG93LkhUTUxXaWRnZXRzLndpZGdldCA9IGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKICAgIGlmICghZGVmaW5pdGlvbi5uYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIG5hbWUiKTsKICAgIH0KICAgIGlmICghZGVmaW5pdGlvbi50eXBlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIHR5cGUiKTsKICAgIH0KICAgIC8vIEN1cnJlbnRseSB3ZSBvbmx5IHN1cHBvcnQgb3V0cHV0IHdpZGdldHMKICAgIGlmIChkZWZpbml0aW9uLnR5cGUgIT09ICJvdXRwdXQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIHdpZGdldCB0eXBlICciICsgZGVmaW5pdGlvbi50eXBlICsgIiciKTsKICAgIH0KICAgIC8vIFRPRE86IFZlcmlmeSB0aGF0IC5uYW1lIGlzIGEgdmFsaWQgQ1NTIGNsYXNzbmFtZQoKICAgIC8vIFN1cHBvcnQgbmV3LXN0eWxlIGluc3RhbmNlLWJvdW5kIGRlZmluaXRpb25zLiBPbGQtc3R5bGUgY2xhc3MtYm91bmQKICAgIC8vIGRlZmluaXRpb25zIGhhdmUgb25lIHdpZGdldCAib2JqZWN0IiBwZXIgd2lkZ2V0IHBlciB0eXBlL2NsYXNzIG9mCiAgICAvLyB3aWRnZXQ7IHRoZSByZW5kZXJWYWx1ZSBhbmQgcmVzaXplIG1ldGhvZHMgb24gc3VjaCB3aWRnZXQgb2JqZWN0cwogICAgLy8gdGFrZSBlbCBhbmQgaW5zdGFuY2UgYXJndW1lbnRzLCBiZWNhdXNlIHRoZSB3aWRnZXQgb2JqZWN0IGNhbid0CiAgICAvLyBzdG9yZSB0aGVtLiBOZXctc3R5bGUgaW5zdGFuY2UtYm91bmQgZGVmaW5pdGlvbnMgaGF2ZSBvbmUgd2lkZ2V0CiAgICAvLyBvYmplY3QgcGVyIHdpZGdldCBpbnN0YW5jZTsgdGhlIGRlZmluaXRpb24gdGhhdCdzIHBhc3NlZCBpbiBkb2Vzbid0CiAgICAvLyBwcm92aWRlIHJlbmRlclZhbHVlIG9yIHJlc2l6ZSBtZXRob2RzIGF0IGFsbCwganVzdCB0aGUgc2luZ2xlIG1ldGhvZAogICAgLy8gICBmYWN0b3J5KGVsLCB3aWR0aCwgaGVpZ2h0KQogICAgLy8gd2hpY2ggcmV0dXJucyBhbiBvYmplY3QgdGhhdCBoYXMgcmVuZGVyVmFsdWUoeCkgYW5kIHJlc2l6ZSh3LCBoKS4KICAgIC8vIFRoaXMgZW5hYmxlcyBhIGZhciBtb3JlIG5hdHVyYWwgcHJvZ3JhbW1pbmcgc3R5bGUgZm9yIHRoZSB3aWRnZXQKICAgIC8vIGF1dGhvciwgd2hvIGNhbiBzdG9yZSBwZXItaW5zdGFuY2Ugc3RhdGUgdXNpbmcgZWl0aGVyIE9PLXN0eWxlCiAgICAvLyBpbnN0YW5jZSBmaWVsZHMgb3IgZnVuY3Rpb25hbC1zdHlsZSBjbG9zdXJlIHZhcmlhYmxlcyAoSSBndWVzcyB0aGlzCiAgICAvLyBpcyBpbiBjb250cmFzdCB0byB3aGF0IGNhbiBvbmx5IGJlIGNhbGxlZCBDLXN0eWxlIHBzZXVkby1PTyB3aGljaCBpcwogICAgLy8gd2hhdCB3ZSByZXF1aXJlZCBiZWZvcmUpLgogICAgaWYgKGRlZmluaXRpb24uZmFjdG9yeSkgewogICAgICBkZWZpbml0aW9uID0gY3JlYXRlTGVnYWN5RGVmaW5pdGlvbkFkYXB0ZXIoZGVmaW5pdGlvbik7CiAgICB9CgogICAgaWYgKCFkZWZpbml0aW9uLnJlbmRlclZhbHVlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIHJlbmRlclZhbHVlIGZ1bmN0aW9uIik7CiAgICB9CgogICAgLy8gRm9yIHN0YXRpYyByZW5kZXJpbmcgKG5vbi1TaGlueSksIHVzZSBhIHNpbXBsZSB3aWRnZXQgcmVnaXN0cmF0aW9uCiAgICAvLyBzY2hlbWUuIFdlIGFsc28gdXNlIHRoaXMgc2NoZW1lIGZvciBTaGlueSBhcHBzL2RvY3VtZW50cyB0aGF0IGFsc28KICAgIC8vIGNvbnRhaW4gc3RhdGljIHdpZGdldHMuCiAgICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzIHx8IFtdOwogICAgLy8gTWVyZ2UgZGVmYXVsdHMgaW50byB0aGUgZGVmaW5pdGlvbjsgZG9uJ3QgbXV0YXRlIHRoZSBvcmlnaW5hbCBkZWZpbml0aW9uLgogICAgdmFyIHN0YXRpY0JpbmRpbmcgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBkZWZpbml0aW9uKTsKICAgIG92ZXJyaWRlTWV0aG9kKHN0YXRpY0JpbmRpbmcsICJmaW5kIiwgZnVuY3Rpb24oc3VwZXJmdW5jKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSkgewogICAgICAgIHZhciByZXN1bHRzID0gc3VwZXJmdW5jKHNjb3BlKTsKICAgICAgICAvLyBGaWx0ZXIgb3V0IFNoaW55IG91dHB1dHMsIHdlIG9ubHkgd2FudCB0aGUgc3RhdGljIGtpbmQKICAgICAgICByZXR1cm4gZmlsdGVyQnlDbGFzcyhyZXN1bHRzLCAiaHRtbC13aWRnZXQtb3V0cHV0IiwgZmFsc2UpOwogICAgICB9OwogICAgfSk7CiAgICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0cy5wdXNoKHN0YXRpY0JpbmRpbmcpOwoKICAgIGlmIChzaGlueU1vZGUpIHsKICAgICAgLy8gU2hpbnkgaXMgcnVubmluZy4gUmVnaXN0ZXIgdGhlIGRlZmluaXRpb24gd2l0aCBhbiBvdXRwdXQgYmluZGluZy4KICAgICAgLy8gVGhlIGRlZmluaXRpb24gaXRzZWxmIHdpbGwgbm90IGJlIHRoZSBvdXRwdXQgYmluZGluZywgaW5zdGVhZAogICAgICAvLyB3ZSB3aWxsIG1ha2UgYW4gb3V0cHV0IGJpbmRpbmcgb2JqZWN0IHRoYXQgZGVsZWdhdGVzIHRvIHRoZQogICAgICAvLyBkZWZpbml0aW9uLiBUaGlzIGlzIGJlY2F1c2Ugd2UgZm9vbGlzaGx5IHVzZWQgdGhlIHNhbWUgbWV0aG9kCiAgICAgIC8vIG5hbWUgKHJlbmRlclZhbHVlKSBmb3IgaHRtbHdpZGdldHMgZGVmaW5pdGlvbiBhbmQgU2hpbnkgYmluZGluZ3MKICAgICAgLy8gYnV0IHRoZXkgYWN0dWFsbHkgaGF2ZSBxdWl0ZSBkaWZmZXJlbnQgc2VtYW50aWNzICh0aGUgU2hpbnkKICAgICAgLy8gYmluZGluZ3MgcmVjZWl2ZSBkYXRhIHRoYXQgaW5jbHVkZXMgbG90cyBvZiBtZXRhZGF0YSB0aGF0IGl0CiAgICAgIC8vIHN0cmlwcyBvZmYgYmVmb3JlIGNhbGxpbmcgaHRtbHdpZGdldHMgcmVuZGVyVmFsdWUpLiBXZSBjYW4ndAogICAgICAvLyBqdXN0IGlnbm9yZSB0aGUgZGlmZmVyZW5jZSBiZWNhdXNlIGluIHNvbWUgd2lkZ2V0cyBpdCdzIGhlbHBmdWwKICAgICAgLy8gdG8gY2FsbCB0aGlzLnJlbmRlclZhbHVlKCkgZnJvbSBpbnNpZGUgb2YgcmVzaXplKCksIGFuZCBpZgogICAgICAvLyB3ZSdyZSBub3QgZGVsZWdhdGluZywgdGhlbiB0aGF0IGNhbGwgd2lsbCBnbyB0byB0aGUgU2hpbnkKICAgICAgLy8gdmVyc2lvbiBpbnN0ZWFkIG9mIHRoZSBodG1sd2lkZ2V0cyB2ZXJzaW9uLgoKICAgICAgLy8gTWVyZ2UgZGVmYXVsdHMgd2l0aCBkZWZpbml0aW9uLCB3aXRob3V0IG11dGF0aW5nIGVpdGhlci4KICAgICAgdmFyIGJpbmRpbmdEZWYgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBkZWZpbml0aW9uKTsKCiAgICAgIC8vIFRoaXMgb2JqZWN0IHdpbGwgYmUgb3VyIGFjdHVhbCBTaGlueSBiaW5kaW5nLgogICAgICB2YXIgc2hpbnlCaW5kaW5nID0gbmV3IFNoaW55Lk91dHB1dEJpbmRpbmcoKTsKCiAgICAgIC8vIFdpdGggYSBmZXcgZXhjZXB0aW9ucywgd2UnbGwgd2FudCB0byBzaW1wbHkgdXNlIHRoZSBiaW5kaW5nRGVmJ3MKICAgICAgLy8gdmVyc2lvbiBvZiBtZXRob2RzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGZhbGwgYmFjayB0bwogICAgICAvLyBTaGlueSdzIGRlZmF1bHRzLiBOT1RFOiBJZiBTaGlueSdzIG91dHB1dCBiaW5kaW5ncyBnYWluIGFkZGl0aW9uYWwKICAgICAgLy8gbWV0aG9kcyBpbiB0aGUgZnV0dXJlLCBhbmQgd2Ugd2FudCB0aGVtIHRvIGJlIG92ZXJyaWRlYWJsZSBieQogICAgICAvLyBIVE1MV2lkZ2V0IGJpbmRpbmcgZGVmaW5pdGlvbnMsIHRoZW4gd2UnbGwgbmVlZCB0byBhZGQgdGhlbSB0byB0aGlzCiAgICAgIC8vIGxpc3QuCiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgImdldElkIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgIm9uVmFsdWVDaGFuZ2UiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAib25WYWx1ZUVycm9yIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgInJlbmRlckVycm9yIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgImNsZWFyRXJyb3IiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAic2hvd1Byb2dyZXNzIik7CgogICAgICAvLyBUaGUgZmluZCwgcmVuZGVyVmFsdWUsIGFuZCByZXNpemUgYXJlIGhhbmRsZWQgZGlmZmVyZW50bHksIGJlY2F1c2Ugd2UKICAgICAgLy8gd2FudCB0byBhY3R1YWxseSBkZWNvcmF0ZSB0aGUgYmVoYXZpb3Igb2YgdGhlIGJpbmRpbmdEZWYgbWV0aG9kcy4KCiAgICAgIHNoaW55QmluZGluZy5maW5kID0gZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IGJpbmRpbmdEZWYuZmluZChzY29wZSk7CgogICAgICAgIC8vIE9ubHkgcmV0dXJuIGVsZW1lbnRzIHRoYXQgYXJlIFNoaW55IG91dHB1dHMsIG5vdCBzdGF0aWMgb25lcwogICAgICAgIHZhciBkeW5hbWljUmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKCIuaHRtbC13aWRnZXQtb3V0cHV0Iik7CgogICAgICAgIC8vIEl0J3MgcG9zc2libGUgdGhhdCB3aGF0ZXZlciBjYXVzZWQgU2hpbnkgdG8gdGhpbmsgdGhlcmUgbWlnaHQgYmUKICAgICAgICAvLyBuZXcgZHluYW1pYyBvdXRwdXRzLCBhbHNvIGNhdXNlZCB0aGVyZSB0byBiZSBuZXcgc3RhdGljIG91dHB1dHMuCiAgICAgICAgLy8gU2luY2UgdGhlcmUgbWlnaHQgYmUgbG90cyBvZiBkaWZmZXJlbnQgaHRtbHdpZGdldHMgYmluZGluZ3MsIHdlCiAgICAgICAgLy8gc2NoZWR1bGUgZXhlY3V0aW9uIGZvciBsYXRlci0tbm8gbmVlZCB0byBzdGF0aWNSZW5kZXIgbXVsdGlwbGUKICAgICAgICAvLyB0aW1lcy4KICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggIT09IGR5bmFtaWNSZXN1bHRzLmxlbmd0aCkKICAgICAgICAgIHNjaGVkdWxlU3RhdGljUmVuZGVyKCk7CgogICAgICAgIHJldHVybiBkeW5hbWljUmVzdWx0czsKICAgICAgfTsKCiAgICAgIC8vIFdyYXAgcmVuZGVyVmFsdWUgdG8gaGFuZGxlIGluaXRpYWxpemF0aW9uLCB3aGljaCB1bmZvcnR1bmF0ZWx5IGlzbid0CiAgICAgIC8vIHN1cHBvcnRlZCBuYXRpdmVseSBieSBTaGlueSBhdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcuCgogICAgICBzaGlueUJpbmRpbmcucmVuZGVyVmFsdWUgPSBmdW5jdGlvbihlbCwgZGF0YSkgewogICAgICAgIC8vIFJlc29sdmUgc3RyaW5ncyBtYXJrZWQgYXMgamF2YXNjcmlwdCBsaXRlcmFscyB0byBvYmplY3RzCiAgICAgICAgaWYgKCEoZGF0YS5ldmFscyBpbnN0YW5jZW9mIEFycmF5KSkgZGF0YS5ldmFscyA9IFtkYXRhLmV2YWxzXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgZGF0YS5ldmFscyAmJiBpIDwgZGF0YS5ldmFscy5sZW5ndGg7IGkrKykgewogICAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLmV2YWx1YXRlU3RyaW5nTWVtYmVyKGRhdGEueCwgZGF0YS5ldmFsc1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmICghYmluZGluZ0RlZi5yZW5kZXJPbk51bGxWYWx1ZSkgewogICAgICAgICAgaWYgKGRhdGEueCA9PT0gbnVsbCkgewogICAgICAgICAgICBlbC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaW5oZXJpdCI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZWxlbWVudERhdGEoZWwsICJpbml0aWFsaXplZCIpKSB7CiAgICAgICAgICBpbml0U2l6aW5nKGVsKTsKCiAgICAgICAgICBlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIiwgdHJ1ZSk7CiAgICAgICAgICBpZiAoYmluZGluZ0RlZi5pbml0aWFsaXplKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBiaW5kaW5nRGVmLmluaXRpYWxpemUoZWwsIGVsLm9mZnNldFdpZHRoLAogICAgICAgICAgICAgIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgICAgIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBTaGlueS5yZW5kZXJEZXBlbmRlbmNpZXMoZGF0YS5kZXBzKTsKICAgICAgICBiaW5kaW5nRGVmLnJlbmRlclZhbHVlKGVsLCBkYXRhLngsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSk7CiAgICAgICAgZXZhbEFuZFJ1bihkYXRhLmpzSG9va3MucmVuZGVyLCBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0IiksIFtlbCwgZGF0YS54XSk7CiAgICAgIH07CgogICAgICAvLyBPbmx5IG92ZXJyaWRlIHJlc2l6ZSBpZiBiaW5kaW5nRGVmIGltcGxlbWVudHMgaXQKICAgICAgaWYgKGJpbmRpbmdEZWYucmVzaXplKSB7CiAgICAgICAgc2hpbnlCaW5kaW5nLnJlc2l6ZSA9IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAvLyBTaGlueSBjYW4gY2FsbCByZXNpemUgYmVmb3JlIGluaXRpYWxpemUvcmVuZGVyVmFsdWUgaGF2ZSBiZWVuCiAgICAgICAgICAvLyBjYWxsZWQsIHdoaWNoIGRvZXNuJ3QgbWFrZSBzZW5zZSBmb3Igd2lkZ2V0cy4KICAgICAgICAgIGlmIChlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIikpIHsKICAgICAgICAgICAgYmluZGluZ0RlZi5yZXNpemUoZWwsIHdpZHRoLCBoZWlnaHQsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgU2hpbnkub3V0cHV0QmluZGluZ3MucmVnaXN0ZXIoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLm5hbWUpOwogICAgfQogIH07CgogIHZhciBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBudWxsOwogIGZ1bmN0aW9uIHNjaGVkdWxlU3RhdGljUmVuZGVyKCkgewogICAgaWYgKCFzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQpIHsKICAgICAgc2NoZWR1bGVTdGF0aWNSZW5kZXJUaW1lcklkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBudWxsOwogICAgICAgIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIoKTsKICAgICAgfSwgMSk7CiAgICB9CiAgfQoKICAvLyBSZW5kZXIgc3RhdGljIHdpZGdldHMgYWZ0ZXIgdGhlIGRvY3VtZW50IGZpbmlzaGVzIGxvYWRpbmcKICAvLyBTdGF0aWNhbGx5IHJlbmRlciBhbGwgZWxlbWVudHMgdGhhdCBhcmUgb2YgdGhpcyB3aWRnZXQncyBjbGFzcwogIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBiaW5kaW5ncyA9IHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzIHx8IFtdOwogICAgZm9yRWFjaChiaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZykgewogICAgICB2YXIgbWF0Y2hlcyA9IGJpbmRpbmcuZmluZChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwogICAgICBmb3JFYWNoKG1hdGNoZXMsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyIHNpemVPYmogPSBpbml0U2l6aW5nKGVsLCBiaW5kaW5nKTsKCiAgICAgICAgaWYgKGhhc0NsYXNzKGVsLCAiaHRtbC13aWRnZXQtc3RhdGljLWJvdW5kIikpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lICsgIiBodG1sLXdpZGdldC1zdGF0aWMtYm91bmQiOwoKICAgICAgICB2YXIgaW5pdFJlc3VsdDsKICAgICAgICBpZiAoYmluZGluZy5pbml0aWFsaXplKSB7CiAgICAgICAgICBpbml0UmVzdWx0ID0gYmluZGluZy5pbml0aWFsaXplKGVsLAogICAgICAgICAgICBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgIHNpemVPYmogPyBzaXplT2JqLmdldEhlaWdodCgpIDogZWwub2Zmc2V0SGVpZ2h0CiAgICAgICAgICApOwogICAgICAgICAgZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIsIGluaXRSZXN1bHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJpbmRpbmcucmVzaXplKSB7CiAgICAgICAgICB2YXIgbGFzdFNpemUgPSB7fTsKICAgICAgICAgIHZhciByZXNpemVIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgc2l6ZSA9IHsKICAgICAgICAgICAgICB3OiBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgaDogc2l6ZU9iaiA/IHNpemVPYmouZ2V0SGVpZ2h0KCkgOiBlbC5vZmZzZXRIZWlnaHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHNpemUudyA9PT0gMCAmJiBzaXplLmggPT09IDApCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoc2l6ZS53ID09PSBsYXN0U2l6ZS53ICYmIHNpemUuaCA9PT0gbGFzdFNpemUuaCkKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGxhc3RTaXplID0gc2l6ZTsKICAgICAgICAgICAgYmluZGluZy5yZXNpemUoZWwsIHNpemUudywgc2l6ZS5oLCBpbml0UmVzdWx0KTsKICAgICAgICAgIH07CgogICAgICAgICAgb24od2luZG93LCAicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CgogICAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgZm9yIGNhc2VzIHdoZXJlIHdlJ3JlIHJ1bm5pbmcgaW4gYSBTaGlueQogICAgICAgICAgLy8gYXBwLCBidXQgdGhlIHdpZGdldCBpdHNlbGYgaXMgbm90IGEgU2hpbnkgb3V0cHV0LCBidXQKICAgICAgICAgIC8vIHJhdGhlciBhIHNpbXBsZSBzdGF0aWMgd2lkZ2V0LiBPbmUgZXhhbXBsZSBvZiB0aGlzIGlzCiAgICAgICAgICAvLyBhbiBybWFya2Rvd24gZG9jdW1lbnQgdGhhdCBoYXMgcnVudGltZTpzaGlueSBhbmQgd2lkZ2V0CiAgICAgICAgICAvLyB0aGF0IGlzbid0IGluIGEgcmVuZGVyIGZ1bmN0aW9uLiBTaGlueSBvbmx5IGtub3dzIHRvCiAgICAgICAgICAvLyBjYWxsIHJlc2l6ZSBoYW5kbGVycyBmb3IgU2hpbnkgb3V0cHV0cywgbm90IGZvciBzdGF0aWMKICAgICAgICAgIC8vIHdpZGdldHMsIHNvIHdlIGRvIGl0IG91cnNlbHZlcy4KICAgICAgICAgIGlmICh3aW5kb3cualF1ZXJ5KSB7CiAgICAgICAgICAgIHdpbmRvdy5qUXVlcnkoZG9jdW1lbnQpLm9uKAogICAgICAgICAgICAgICJzaG93bi5odG1sd2lkZ2V0cyBzaG93bi5icy50YWIuaHRtbHdpZGdldHMgc2hvd24uYnMuY29sbGFwc2UuaHRtbHdpZGdldHMiLAogICAgICAgICAgICAgIHJlc2l6ZUhhbmRsZXIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgd2luZG93LmpRdWVyeShkb2N1bWVudCkub24oCiAgICAgICAgICAgICAgImhpZGRlbi5odG1sd2lkZ2V0cyBoaWRkZW4uYnMudGFiLmh0bWx3aWRnZXRzIGhpZGRlbi5icy5jb2xsYXBzZS5odG1sd2lkZ2V0cyIsCiAgICAgICAgICAgICAgcmVzaXplSGFuZGxlcgogICAgICAgICAgICApOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGZvciB0aGUgc3BlY2lmaWMgY2FzZSBvZiBpb3NsaWRlcywgd2hpY2gKICAgICAgICAgIC8vIGZsaXBzIHNsaWRlcyBiZXR3ZWVuIGRpc3BsYXk6bm9uZSBhbmQgZGlzcGxheTpibG9jay4KICAgICAgICAgIC8vIElkZWFsbHkgd2Ugd291bGQgbm90IGhhdmUgdG8gaGF2ZSBpb3NsaWRlLXNwZWNpZmljIGNvZGUKICAgICAgICAgIC8vIGhlcmUsIGJ1dCByYXRoZXIgaGF2ZSBpb3NsaWRlcyByYWlzZSBhIGdlbmVyaWMgZXZlbnQsCiAgICAgICAgICAvLyBidXQgdGhlIHJtYXJrZG93biBwYWNrYWdlIGp1c3Qgd2VudCB0byBDUkFOIHNvIHRoZQogICAgICAgICAgLy8gd2luZG93IHRvIGdldHRpbmcgdGhhdCBmaXhlZCBtYXkgYmUgbG9uZy4KICAgICAgICAgIGlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAvLyBJdCdzIE9LIHRvIGxpbWl0IHRoaXMgdG8gd2luZG93LmFkZEV2ZW50TGlzdGVuZXIKICAgICAgICAgICAgLy8gYnJvd3NlcnMgYmVjYXVzZSBpb3NsaWRlcyBpdHNlbGYgb25seSBzdXBwb3J0cwogICAgICAgICAgICAvLyBzdWNoIGJyb3dzZXJzLgogICAgICAgICAgICBvbihkb2N1bWVudCwgInNsaWRlZW50ZXIiLCByZXNpemVIYW5kbGVyKTsKICAgICAgICAgICAgb24oZG9jdW1lbnQsICJzbGlkZWxlYXZlIiwgcmVzaXplSGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgc2NyaXB0RGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoInNjcmlwdFtkYXRhLWZvcj0nIiArIGVsLmlkICsgIiddW3R5cGU9J2FwcGxpY2F0aW9uL2pzb24nXSIpOwogICAgICAgIGlmIChzY3JpcHREYXRhKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0RGF0YS50ZXh0Q29udGVudCB8fCBzY3JpcHREYXRhLnRleHQpOwogICAgICAgICAgLy8gUmVzb2x2ZSBzdHJpbmdzIG1hcmtlZCBhcyBqYXZhc2NyaXB0IGxpdGVyYWxzIHRvIG9iamVjdHMKICAgICAgICAgIGlmICghKGRhdGEuZXZhbHMgaW5zdGFuY2VvZiBBcnJheSkpIGRhdGEuZXZhbHMgPSBbZGF0YS5ldmFsc107CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgZGF0YS5ldmFscyAmJiBrIDwgZGF0YS5ldmFscy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICB3aW5kb3cuSFRNTFdpZGdldHMuZXZhbHVhdGVTdHJpbmdNZW1iZXIoZGF0YS54LCBkYXRhLmV2YWxzW2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIGJpbmRpbmcucmVuZGVyVmFsdWUoZWwsIGRhdGEueCwgaW5pdFJlc3VsdCk7CiAgICAgICAgICBldmFsQW5kUnVuKGRhdGEuanNIb29rcy5yZW5kZXIsIGluaXRSZXN1bHQsIFtlbCwgZGF0YS54XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIGludm9rZVBvc3RSZW5kZXJIYW5kbGVycygpOwogIH0KCiAgLy8gV2FpdCB1bnRpbCBhZnRlciB0aGUgZG9jdW1lbnQgaGFzIGxvYWRlZCB0byByZW5kZXIgdGhlIHdpZGdldHMuCiAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBmdW5jdGlvbigpIHsKICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGFyZ3VtZW50cy5jYWxsZWUsIGZhbHNlKTsKICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgfSwgZmFsc2UpOwogIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgIGRvY3VtZW50LmF0dGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgICB9CiAgICB9KTsKICB9CgoKICB3aW5kb3cuSFRNTFdpZGdldHMuZ2V0QXR0YWNobWVudFVybCA9IGZ1bmN0aW9uKGRlcG5hbWUsIGtleSkgewogICAgLy8gSWYgbm8ga2V5LCBkZWZhdWx0IHRvIHRoZSBmaXJzdCBpdGVtCiAgICBpZiAodHlwZW9mKGtleSkgPT09ICJ1bmRlZmluZWQiKQogICAgICBrZXkgPSAxOwoKICAgIHZhciBsaW5rID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGVwbmFtZSArICItIiArIGtleSArICItYXR0YWNobWVudCIpOwogICAgaWYgKCFsaW5rKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQXR0YWNobWVudCAiICsgZGVwbmFtZSArICIvIiArIGtleSArICIgbm90IGZvdW5kIGluIGRvY3VtZW50Iik7CiAgICB9CiAgICByZXR1cm4gbGluay5nZXRBdHRyaWJ1dGUoImhyZWYiKTsKICB9OwoKICB3aW5kb3cuSFRNTFdpZGdldHMuZGF0YWZyYW1lVG9EMyA9IGZ1bmN0aW9uKGRmKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIHZhciBsZW5ndGg7CiAgICBmb3IgKHZhciBuYW1lIGluIGRmKSB7CiAgICAgICAgaWYgKGRmLmhhc093blByb3BlcnR5KG5hbWUpKQogICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgIGlmICh0eXBlb2YoZGZbbmFtZV0pICE9PSAib2JqZWN0IiB8fCB0eXBlb2YoZGZbbmFtZV0ubGVuZ3RoKSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbGwgZmllbGRzIG11c3QgYmUgYXJyYXlzIik7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YobGVuZ3RoKSAhPT0gInVuZGVmaW5lZCIgJiYgbGVuZ3RoICE9PSBkZltuYW1lXS5sZW5ndGgpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbGwgZmllbGRzIG11c3QgYmUgYXJyYXlzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBkZltuYW1lXS5sZW5ndGg7CiAgICB9CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIGl0ZW07CiAgICBmb3IgKHZhciByb3cgPSAwOyByb3cgPCBsZW5ndGg7IHJvdysrKSB7CiAgICAgICAgaXRlbSA9IHt9OwogICAgICAgIGZvciAodmFyIGNvbCA9IDA7IGNvbCA8IG5hbWVzLmxlbmd0aDsgY29sKyspIHsKICAgICAgICAgICAgaXRlbVtuYW1lc1tjb2xdXSA9IGRmW25hbWVzW2NvbF1dW3Jvd107CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMucHVzaChpdGVtKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHdpbmRvdy5IVE1MV2lkZ2V0cy50cmFuc3Bvc2VBcnJheTJEID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gMCkgcmV0dXJuIGFycmF5OwogICAgICB2YXIgbmV3QXJyYXkgPSBhcnJheVswXS5tYXAoZnVuY3Rpb24oY29sLCBpKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkubWFwKGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgICAgIHJldHVybiByb3dbaV0KICAgICAgICAgIH0pCiAgICAgIH0pOwogICAgICByZXR1cm4gbmV3QXJyYXk7CiAgfTsKICAvLyBTcGxpdCB2YWx1ZSBhdCBzcGxpdENoYXIsIGJ1dCBhbGxvdyBzcGxpdENoYXIgdG8gYmUgZXNjYXBlZAogIC8vIHVzaW5nIGVzY2FwZUNoYXIuIEFueSBvdGhlciBjaGFyYWN0ZXJzIGVzY2FwZWQgYnkgZXNjYXBlQ2hhcgogIC8vIHdpbGwgYmUgaW5jbHVkZWQgYXMgdXN1YWwgKGluY2x1ZGluZyBlc2NhcGVDaGFyIGl0c2VsZikuCiAgZnVuY3Rpb24gc3BsaXRXaXRoRXNjYXBlKHZhbHVlLCBzcGxpdENoYXIsIGVzY2FwZUNoYXIpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICB2YXIgZXNjYXBlTW9kZSA9IGZhbHNlOwogICAgdmFyIGN1cnJlbnRSZXN1bHQgPSAiIjsKICAgIGZvciAodmFyIHBvcyA9IDA7IHBvcyA8IHZhbHVlLmxlbmd0aDsgcG9zKyspIHsKICAgICAgaWYgKCFlc2NhcGVNb2RlKSB7CiAgICAgICAgaWYgKHZhbHVlW3Bvc10gPT09IHNwbGl0Q2hhcikgewogICAgICAgICAgcmVzdWx0cy5wdXNoKGN1cnJlbnRSZXN1bHQpOwogICAgICAgICAgY3VycmVudFJlc3VsdCA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWVbcG9zXSA9PT0gZXNjYXBlQ2hhcikgewogICAgICAgICAgZXNjYXBlTW9kZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRSZXN1bHQgKz0gdmFsdWVbcG9zXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VycmVudFJlc3VsdCArPSB2YWx1ZVtwb3NdOwogICAgICAgIGVzY2FwZU1vZGUgPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGN1cnJlbnRSZXN1bHQgIT09ICIiKSB7CiAgICAgIHJlc3VsdHMucHVzaChjdXJyZW50UmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBGdW5jdGlvbiBhdXRob3JlZCBieSBZaWh1aS9KSiBBbGxhaXJlCiAgd2luZG93LkhUTUxXaWRnZXRzLmV2YWx1YXRlU3RyaW5nTWVtYmVyID0gZnVuY3Rpb24obywgbWVtYmVyKSB7CiAgICB2YXIgcGFydHMgPSBzcGxpdFdpdGhFc2NhcGUobWVtYmVyLCAnLicsICdcXCcpOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKICAgICAgLy8gcGFydCBtYXkgYmUgYSBjaGFyYWN0ZXIgb3IgJ251bWVyaWMnIG1lbWJlciBuYW1lCiAgICAgIGlmIChvICE9PSBudWxsICYmIHR5cGVvZiBvID09PSAib2JqZWN0IiAmJiBwYXJ0IGluIG8pIHsKICAgICAgICBpZiAoaSA9PSAobCAtIDEpKSB7IC8vIGlmIHdlIGFyZSBhdCB0aGUgZW5kIG9mIHRoZSBsaW5lIHRoZW4gZXZhbHVsYXRlCiAgICAgICAgICBpZiAodHlwZW9mIG9bcGFydF0gPT09ICJzdHJpbmciKQogICAgICAgICAgICBvW3BhcnRdID0gZXZhbCgiKCIgKyBvW3BhcnRdICsgIikiKTsKICAgICAgICB9IGVsc2UgeyAvLyBvdGhlcndpc2UgY29udGludWUgdG8gbmV4dCBlbWJlZGRlZCBvYmplY3QKICAgICAgICAgIG8gPSBvW3BhcnRdOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIC8vIFJldHJpZXZlIHRoZSBIVE1MV2lkZ2V0IGluc3RhbmNlIChpLmUuIHRoZSByZXR1cm4gdmFsdWUgb2YgYW4KICAvLyBIVE1MV2lkZ2V0IGJpbmRpbmcncyBpbml0aWFsaXplKCkgb3IgZmFjdG9yeSgpIGZ1bmN0aW9uKQogIC8vIGFzc29jaWF0ZWQgd2l0aCBhbiBlbGVtZW50LCBvciBudWxsIGlmIG5vbmUuCiAgd2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlID0gZnVuY3Rpb24oZWwpIHsKICAgIHJldHVybiBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0Iik7CiAgfTsKCiAgLy8gRmluZHMgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIHNjb3BlIHRoYXQgbWF0Y2hlcyB0aGUgc2VsZWN0b3IsCiAgLy8gYW5kIHJldHVybnMgdGhlIEhUTUxXaWRnZXQgaW5zdGFuY2UgKGkuZS4gdGhlIHJldHVybiB2YWx1ZSBvZgogIC8vIGFuIEhUTUxXaWRnZXQgYmluZGluZydzIGluaXRpYWxpemUoKSBvciBmYWN0b3J5KCkgZnVuY3Rpb24pCiAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoYXQgZWxlbWVudCwgaWYgYW55LiBJZiBubyBlbGVtZW50IG1hdGNoZXMgdGhlCiAgLy8gc2VsZWN0b3IsIG9yIHRoZSBmaXJzdCBtYXRjaGluZyBlbGVtZW50IGhhcyBubyBIVE1MV2lkZ2V0CiAgLy8gaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIGl0LCB0aGVuIG51bGwgaXMgcmV0dXJuZWQuCiAgLy8KICAvLyBUaGUgc2NvcGUgYXJndW1lbnQgaXMgb3B0aW9uYWwsIGFuZCBkZWZhdWx0cyB0byB3aW5kb3cuZG9jdW1lbnQuCiAgd2luZG93LkhUTUxXaWRnZXRzLmZpbmQgPSBmdW5jdGlvbihzY29wZSwgc2VsZWN0b3IpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgc2VsZWN0b3IgPSBzY29wZTsKICAgICAgc2NvcGUgPSBkb2N1bWVudDsKICAgIH0KCiAgICB2YXIgZWwgPSBzY29wZS5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgIGlmIChlbCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB3aW5kb3cuSFRNTFdpZGdldHMuZ2V0SW5zdGFuY2UoZWwpOwogICAgfQogIH07CgogIC8vIEZpbmRzIGFsbCBlbGVtZW50cyBpbiB0aGUgc2NvcGUgdGhhdCBtYXRjaCB0aGUgc2VsZWN0b3IsIGFuZAogIC8vIHJldHVybnMgdGhlIEhUTUxXaWRnZXQgaW5zdGFuY2VzIChpLmUuIHRoZSByZXR1cm4gdmFsdWVzIG9mCiAgLy8gYW4gSFRNTFdpZGdldCBiaW5kaW5nJ3MgaW5pdGlhbGl6ZSgpIG9yIGZhY3RvcnkoKSBmdW5jdGlvbikKICAvLyBhc3NvY2lhdGVkIHdpdGggdGhlIGVsZW1lbnRzLCBpbiBhbiBhcnJheS4gSWYgZWxlbWVudHMgdGhhdAogIC8vIG1hdGNoIHRoZSBzZWxlY3RvciBkb24ndCBoYXZlIGFuIGFzc29jaWF0ZWQgSFRNTFdpZGdldAogIC8vIGluc3RhbmNlLCB0aGUgcmV0dXJuZWQgYXJyYXkgd2lsbCBjb250YWluIG51bGxzLgogIC8vCiAgLy8gVGhlIHNjb3BlIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBhbmQgZGVmYXVsdHMgdG8gd2luZG93LmRvY3VtZW50LgogIHdpbmRvdy5IVE1MV2lkZ2V0cy5maW5kQWxsID0gZnVuY3Rpb24oc2NvcGUsIHNlbGVjdG9yKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgIHNlbGVjdG9yID0gc2NvcGU7CiAgICAgIHNjb3BlID0gZG9jdW1lbnQ7CiAgICB9CgogICAgdmFyIG5vZGVzID0gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzLnB1c2god2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlKG5vZGVzW2ldKSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB2YXIgcG9zdFJlbmRlckhhbmRsZXJzID0gW107CiAgZnVuY3Rpb24gaW52b2tlUG9zdFJlbmRlckhhbmRsZXJzKCkgewogICAgd2hpbGUgKHBvc3RSZW5kZXJIYW5kbGVycy5sZW5ndGgpIHsKICAgICAgdmFyIGhhbmRsZXIgPSBwb3N0UmVuZGVySGFuZGxlcnMuc2hpZnQoKTsKICAgICAgaWYgKGhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVyKCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFJlZ2lzdGVyIHRoZSBnaXZlbiBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBpbnZva2VkIGFmdGVyIHRoZQogIC8vIG5leHQgdGltZSBzdGF0aWMgd2lkZ2V0cyBhcmUgcmVuZGVyZWQuCiAgd2luZG93LkhUTUxXaWRnZXRzLmFkZFBvc3RSZW5kZXJIYW5kbGVyID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIHBvc3RSZW5kZXJIYW5kbGVycy5wdXNoKGNhbGxiYWNrKTsKICB9OwoKICAvLyBUYWtlcyBhIG5ldy1zdHlsZSBpbnN0YW5jZS1ib3VuZCBkZWZpbml0aW9uLCBhbmQgcmV0dXJucyBhbgogIC8vIG9sZC1zdHlsZSBjbGFzcy1ib3VuZCBkZWZpbml0aW9uLiBUaGlzIHNhdmVzIHVzIGZyb20gaGF2aW5nCiAgLy8gdG8gcmV3cml0ZSBhbGwgdGhlIGxvZ2ljIGluIHRoaXMgZmlsZSB0byBhY2NvbW9kYXRlIGJvdGgKICAvLyB0eXBlcyBvZiBkZWZpbml0aW9ucy4KICBmdW5jdGlvbiBjcmVhdGVMZWdhY3lEZWZpbml0aW9uQWRhcHRlcihkZWZuKSB7CiAgICB2YXIgcmVzdWx0ID0gewogICAgICBuYW1lOiBkZWZuLm5hbWUsCiAgICAgIHR5cGU6IGRlZm4udHlwZSwKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICByZXR1cm4gZGVmbi5mYWN0b3J5KGVsLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgfSwKICAgICAgcmVuZGVyVmFsdWU6IGZ1bmN0aW9uKGVsLCB4LCBpbnN0YW5jZSkgewogICAgICAgIHJldHVybiBpbnN0YW5jZS5yZW5kZXJWYWx1ZSh4KTsKICAgICAgfSwKICAgICAgcmVzaXplOiBmdW5jdGlvbihlbCwgd2lkdGgsIGhlaWdodCwgaW5zdGFuY2UpIHsKICAgICAgICByZXR1cm4gaW5zdGFuY2UucmVzaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICB9CiAgICB9OwoKICAgIGlmIChkZWZuLmZpbmQpCiAgICAgIHJlc3VsdC5maW5kID0gZGVmbi5maW5kOwogICAgaWYgKGRlZm4ucmVuZGVyRXJyb3IpCiAgICAgIHJlc3VsdC5yZW5kZXJFcnJvciA9IGRlZm4ucmVuZGVyRXJyb3I7CiAgICBpZiAoZGVmbi5jbGVhckVycm9yKQogICAgICByZXN1bHQuY2xlYXJFcnJvciA9IGRlZm4uY2xlYXJFcnJvcjsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KfSkoKTsKCg=="></script>
<script src="data:application/x-javascript;base64,LyohCiAqIENoYXJ0LmpzCiAqIGh0dHA6Ly9jaGFydGpzLm9yZy8KICogVmVyc2lvbjogMS4wLjIKICoKICogQ29weXJpZ2h0IDIwMTUgTmljayBEb3duaWUKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9ubm5pY2svQ2hhcnQuanMvYmxvYi9tYXN0ZXIvTElDRU5TRS5tZAogKi8KCgooZnVuY3Rpb24oKXsKCgkidXNlIHN0cmljdCI7CgoJLy9EZWNsYXJlIHJvb3QgdmFyaWFibGUgLSB3aW5kb3cgaW4gdGhlIGJyb3dzZXIsIGdsb2JhbCBvbiB0aGUgc2VydmVyCgl2YXIgcm9vdCA9IHRoaXMsCgkJcHJldmlvdXMgPSByb290LkNoYXJ0OwoKCS8vT2NjdXB5IHRoZSBnbG9iYWwgdmFyaWFibGUgb2YgQ2hhcnQsIGFuZCBjcmVhdGUgYSBzaW1wbGUgYmFzZSBjbGFzcwoJdmFyIENoYXJ0ID0gZnVuY3Rpb24oY29udGV4dCl7CgkJdmFyIGNoYXJ0ID0gdGhpczsKCQl0aGlzLmNhbnZhcyA9IGNvbnRleHQuY2FudmFzOwoKCQl0aGlzLmN0eCA9IGNvbnRleHQ7CgoJCS8vVmFyaWFibGVzIGdsb2JhbCB0byB0aGUgY2hhcnQKCQl2YXIgY29tcHV0ZURpbWVuc2lvbiA9IGZ1bmN0aW9uKGVsZW1lbnQsZGltZW5zaW9uKQoJCXsKCQkJaWYgKGVsZW1lbnRbJ29mZnNldCcrZGltZW5zaW9uXSkKCQkJewoJCQkJcmV0dXJuIGVsZW1lbnRbJ29mZnNldCcrZGltZW5zaW9uXTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXJldHVybiBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpLmdldFByb3BlcnR5VmFsdWUoZGltZW5zaW9uKTsKCQkJfQoJCX0KCgkJdmFyIHdpZHRoID0gdGhpcy53aWR0aCA9IGNvbXB1dGVEaW1lbnNpb24oY29udGV4dC5jYW52YXMsJ1dpZHRoJyk7CgkJdmFyIGhlaWdodCA9IHRoaXMuaGVpZ2h0ID0gY29tcHV0ZURpbWVuc2lvbihjb250ZXh0LmNhbnZhcywnSGVpZ2h0Jyk7CgoJCS8vIEZpcmVmb3ggcmVxdWlyZXMgdGhpcyB0byB3b3JrIGNvcnJlY3RseQoJCWNvbnRleHQuY2FudmFzLndpZHRoICA9IHdpZHRoOwoJCWNvbnRleHQuY2FudmFzLmhlaWdodCA9IGhlaWdodDsKCgkJdmFyIHdpZHRoID0gdGhpcy53aWR0aCA9IGNvbnRleHQuY2FudmFzLndpZHRoOwoJCXZhciBoZWlnaHQgPSB0aGlzLmhlaWdodCA9IGNvbnRleHQuY2FudmFzLmhlaWdodDsKCQl0aGlzLmFzcGVjdFJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwoJCS8vSGlnaCBwaXhlbCBkZW5zaXR5IGRpc3BsYXlzIC0gbXVsdGlwbHkgdGhlIHNpemUgb2YgdGhlIGNhbnZhcyBoZWlnaHQvd2lkdGggYnkgdGhlIGRldmljZSBwaXhlbCByYXRpbywgdGhlbiBzY2FsZS4KCQloZWxwZXJzLnJldGluYVNjYWxlKHRoaXMpOwoKCQlyZXR1cm4gdGhpczsKCX07CgkvL0dsb2JhbGx5IGV4cG9zZSB0aGUgZGVmYXVsdHMgdG8gYWxsb3cgZm9yIHVzZXIgdXBkYXRpbmcvY2hhbmdpbmcKCUNoYXJ0LmRlZmF1bHRzID0gewoJCWdsb2JhbDogewoJCQkvLyBCb29sZWFuIC0gV2hldGhlciB0byBhbmltYXRlIHRoZSBjaGFydAoJCQlhbmltYXRpb246IHRydWUsCgoJCQkvLyBOdW1iZXIgLSBOdW1iZXIgb2YgYW5pbWF0aW9uIHN0ZXBzCgkJCWFuaW1hdGlvblN0ZXBzOiA2MCwKCgkJCS8vIFN0cmluZyAtIEFuaW1hdGlvbiBlYXNpbmcgZWZmZWN0CgkJCWFuaW1hdGlvbkVhc2luZzogImVhc2VPdXRRdWFydCIsCgoJCQkvLyBCb29sZWFuIC0gSWYgd2Ugc2hvdWxkIHNob3cgdGhlIHNjYWxlIGF0IGFsbAoJCQlzaG93U2NhbGU6IHRydWUsCgoJCQkvLyBCb29sZWFuIC0gSWYgd2Ugd2FudCB0byBvdmVycmlkZSB3aXRoIGEgaGFyZCBjb2RlZCBzY2FsZQoJCQlzY2FsZU92ZXJyaWRlOiBmYWxzZSwKCgkJCS8vICoqIFJlcXVpcmVkIGlmIHNjYWxlT3ZlcnJpZGUgaXMgdHJ1ZSAqKgoJCQkvLyBOdW1iZXIgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIGluIGEgaGFyZCBjb2RlZCBzY2FsZQoJCQlzY2FsZVN0ZXBzOiBudWxsLAoJCQkvLyBOdW1iZXIgLSBUaGUgdmFsdWUganVtcCBpbiB0aGUgaGFyZCBjb2RlZCBzY2FsZQoJCQlzY2FsZVN0ZXBXaWR0aDogbnVsbCwKCQkJLy8gTnVtYmVyIC0gVGhlIHNjYWxlIHN0YXJ0aW5nIHZhbHVlCgkJCXNjYWxlU3RhcnRWYWx1ZTogbnVsbCwKCgkJCS8vIFN0cmluZyAtIENvbG91ciBvZiB0aGUgc2NhbGUgbGluZQoJCQlzY2FsZUxpbmVDb2xvcjogInJnYmEoMCwwLDAsLjEpIiwKCgkJCS8vIE51bWJlciAtIFBpeGVsIHdpZHRoIG9mIHRoZSBzY2FsZSBsaW5lCgkJCXNjYWxlTGluZVdpZHRoOiAxLAoKCQkJLy8gQm9vbGVhbiAtIFdoZXRoZXIgdG8gc2hvdyBsYWJlbHMgb24gdGhlIHNjYWxlCgkJCXNjYWxlU2hvd0xhYmVsczogdHJ1ZSwKCgkJCS8vIEludGVycG9sYXRlZCBKUyBzdHJpbmcgLSBjYW4gYWNjZXNzIHZhbHVlCgkJCXNjYWxlTGFiZWw6ICI8JT12YWx1ZSU+IiwKCgkJCS8vIEJvb2xlYW4gLSBXaGV0aGVyIHRoZSBzY2FsZSBzaG91bGQgc3RpY2sgdG8gaW50ZWdlcnMsIGFuZCBub3Qgc2hvdyBhbnkgZmxvYXRzIGV2ZW4gaWYgZHJhd2luZyBzcGFjZSBpcyB0aGVyZQoJCQlzY2FsZUludGVnZXJzT25seTogdHJ1ZSwKCgkJCS8vIEJvb2xlYW4gLSBXaGV0aGVyIHRoZSBzY2FsZSBzaG91bGQgc3RhcnQgYXQgemVybywgb3IgYW4gb3JkZXIgb2YgbWFnbml0dWRlIGRvd24gZnJvbSB0aGUgbG93ZXN0IHZhbHVlCgkJCXNjYWxlQmVnaW5BdFplcm86IGZhbHNlLAoKCQkJLy8gU3RyaW5nIC0gU2NhbGUgbGFiZWwgZm9udCBkZWNsYXJhdGlvbiBmb3IgdGhlIHNjYWxlIGxhYmVsCgkJCXNjYWxlRm9udEZhbWlseTogIidIZWx2ZXRpY2EgTmV1ZScsICdIZWx2ZXRpY2EnLCAnQXJpYWwnLCBzYW5zLXNlcmlmIiwKCgkJCS8vIE51bWJlciAtIFNjYWxlIGxhYmVsIGZvbnQgc2l6ZSBpbiBwaXhlbHMKCQkJc2NhbGVGb250U2l6ZTogMTIsCgoJCQkvLyBTdHJpbmcgLSBTY2FsZSBsYWJlbCBmb250IHdlaWdodCBzdHlsZQoJCQlzY2FsZUZvbnRTdHlsZTogIm5vcm1hbCIsCgoJCQkvLyBTdHJpbmcgLSBTY2FsZSBsYWJlbCBmb250IGNvbG91cgoJCQlzY2FsZUZvbnRDb2xvcjogIiM2NjYiLAoKCQkJLy8gQm9vbGVhbiAtIHdoZXRoZXIgb3Igbm90IHRoZSBjaGFydCBzaG91bGQgYmUgcmVzcG9uc2l2ZSBhbmQgcmVzaXplIHdoZW4gdGhlIGJyb3dzZXIgZG9lcy4KCQkJcmVzcG9uc2l2ZTogZmFsc2UsCgoJCQkvLyBCb29sZWFuIC0gd2hldGhlciB0byBtYWludGFpbiB0aGUgc3RhcnRpbmcgYXNwZWN0IHJhdGlvIG9yIG5vdCB3aGVuIHJlc3BvbnNpdmUsIGlmIHNldCB0byBmYWxzZSwgd2lsbCB0YWtlIHVwIGVudGlyZSBjb250YWluZXIKCQkJbWFpbnRhaW5Bc3BlY3RSYXRpbzogdHJ1ZSwKCgkJCS8vIEJvb2xlYW4gLSBEZXRlcm1pbmVzIHdoZXRoZXIgdG8gZHJhdyB0b29sdGlwcyBvbiB0aGUgY2FudmFzIG9yIG5vdCAtIGF0dGFjaGVzIGV2ZW50cyB0byB0b3VjaG1vdmUgJiBtb3VzZW1vdmUKCQkJc2hvd1Rvb2x0aXBzOiB0cnVlLAoKCQkJLy8gQm9vbGVhbiAtIERldGVybWluZXMgd2hldGhlciB0byBkcmF3IGJ1aWx0LWluIHRvb2x0aXAgb3IgY2FsbCBjdXN0b20gdG9vbHRpcCBmdW5jdGlvbgoJCQljdXN0b21Ub29sdGlwczogZmFsc2UsCgoJCQkvLyBBcnJheSAtIEFycmF5IG9mIHN0cmluZyBuYW1lcyB0byBhdHRhY2ggdG9vbHRpcCBldmVudHMKCQkJdG9vbHRpcEV2ZW50czogWyJtb3VzZW1vdmUiLCAidG91Y2hzdGFydCIsICJ0b3VjaG1vdmUiLCAibW91c2VvdXQiXSwKCgkJCS8vIFN0cmluZyAtIFRvb2x0aXAgYmFja2dyb3VuZCBjb2xvdXIKCQkJdG9vbHRpcEZpbGxDb2xvcjogInJnYmEoMCwwLDAsMC44KSIsCgoJCQkvLyBTdHJpbmcgLSBUb29sdGlwIGxhYmVsIGZvbnQgZGVjbGFyYXRpb24gZm9yIHRoZSBzY2FsZSBsYWJlbAoJCQl0b29sdGlwRm9udEZhbWlseTogIidIZWx2ZXRpY2EgTmV1ZScsICdIZWx2ZXRpY2EnLCAnQXJpYWwnLCBzYW5zLXNlcmlmIiwKCgkJCS8vIE51bWJlciAtIFRvb2x0aXAgbGFiZWwgZm9udCBzaXplIGluIHBpeGVscwoJCQl0b29sdGlwRm9udFNpemU6IDE0LAoKCQkJLy8gU3RyaW5nIC0gVG9vbHRpcCBmb250IHdlaWdodCBzdHlsZQoJCQl0b29sdGlwRm9udFN0eWxlOiAibm9ybWFsIiwKCgkJCS8vIFN0cmluZyAtIFRvb2x0aXAgbGFiZWwgZm9udCBjb2xvdXIKCQkJdG9vbHRpcEZvbnRDb2xvcjogIiNmZmYiLAoKCQkJLy8gU3RyaW5nIC0gVG9vbHRpcCB0aXRsZSBmb250IGRlY2xhcmF0aW9uIGZvciB0aGUgc2NhbGUgbGFiZWwKCQkJdG9vbHRpcFRpdGxlRm9udEZhbWlseTogIidIZWx2ZXRpY2EgTmV1ZScsICdIZWx2ZXRpY2EnLCAnQXJpYWwnLCBzYW5zLXNlcmlmIiwKCgkJCS8vIE51bWJlciAtIFRvb2x0aXAgdGl0bGUgZm9udCBzaXplIGluIHBpeGVscwoJCQl0b29sdGlwVGl0bGVGb250U2l6ZTogMTQsCgoJCQkvLyBTdHJpbmcgLSBUb29sdGlwIHRpdGxlIGZvbnQgd2VpZ2h0IHN0eWxlCgkJCXRvb2x0aXBUaXRsZUZvbnRTdHlsZTogImJvbGQiLAoKCQkJLy8gU3RyaW5nIC0gVG9vbHRpcCB0aXRsZSBmb250IGNvbG91cgoJCQl0b29sdGlwVGl0bGVGb250Q29sb3I6ICIjZmZmIiwKCgkJCS8vIE51bWJlciAtIHBpeGVsIHdpZHRoIG9mIHBhZGRpbmcgYXJvdW5kIHRvb2x0aXAgdGV4dAoJCQl0b29sdGlwWVBhZGRpbmc6IDYsCgoJCQkvLyBOdW1iZXIgLSBwaXhlbCB3aWR0aCBvZiBwYWRkaW5nIGFyb3VuZCB0b29sdGlwIHRleHQKCQkJdG9vbHRpcFhQYWRkaW5nOiA2LAoKCQkJLy8gTnVtYmVyIC0gU2l6ZSBvZiB0aGUgY2FyZXQgb24gdGhlIHRvb2x0aXAKCQkJdG9vbHRpcENhcmV0U2l6ZTogOCwKCgkJCS8vIE51bWJlciAtIFBpeGVsIHJhZGl1cyBvZiB0aGUgdG9vbHRpcCBib3JkZXIKCQkJdG9vbHRpcENvcm5lclJhZGl1czogNiwKCgkJCS8vIE51bWJlciAtIFBpeGVsIG9mZnNldCBmcm9tIHBvaW50IHggdG8gdG9vbHRpcCBlZGdlCgkJCXRvb2x0aXBYT2Zmc2V0OiAxMCwKCgkJCS8vIFN0cmluZyAtIFRlbXBsYXRlIHN0cmluZyBmb3Igc2luZ2xlIHRvb2x0aXBzCgkJCXRvb2x0aXBUZW1wbGF0ZTogIjwlaWYgKGxhYmVsKXslPjwlPWxhYmVsJT46IDwlfSU+PCU9IHZhbHVlICU+IiwKCgkJCS8vIFN0cmluZyAtIFRlbXBsYXRlIHN0cmluZyBmb3Igc2luZ2xlIHRvb2x0aXBzCgkJCW11bHRpVG9vbHRpcFRlbXBsYXRlOiAiPCU9IHZhbHVlICU+IiwKCgkJCS8vIFN0cmluZyAtIENvbG91ciBiZWhpbmQgdGhlIGxlZ2VuZCBjb2xvdXIgYmxvY2sKCQkJbXVsdGlUb29sdGlwS2V5QmFja2dyb3VuZDogJyNmZmYnLAoKCQkJLy8gRnVuY3Rpb24gLSBXaWxsIGZpcmUgb24gYW5pbWF0aW9uIHByb2dyZXNzaW9uLgoJCQlvbkFuaW1hdGlvblByb2dyZXNzOiBmdW5jdGlvbigpe30sCgoJCQkvLyBGdW5jdGlvbiAtIFdpbGwgZmlyZSBvbiBhbmltYXRpb24gY29tcGxldGlvbi4KCQkJb25BbmltYXRpb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9CgoJCX0KCX07CgoJLy9DcmVhdGUgYSBkaWN0aW9uYXJ5IG9mIGNoYXJ0IHR5cGVzLCB0byBhbGxvdyBmb3IgZXh0ZW5zaW9uIG9mIGV4aXN0aW5nIHR5cGVzCglDaGFydC50eXBlcyA9IHt9OwoKCS8vR2xvYmFsIENoYXJ0IGhlbHBlcnMgb2JqZWN0IGZvciB1dGlsaXR5IG1ldGhvZHMgYW5kIGNsYXNzZXMKCXZhciBoZWxwZXJzID0gQ2hhcnQuaGVscGVycyA9IHt9OwoKCQkvLy0tIEJhc2ljIGpzIHV0aWxpdHkgbWV0aG9kcwoJdmFyIGVhY2ggPSBoZWxwZXJzLmVhY2ggPSBmdW5jdGlvbihsb29wYWJsZSxjYWxsYmFjayxzZWxmKXsKCQkJdmFyIGFkZGl0aW9uYWxBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIG51bGwgb3IgdW5kZWZpbmVkIGZpcnN0bHkuCgkJCWlmIChsb29wYWJsZSl7CgkJCQlpZiAobG9vcGFibGUubGVuZ3RoID09PSArbG9vcGFibGUubGVuZ3RoKXsKCQkJCQl2YXIgaTsKCQkJCQlmb3IgKGk9MDsgaTxsb29wYWJsZS5sZW5ndGg7IGkrKyl7CgkJCQkJCWNhbGxiYWNrLmFwcGx5KHNlbGYsW2xvb3BhYmxlW2ldLCBpXS5jb25jYXQoYWRkaXRpb25hbEFyZ3MpKTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlewoJCQkJCWZvciAodmFyIGl0ZW0gaW4gbG9vcGFibGUpewoJCQkJCQljYWxsYmFjay5hcHBseShzZWxmLFtsb29wYWJsZVtpdGVtXSxpdGVtXS5jb25jYXQoYWRkaXRpb25hbEFyZ3MpKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCWNsb25lID0gaGVscGVycy5jbG9uZSA9IGZ1bmN0aW9uKG9iail7CgkJCXZhciBvYmpDbG9uZSA9IHt9OwoJCQllYWNoKG9iaixmdW5jdGlvbih2YWx1ZSxrZXkpewoJCQkJaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSBvYmpDbG9uZVtrZXldID0gdmFsdWU7CgkJCX0pOwoJCQlyZXR1cm4gb2JqQ2xvbmU7CgkJfSwKCQlleHRlbmQgPSBoZWxwZXJzLmV4dGVuZCA9IGZ1bmN0aW9uKGJhc2UpewoJCQllYWNoKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywxKSwgZnVuY3Rpb24oZXh0ZW5zaW9uT2JqZWN0KSB7CgkJCQllYWNoKGV4dGVuc2lvbk9iamVjdCxmdW5jdGlvbih2YWx1ZSxrZXkpewoJCQkJCWlmIChleHRlbnNpb25PYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgYmFzZVtrZXldID0gdmFsdWU7CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBiYXNlOwoJCX0sCgkJbWVyZ2UgPSBoZWxwZXJzLm1lcmdlID0gZnVuY3Rpb24oYmFzZSxtYXN0ZXIpewoJCQkvL01lcmdlIHByb3BlcnRpZXMgaW4gbGVmdCBvYmplY3Qgb3ZlciB0byBhIHNoYWxsb3cgY2xvbmUgb2Ygb2JqZWN0IHJpZ2h0LgoJCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywwKTsKCQkJYXJncy51bnNoaWZ0KHt9KTsKCQkJcmV0dXJuIGV4dGVuZC5hcHBseShudWxsLCBhcmdzKTsKCQl9LAoJCWluZGV4T2YgPSBoZWxwZXJzLmluZGV4T2YgPSBmdW5jdGlvbihhcnJheVRvU2VhcmNoLCBpdGVtKXsKCQkJaWYgKEFycmF5LnByb3RvdHlwZS5pbmRleE9mKSB7CgkJCQlyZXR1cm4gYXJyYXlUb1NlYXJjaC5pbmRleE9mKGl0ZW0pOwoJCQl9CgkJCWVsc2V7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5VG9TZWFyY2gubGVuZ3RoOyBpKyspIHsKCQkJCQlpZiAoYXJyYXlUb1NlYXJjaFtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CgkJCQl9CgkJCQlyZXR1cm4gLTE7CgkJCX0KCQl9LAoJCXdoZXJlID0gaGVscGVycy53aGVyZSA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGZpbHRlckNhbGxiYWNrKXsKCQkJdmFyIGZpbHRlcmVkID0gW107CgoJCQloZWxwZXJzLmVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24oaXRlbSl7CgkJCQlpZiAoZmlsdGVyQ2FsbGJhY2soaXRlbSkpewoJCQkJCWZpbHRlcmVkLnB1c2goaXRlbSk7CgkJCQl9CgkJCX0pOwoKCQkJcmV0dXJuIGZpbHRlcmVkOwoJCX0sCgkJZmluZE5leHRXaGVyZSA9IGhlbHBlcnMuZmluZE5leHRXaGVyZSA9IGZ1bmN0aW9uKGFycmF5VG9TZWFyY2gsIGZpbHRlckNhbGxiYWNrLCBzdGFydEluZGV4KXsKCQkJLy8gRGVmYXVsdCB0byBzdGFydCBvZiB0aGUgYXJyYXkKCQkJaWYgKCFzdGFydEluZGV4KXsKCQkJCXN0YXJ0SW5kZXggPSAtMTsKCQkJfQoJCQlmb3IgKHZhciBpID0gc3RhcnRJbmRleCArIDE7IGkgPCBhcnJheVRvU2VhcmNoLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgY3VycmVudEl0ZW0gPSBhcnJheVRvU2VhcmNoW2ldOwoJCQkJaWYgKGZpbHRlckNhbGxiYWNrKGN1cnJlbnRJdGVtKSl7CgkJCQkJcmV0dXJuIGN1cnJlbnRJdGVtOwoJCQkJfQoJCQl9CgkJfSwKCQlmaW5kUHJldmlvdXNXaGVyZSA9IGhlbHBlcnMuZmluZFByZXZpb3VzV2hlcmUgPSBmdW5jdGlvbihhcnJheVRvU2VhcmNoLCBmaWx0ZXJDYWxsYmFjaywgc3RhcnRJbmRleCl7CgkJCS8vIERlZmF1bHQgdG8gZW5kIG9mIHRoZSBhcnJheQoJCQlpZiAoIXN0YXJ0SW5kZXgpewoJCQkJc3RhcnRJbmRleCA9IGFycmF5VG9TZWFyY2gubGVuZ3RoOwoJCQl9CgkJCWZvciAodmFyIGkgPSBzdGFydEluZGV4IC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCXZhciBjdXJyZW50SXRlbSA9IGFycmF5VG9TZWFyY2hbaV07CgkJCQlpZiAoZmlsdGVyQ2FsbGJhY2soY3VycmVudEl0ZW0pKXsKCQkJCQlyZXR1cm4gY3VycmVudEl0ZW07CgkJCQl9CgkJCX0KCQl9LAoJCWluaGVyaXRzID0gaGVscGVycy5pbmhlcml0cyA9IGZ1bmN0aW9uKGV4dGVuc2lvbnMpewoJCQkvL0Jhc2ljIGphdmFzY3JpcHQgaW5oZXJpdGFuY2UgYmFzZWQgb24gdGhlIG1vZGVsIGNyZWF0ZWQgaW4gQmFja2JvbmUuanMKCQkJdmFyIHBhcmVudCA9IHRoaXM7CgkJCXZhciBDaGFydEVsZW1lbnQgPSAoZXh0ZW5zaW9ucyAmJiBleHRlbnNpb25zLmhhc093blByb3BlcnR5KCJjb25zdHJ1Y3RvciIpKSA/IGV4dGVuc2lvbnMuY29uc3RydWN0b3IgOiBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgoJCQl2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IENoYXJ0RWxlbWVudDt9OwoJCQlTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCQkJQ2hhcnRFbGVtZW50LnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKCgkJCUNoYXJ0RWxlbWVudC5leHRlbmQgPSBpbmhlcml0czsKCgkJCWlmIChleHRlbnNpb25zKSBleHRlbmQoQ2hhcnRFbGVtZW50LnByb3RvdHlwZSwgZXh0ZW5zaW9ucyk7CgoJCQlDaGFydEVsZW1lbnQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkJCXJldHVybiBDaGFydEVsZW1lbnQ7CgkJfSwKCQlub29wID0gaGVscGVycy5ub29wID0gZnVuY3Rpb24oKXt9LAoJCXVpZCA9IGhlbHBlcnMudWlkID0gKGZ1bmN0aW9uKCl7CgkJCXZhciBpZD0wOwoJCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJCXJldHVybiAiY2hhcnQtIiArIGlkKys7CgkJCX07CgkJfSkoKSwKCQl3YXJuID0gaGVscGVycy53YXJuID0gZnVuY3Rpb24oc3RyKXsKCQkJLy9NZXRob2QgZm9yIHdhcm5pbmcgb2YgZXJyb3JzCgkJCWlmICh3aW5kb3cuY29uc29sZSAmJiB0eXBlb2Ygd2luZG93LmNvbnNvbGUud2FybiA9PSAiZnVuY3Rpb24iKSBjb25zb2xlLndhcm4oc3RyKTsKCQl9LAoJCWFtZCA9IGhlbHBlcnMuYW1kID0gKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSwKCQkvLy0tIE1hdGggbWV0aG9kcwoJCWlzTnVtYmVyID0gaGVscGVycy5pc051bWJlciA9IGZ1bmN0aW9uKG4pewoJCQlyZXR1cm4gIWlzTmFOKHBhcnNlRmxvYXQobikpICYmIGlzRmluaXRlKG4pOwoJCX0sCgkJbWF4ID0gaGVscGVycy5tYXggPSBmdW5jdGlvbihhcnJheSl7CgkJCXJldHVybiBNYXRoLm1heC5hcHBseSggTWF0aCwgYXJyYXkgKTsKCQl9LAoJCW1pbiA9IGhlbHBlcnMubWluID0gZnVuY3Rpb24oYXJyYXkpewoJCQlyZXR1cm4gTWF0aC5taW4uYXBwbHkoIE1hdGgsIGFycmF5ICk7CgkJfSwKCQljYXAgPSBoZWxwZXJzLmNhcCA9IGZ1bmN0aW9uKHZhbHVlVG9DYXAsbWF4VmFsdWUsbWluVmFsdWUpewoJCQlpZihpc051bWJlcihtYXhWYWx1ZSkpIHsKCQkJCWlmKCB2YWx1ZVRvQ2FwID4gbWF4VmFsdWUgKSB7CgkJCQkJcmV0dXJuIG1heFZhbHVlOwoJCQkJfQoJCQl9CgkJCWVsc2UgaWYoaXNOdW1iZXIobWluVmFsdWUpKXsKCQkJCWlmICggdmFsdWVUb0NhcCA8IG1pblZhbHVlICl7CgkJCQkJcmV0dXJuIG1pblZhbHVlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB2YWx1ZVRvQ2FwOwoJCX0sCgkJZ2V0RGVjaW1hbFBsYWNlcyA9IGhlbHBlcnMuZ2V0RGVjaW1hbFBsYWNlcyA9IGZ1bmN0aW9uKG51bSl7CgkJCWlmIChudW0lMSE9PTAgJiYgaXNOdW1iZXIobnVtKSl7CgkJCQlyZXR1cm4gbnVtLnRvU3RyaW5nKCkuc3BsaXQoIi4iKVsxXS5sZW5ndGg7CgkJCX0KCQkJZWxzZSB7CgkJCQlyZXR1cm4gMDsKCQkJfQoJCX0sCgkJdG9SYWRpYW5zID0gaGVscGVycy5yYWRpYW5zID0gZnVuY3Rpb24oZGVncmVlcyl7CgkJCXJldHVybiBkZWdyZWVzICogKE1hdGguUEkvMTgwKTsKCQl9LAoJCS8vIEdldHMgdGhlIGFuZ2xlIGZyb20gdmVydGljYWwgdXByaWdodCB0byB0aGUgcG9pbnQgYWJvdXQgYSBjZW50cmUuCgkJZ2V0QW5nbGVGcm9tUG9pbnQgPSBoZWxwZXJzLmdldEFuZ2xlRnJvbVBvaW50ID0gZnVuY3Rpb24oY2VudHJlUG9pbnQsIGFuZ2xlUG9pbnQpewoJCQl2YXIgZGlzdGFuY2VGcm9tWENlbnRlciA9IGFuZ2xlUG9pbnQueCAtIGNlbnRyZVBvaW50LngsCgkJCQlkaXN0YW5jZUZyb21ZQ2VudGVyID0gYW5nbGVQb2ludC55IC0gY2VudHJlUG9pbnQueSwKCQkJCXJhZGlhbERpc3RhbmNlRnJvbUNlbnRlciA9IE1hdGguc3FydCggZGlzdGFuY2VGcm9tWENlbnRlciAqIGRpc3RhbmNlRnJvbVhDZW50ZXIgKyBkaXN0YW5jZUZyb21ZQ2VudGVyICogZGlzdGFuY2VGcm9tWUNlbnRlcik7CgoKCQkJdmFyIGFuZ2xlID0gTWF0aC5QSSAqIDIgKyBNYXRoLmF0YW4yKGRpc3RhbmNlRnJvbVlDZW50ZXIsIGRpc3RhbmNlRnJvbVhDZW50ZXIpOwoKCQkJLy9JZiB0aGUgc2VnbWVudCBpcyBpbiB0aGUgdG9wIGxlZnQgcXVhZHJhbnQsIHdlIG5lZWQgdG8gYWRkIGFub3RoZXIgcm90YXRpb24gdG8gdGhlIGFuZ2xlCgkJCWlmIChkaXN0YW5jZUZyb21YQ2VudGVyIDwgMCAmJiBkaXN0YW5jZUZyb21ZQ2VudGVyIDwgMCl7CgkJCQlhbmdsZSArPSBNYXRoLlBJKjI7CgkJCX0KCgkJCXJldHVybiB7CgkJCQlhbmdsZTogYW5nbGUsCgkJCQlkaXN0YW5jZTogcmFkaWFsRGlzdGFuY2VGcm9tQ2VudGVyCgkJCX07CgkJfSwKCQlhbGlhc1BpeGVsID0gaGVscGVycy5hbGlhc1BpeGVsID0gZnVuY3Rpb24ocGl4ZWxXaWR0aCl7CgkJCXJldHVybiAocGl4ZWxXaWR0aCAlIDIgPT09IDApID8gMCA6IDAuNTsKCQl9LAoJCXNwbGluZUN1cnZlID0gaGVscGVycy5zcGxpbmVDdXJ2ZSA9IGZ1bmN0aW9uKEZpcnN0UG9pbnQsTWlkZGxlUG9pbnQsQWZ0ZXJQb2ludCx0KXsKCQkJLy9Qcm9wcyB0byBSb2IgU3BlbmNlciBhdCBzY2FsZWQgaW5ub3ZhdGlvbiBmb3IgaGlzIHBvc3Qgb24gc3BsaW5pbmcgYmV0d2VlbiBwb2ludHMKCQkJLy9odHRwOi8vc2NhbGVkaW5ub3ZhdGlvbi5jb20vYW5hbHl0aWNzL3NwbGluZXMvYWJvdXRTcGxpbmVzLmh0bWwKCQkJdmFyIGQwMT1NYXRoLnNxcnQoTWF0aC5wb3coTWlkZGxlUG9pbnQueC1GaXJzdFBvaW50LngsMikrTWF0aC5wb3coTWlkZGxlUG9pbnQueS1GaXJzdFBvaW50LnksMikpLAoJCQkJZDEyPU1hdGguc3FydChNYXRoLnBvdyhBZnRlclBvaW50LngtTWlkZGxlUG9pbnQueCwyKStNYXRoLnBvdyhBZnRlclBvaW50LnktTWlkZGxlUG9pbnQueSwyKSksCgkJCQlmYT10KmQwMS8oZDAxK2QxMiksLy8gc2NhbGluZyBmYWN0b3IgZm9yIHRyaWFuZ2xlIFRhCgkJCQlmYj10KmQxMi8oZDAxK2QxMik7CgkJCXJldHVybiB7CgkJCQlpbm5lciA6IHsKCQkJCQl4IDogTWlkZGxlUG9pbnQueC1mYSooQWZ0ZXJQb2ludC54LUZpcnN0UG9pbnQueCksCgkJCQkJeSA6IE1pZGRsZVBvaW50LnktZmEqKEFmdGVyUG9pbnQueS1GaXJzdFBvaW50LnkpCgkJCQl9LAoJCQkJb3V0ZXIgOiB7CgkJCQkJeDogTWlkZGxlUG9pbnQueCtmYiooQWZ0ZXJQb2ludC54LUZpcnN0UG9pbnQueCksCgkJCQkJeSA6IE1pZGRsZVBvaW50LnkrZmIqKEFmdGVyUG9pbnQueS1GaXJzdFBvaW50LnkpCgkJCQl9CgkJCX07CgkJfSwKCQljYWxjdWxhdGVPcmRlck9mTWFnbml0dWRlID0gaGVscGVycy5jYWxjdWxhdGVPcmRlck9mTWFnbml0dWRlID0gZnVuY3Rpb24odmFsKXsKCQkJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5sb2codmFsKSAvIE1hdGguTE4xMCk7CgkJfSwKCQljYWxjdWxhdGVTY2FsZVJhbmdlID0gaGVscGVycy5jYWxjdWxhdGVTY2FsZVJhbmdlID0gZnVuY3Rpb24odmFsdWVzQXJyYXksIGRyYXdpbmdTaXplLCB0ZXh0U2l6ZSwgc3RhcnRGcm9tWmVybywgaW50ZWdlcnNPbmx5KXsKCgkJCS8vU2V0IGEgbWluaW11bSBzdGVwIG9mIHR3byAtIGEgcG9pbnQgYXQgdGhlIHRvcCBvZiB0aGUgZ3JhcGgsIGFuZCBhIHBvaW50IGF0IHRoZSBiYXNlCgkJCXZhciBtaW5TdGVwcyA9IDIsCgkJCQltYXhTdGVwcyA9IE1hdGguZmxvb3IoZHJhd2luZ1NpemUvKHRleHRTaXplICogMS41KSksCgkJCQlza2lwRml0dGluZyA9IChtaW5TdGVwcyA+PSBtYXhTdGVwcyk7CgoJCQl2YXIgbWF4VmFsdWUgPSBtYXgodmFsdWVzQXJyYXkpLAoJCQkJbWluVmFsdWUgPSBtaW4odmFsdWVzQXJyYXkpOwoKCQkJLy8gV2UgbmVlZCBzb21lIGRlZ3JlZSBvZiBzZXBlcmF0aW9uIGhlcmUgdG8gY2FsY3VsYXRlIHRoZSBzY2FsZXMgaWYgYWxsIHRoZSB2YWx1ZXMgYXJlIHRoZSBzYW1lCgkJCS8vIEFkZGluZy9taW51c2luZyAwLjUgd2lsbCBnaXZlIHVzIGEgcmFuZ2Ugb2YgMS4KCQkJaWYgKG1heFZhbHVlID09PSBtaW5WYWx1ZSl7CgkJCQltYXhWYWx1ZSArPSAwLjU7CgkJCQkvLyBTbyB3ZSBkb24ndCBlbmQgdXAgd2l0aCBhIGdyYXBoIHdpdGggYSBuZWdhdGl2ZSBzdGFydCB2YWx1ZSBpZiB3ZSd2ZSBzYWlkIGFsd2F5cyBzdGFydCBmcm9tIHplcm8KCQkJCWlmIChtaW5WYWx1ZSA+PSAwLjUgJiYgIXN0YXJ0RnJvbVplcm8pewoJCQkJCW1pblZhbHVlIC09IDAuNTsKCQkJCX0KCQkJCWVsc2V7CgkJCQkJLy8gTWFrZSB1cCBhIHdob2xlIG51bWJlciBhYm92ZSB0aGUgdmFsdWVzCgkJCQkJbWF4VmFsdWUgKz0gMC41OwoJCQkJfQoJCQl9CgoJCQl2YXIJdmFsdWVSYW5nZSA9IE1hdGguYWJzKG1heFZhbHVlIC0gbWluVmFsdWUpLAoJCQkJcmFuZ2VPcmRlck9mTWFnbml0dWRlID0gY2FsY3VsYXRlT3JkZXJPZk1hZ25pdHVkZSh2YWx1ZVJhbmdlKSwKCQkJCWdyYXBoTWF4ID0gTWF0aC5jZWlsKG1heFZhbHVlIC8gKDEgKiBNYXRoLnBvdygxMCwgcmFuZ2VPcmRlck9mTWFnbml0dWRlKSkpICogTWF0aC5wb3coMTAsIHJhbmdlT3JkZXJPZk1hZ25pdHVkZSksCgkJCQlncmFwaE1pbiA9IChzdGFydEZyb21aZXJvKSA/IDAgOiBNYXRoLmZsb29yKG1pblZhbHVlIC8gKDEgKiBNYXRoLnBvdygxMCwgcmFuZ2VPcmRlck9mTWFnbml0dWRlKSkpICogTWF0aC5wb3coMTAsIHJhbmdlT3JkZXJPZk1hZ25pdHVkZSksCgkJCQlncmFwaFJhbmdlID0gZ3JhcGhNYXggLSBncmFwaE1pbiwKCQkJCXN0ZXBWYWx1ZSA9IE1hdGgucG93KDEwLCByYW5nZU9yZGVyT2ZNYWduaXR1ZGUpLAoJCQkJbnVtYmVyT2ZTdGVwcyA9IE1hdGgucm91bmQoZ3JhcGhSYW5nZSAvIHN0ZXBWYWx1ZSk7CgoJCQkvL0lmIHdlIGhhdmUgbW9yZSBzcGFjZSBvbiB0aGUgZ3JhcGggd2UnbGwgdXNlIGl0IHRvIGdpdmUgbW9yZSBkZWZpbml0aW9uIHRvIHRoZSBkYXRhCgkJCXdoaWxlKChudW1iZXJPZlN0ZXBzID4gbWF4U3RlcHMgfHwgKG51bWJlck9mU3RlcHMgKiAyKSA8IG1heFN0ZXBzKSAmJiAhc2tpcEZpdHRpbmcpIHsKCQkJCWlmKG51bWJlck9mU3RlcHMgPiBtYXhTdGVwcyl7CgkJCQkJc3RlcFZhbHVlICo9MjsKCQkJCQludW1iZXJPZlN0ZXBzID0gTWF0aC5yb3VuZChncmFwaFJhbmdlL3N0ZXBWYWx1ZSk7CgkJCQkJLy8gRG9uJ3QgZXZlciBkZWFsIHdpdGggYSBkZWNpbWFsIG51bWJlciBvZiBzdGVwcyAtIGNhbmNlbCBmaXR0aW5nIGFuZCBqdXN0IHVzZSB0aGUgbWluaW11bSBudW1iZXIgb2Ygc3RlcHMuCgkJCQkJaWYgKG51bWJlck9mU3RlcHMgJSAxICE9PSAwKXsKCQkJCQkJc2tpcEZpdHRpbmcgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJCS8vV2UgY2FuIGZpdCBpbiBkb3VibGUgdGhlIGFtb3VudCBvZiBzY2FsZSBwb2ludHMgb24gdGhlIHNjYWxlCgkJCQllbHNlewoJCQkJCS8vSWYgdXNlciBoYXMgZGVjbGFyZWQgaW50cyBvbmx5LCBhbmQgdGhlIHN0ZXAgdmFsdWUgaXNuJ3QgYSBkZWNpbWFsCgkJCQkJaWYgKGludGVnZXJzT25seSAmJiByYW5nZU9yZGVyT2ZNYWduaXR1ZGUgPj0gMCl7CgkJCQkJCS8vSWYgdGhlIHVzZXIgaGFzIHNhaWQgaW50ZWdlcnMgb25seSwgd2UgbmVlZCB0byBjaGVjayB0aGF0IG1ha2luZyB0aGUgc2NhbGUgbW9yZSBncmFudWxhciB3b3VsZG4ndCBtYWtlIGl0IGEgZmxvYXQKCQkJCQkJaWYoc3RlcFZhbHVlLzIgJSAxID09PSAwKXsKCQkJCQkJCXN0ZXBWYWx1ZSAvPTI7CgkJCQkJCQludW1iZXJPZlN0ZXBzID0gTWF0aC5yb3VuZChncmFwaFJhbmdlL3N0ZXBWYWx1ZSk7CgkJCQkJCX0KCQkJCQkJLy9JZiBpdCB3b3VsZCBtYWtlIGl0IGEgZmxvYXQgYnJlYWsgb3V0IG9mIHRoZSBsb29wCgkJCQkJCWVsc2V7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQkvL0lmIHRoZSBzY2FsZSBkb2Vzbid0IGhhdmUgdG8gYmUgYW4gaW50LCBtYWtlIHRoZSBzY2FsZSBtb3JlIGdyYW51bGFyIGFueXdheS4KCQkJCQllbHNlewoJCQkJCQlzdGVwVmFsdWUgLz0yOwoJCQkJCQludW1iZXJPZlN0ZXBzID0gTWF0aC5yb3VuZChncmFwaFJhbmdlL3N0ZXBWYWx1ZSk7CgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJaWYgKHNraXBGaXR0aW5nKXsKCQkJCW51bWJlck9mU3RlcHMgPSBtaW5TdGVwczsKCQkJCXN0ZXBWYWx1ZSA9IGdyYXBoUmFuZ2UgLyBudW1iZXJPZlN0ZXBzOwoJCQl9CgoJCQlyZXR1cm4gewoJCQkJc3RlcHMgOiBudW1iZXJPZlN0ZXBzLAoJCQkJc3RlcFZhbHVlIDogc3RlcFZhbHVlLAoJCQkJbWluIDogZ3JhcGhNaW4sCgkJCQltYXgJOiBncmFwaE1pbiArIChudW1iZXJPZlN0ZXBzICogc3RlcFZhbHVlKQoJCQl9OwoKCQl9LAoJCS8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi8KCQkvLyBCbG93cyB1cCBqc2hpbnQgZXJyb3JzIGJhc2VkIG9uIHRoZSBuZXcgRnVuY3Rpb24gY29uc3RydWN0b3IKCQkvL1RlbXBsYXRpbmcgbWV0aG9kcwoJCS8vSmF2YXNjcmlwdCBtaWNybyB0ZW1wbGF0aW5nIGJ5IEpvaG4gUmVzaWcgLSBzb3VyY2UgYXQgaHR0cDovL2Vqb2huLm9yZy9ibG9nL2phdmFzY3JpcHQtbWljcm8tdGVtcGxhdGluZy8KCQl0ZW1wbGF0ZSA9IGhlbHBlcnMudGVtcGxhdGUgPSBmdW5jdGlvbih0ZW1wbGF0ZVN0cmluZywgdmFsdWVzT2JqZWN0KXsKCgkJCS8vIElmIHRlbXBsYXRlU3RyaW5nIGlzIGZ1bmN0aW9uIHJhdGhlciB0aGFuIHN0cmluZy10ZW1wbGF0ZSAtIGNhbGwgdGhlIGZ1bmN0aW9uIGZvciB2YWx1ZXNPYmplY3QKCgkJCWlmKHRlbXBsYXRlU3RyaW5nIGluc3RhbmNlb2YgRnVuY3Rpb24pewoJCQkgCXJldHVybiB0ZW1wbGF0ZVN0cmluZyh2YWx1ZXNPYmplY3QpOwoJCSAJfQoKCQkJdmFyIGNhY2hlID0ge307CgkJCWZ1bmN0aW9uIHRtcGwoc3RyLCBkYXRhKXsKCQkJCS8vIEZpZ3VyZSBvdXQgaWYgd2UncmUgZ2V0dGluZyBhIHRlbXBsYXRlLCBvciBpZiB3ZSBuZWVkIHRvCgkJCQkvLyBsb2FkIHRoZSB0ZW1wbGF0ZSAtIGFuZCBiZSBzdXJlIHRvIGNhY2hlIHRoZSByZXN1bHQuCgkJCQl2YXIgZm4gPSAhL1xXLy50ZXN0KHN0cikgPwoJCQkJY2FjaGVbc3RyXSA9IGNhY2hlW3N0cl0gOgoKCQkJCS8vIEdlbmVyYXRlIGEgcmV1c2FibGUgZnVuY3Rpb24gdGhhdCB3aWxsIHNlcnZlIGFzIGEgdGVtcGxhdGUKCQkJCS8vIGdlbmVyYXRvciAoYW5kIHdoaWNoIHdpbGwgYmUgY2FjaGVkKS4KCQkJCW5ldyBGdW5jdGlvbigib2JqIiwKCQkJCQkidmFyIHA9W10scHJpbnQ9ZnVuY3Rpb24oKXtwLnB1c2guYXBwbHkocCxhcmd1bWVudHMpO307IiArCgoJCQkJCS8vIEludHJvZHVjZSB0aGUgZGF0YSBhcyBsb2NhbCB2YXJpYWJsZXMgdXNpbmcgd2l0aCgpe30KCQkJCQkid2l0aChvYmope3AucHVzaCgnIiArCgoJCQkJCS8vIENvbnZlcnQgdGhlIHRlbXBsYXRlIGludG8gcHVyZSBKYXZhU2NyaXB0CgkJCQkJc3RyCgkJCQkJCS5yZXBsYWNlKC9bXHJcdFxuXS9nLCAiICIpCgkJCQkJCS5zcGxpdCgiPCUiKS5qb2luKCJcdCIpCgkJCQkJCS5yZXBsYWNlKC8oKF58JT4pW15cdF0qKScvZywgIiQxXHIiKQoJCQkJCQkucmVwbGFjZSgvXHQ9KC4qPyklPi9nLCAiJywkMSwnIikKCQkJCQkJLnNwbGl0KCJcdCIpLmpvaW4oIicpOyIpCgkJCQkJCS5zcGxpdCgiJT4iKS5qb2luKCJwLnB1c2goJyIpCgkJCQkJCS5zcGxpdCgiXHIiKS5qb2luKCJcXCciKSArCgkJCQkJIicpO31yZXR1cm4gcC5qb2luKCcnKTsiCgkJCQkpOwoKCQkJCS8vIFByb3ZpZGUgc29tZSBiYXNpYyBjdXJyeWluZyB0byB0aGUgdXNlcgoJCQkJcmV0dXJuIGRhdGEgPyBmbiggZGF0YSApIDogZm47CgkJCX0KCQkJcmV0dXJuIHRtcGwodGVtcGxhdGVTdHJpbmcsdmFsdWVzT2JqZWN0KTsKCQl9LAoJCS8qIGpzaGludCBpZ25vcmU6ZW5kICovCgkJZ2VuZXJhdGVMYWJlbHMgPSBoZWxwZXJzLmdlbmVyYXRlTGFiZWxzID0gZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcsbnVtYmVyT2ZTdGVwcyxncmFwaE1pbixzdGVwVmFsdWUpewoJCQl2YXIgbGFiZWxzQXJyYXkgPSBuZXcgQXJyYXkobnVtYmVyT2ZTdGVwcyk7CgkJCWlmIChsYWJlbFRlbXBsYXRlU3RyaW5nKXsKCQkJCWVhY2gobGFiZWxzQXJyYXksZnVuY3Rpb24odmFsLGluZGV4KXsKCQkJCQlsYWJlbHNBcnJheVtpbmRleF0gPSB0ZW1wbGF0ZSh0ZW1wbGF0ZVN0cmluZyx7dmFsdWU6IChncmFwaE1pbiArIChzdGVwVmFsdWUqKGluZGV4KzEpKSl9KTsKCQkJCX0pOwoJCQl9CgkJCXJldHVybiBsYWJlbHNBcnJheTsKCQl9LAoJCS8vLS1BbmltYXRpb24gbWV0aG9kcwoJCS8vRWFzaW5nIGZ1bmN0aW9ucyBhZGFwdGVkIGZyb20gUm9iZXJ0IFBlbm5lcidzIGVhc2luZyBlcXVhdGlvbnMKCQkvL2h0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcvCgkJZWFzaW5nRWZmZWN0cyA9IGhlbHBlcnMuZWFzaW5nRWZmZWN0cyA9IHsKCQkJbGluZWFyOiBmdW5jdGlvbiAodCkgewoJCQkJcmV0dXJuIHQ7CgkJCX0sCgkJCWVhc2VJblF1YWQ6IGZ1bmN0aW9uICh0KSB7CgkJCQlyZXR1cm4gdCAqIHQ7CgkJCX0sCgkJCWVhc2VPdXRRdWFkOiBmdW5jdGlvbiAodCkgewoJCQkJcmV0dXJuIC0xICogdCAqICh0IC0gMik7CgkJCX0sCgkJCWVhc2VJbk91dFF1YWQ6IGZ1bmN0aW9uICh0KSB7CgkJCQlpZiAoKHQgLz0gMSAvIDIpIDwgMSkgcmV0dXJuIDEgLyAyICogdCAqIHQ7CgkJCQlyZXR1cm4gLTEgLyAyICogKCgtLXQpICogKHQgLSAyKSAtIDEpOwoJCQl9LAoJCQllYXNlSW5DdWJpYzogZnVuY3Rpb24gKHQpIHsKCQkJCXJldHVybiB0ICogdCAqIHQ7CgkJCX0sCgkJCWVhc2VPdXRDdWJpYzogZnVuY3Rpb24gKHQpIHsKCQkJCXJldHVybiAxICogKCh0ID0gdCAvIDEgLSAxKSAqIHQgKiB0ICsgMSk7CgkJCX0sCgkJCWVhc2VJbk91dEN1YmljOiBmdW5jdGlvbiAodCkgewoJCQkJaWYgKCh0IC89IDEgLyAyKSA8IDEpIHJldHVybiAxIC8gMiAqIHQgKiB0ICogdDsKCQkJCXJldHVybiAxIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICsgMik7CgkJCX0sCgkJCWVhc2VJblF1YXJ0OiBmdW5jdGlvbiAodCkgewoJCQkJcmV0dXJuIHQgKiB0ICogdCAqIHQ7CgkJCX0sCgkJCWVhc2VPdXRRdWFydDogZnVuY3Rpb24gKHQpIHsKCQkJCXJldHVybiAtMSAqICgodCA9IHQgLyAxIC0gMSkgKiB0ICogdCAqIHQgLSAxKTsKCQkJfSwKCQkJZWFzZUluT3V0UXVhcnQ6IGZ1bmN0aW9uICh0KSB7CgkJCQlpZiAoKHQgLz0gMSAvIDIpIDwgMSkgcmV0dXJuIDEgLyAyICogdCAqIHQgKiB0ICogdDsKCQkJCXJldHVybiAtMSAvIDIgKiAoKHQgLT0gMikgKiB0ICogdCAqIHQgLSAyKTsKCQkJfSwKCQkJZWFzZUluUXVpbnQ6IGZ1bmN0aW9uICh0KSB7CgkJCQlyZXR1cm4gMSAqICh0IC89IDEpICogdCAqIHQgKiB0ICogdDsKCQkJfSwKCQkJZWFzZU91dFF1aW50OiBmdW5jdGlvbiAodCkgewoJCQkJcmV0dXJuIDEgKiAoKHQgPSB0IC8gMSAtIDEpICogdCAqIHQgKiB0ICogdCArIDEpOwoJCQl9LAoJCQllYXNlSW5PdXRRdWludDogZnVuY3Rpb24gKHQpIHsKCQkJCWlmICgodCAvPSAxIC8gMikgPCAxKSByZXR1cm4gMSAvIDIgKiB0ICogdCAqIHQgKiB0ICogdDsKCQkJCXJldHVybiAxIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAqIHQgKyAyKTsKCQkJfSwKCQkJZWFzZUluU2luZTogZnVuY3Rpb24gKHQpIHsKCQkJCXJldHVybiAtMSAqIE1hdGguY29zKHQgLyAxICogKE1hdGguUEkgLyAyKSkgKyAxOwoJCQl9LAoJCQllYXNlT3V0U2luZTogZnVuY3Rpb24gKHQpIHsKCQkJCXJldHVybiAxICogTWF0aC5zaW4odCAvIDEgKiAoTWF0aC5QSSAvIDIpKTsKCQkJfSwKCQkJZWFzZUluT3V0U2luZTogZnVuY3Rpb24gKHQpIHsKCQkJCXJldHVybiAtMSAvIDIgKiAoTWF0aC5jb3MoTWF0aC5QSSAqIHQgLyAxKSAtIDEpOwoJCQl9LAoJCQllYXNlSW5FeHBvOiBmdW5jdGlvbiAodCkgewoJCQkJcmV0dXJuICh0ID09PSAwKSA/IDEgOiAxICogTWF0aC5wb3coMiwgMTAgKiAodCAvIDEgLSAxKSk7CgkJCX0sCgkJCWVhc2VPdXRFeHBvOiBmdW5jdGlvbiAodCkgewoJCQkJcmV0dXJuICh0ID09PSAxKSA/IDEgOiAxICogKC1NYXRoLnBvdygyLCAtMTAgKiB0IC8gMSkgKyAxKTsKCQkJfSwKCQkJZWFzZUluT3V0RXhwbzogZnVuY3Rpb24gKHQpIHsKCQkJCWlmICh0ID09PSAwKSByZXR1cm4gMDsKCQkJCWlmICh0ID09PSAxKSByZXR1cm4gMTsKCQkJCWlmICgodCAvPSAxIC8gMikgPCAxKSByZXR1cm4gMSAvIDIgKiBNYXRoLnBvdygyLCAxMCAqICh0IC0gMSkpOwoJCQkJcmV0dXJuIDEgLyAyICogKC1NYXRoLnBvdygyLCAtMTAgKiAtLXQpICsgMik7CgkJCX0sCgkJCWVhc2VJbkNpcmM6IGZ1bmN0aW9uICh0KSB7CgkJCQlpZiAodCA+PSAxKSByZXR1cm4gdDsKCQkJCXJldHVybiAtMSAqIChNYXRoLnNxcnQoMSAtICh0IC89IDEpICogdCkgLSAxKTsKCQkJfSwKCQkJZWFzZU91dENpcmM6IGZ1bmN0aW9uICh0KSB7CgkJCQlyZXR1cm4gMSAqIE1hdGguc3FydCgxIC0gKHQgPSB0IC8gMSAtIDEpICogdCk7CgkJCX0sCgkJCWVhc2VJbk91dENpcmM6IGZ1bmN0aW9uICh0KSB7CgkJCQlpZiAoKHQgLz0gMSAvIDIpIDwgMSkgcmV0dXJuIC0xIC8gMiAqIChNYXRoLnNxcnQoMSAtIHQgKiB0KSAtIDEpOwoJCQkJcmV0dXJuIDEgLyAyICogKE1hdGguc3FydCgxIC0gKHQgLT0gMikgKiB0KSArIDEpOwoJCQl9LAoJCQllYXNlSW5FbGFzdGljOiBmdW5jdGlvbiAodCkgewoJCQkJdmFyIHMgPSAxLjcwMTU4OwoJCQkJdmFyIHAgPSAwOwoJCQkJdmFyIGEgPSAxOwoJCQkJaWYgKHQgPT09IDApIHJldHVybiAwOwoJCQkJaWYgKCh0IC89IDEpID09IDEpIHJldHVybiAxOwoJCQkJaWYgKCFwKSBwID0gMSAqIDAuMzsKCQkJCWlmIChhIDwgTWF0aC5hYnMoMSkpIHsKCQkJCQlhID0gMTsKCQkJCQlzID0gcCAvIDQ7CgkJCQl9IGVsc2UgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKDEgLyBhKTsKCQkJCXJldHVybiAtKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogMSAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKTsKCQkJfSwKCQkJZWFzZU91dEVsYXN0aWM6IGZ1bmN0aW9uICh0KSB7CgkJCQl2YXIgcyA9IDEuNzAxNTg7CgkJCQl2YXIgcCA9IDA7CgkJCQl2YXIgYSA9IDE7CgkJCQlpZiAodCA9PT0gMCkgcmV0dXJuIDA7CgkJCQlpZiAoKHQgLz0gMSkgPT0gMSkgcmV0dXJuIDE7CgkJCQlpZiAoIXApIHAgPSAxICogMC4zOwoJCQkJaWYgKGEgPCBNYXRoLmFicygxKSkgewoJCQkJCWEgPSAxOwoJCQkJCXMgPSBwIC8gNDsKCQkJCX0gZWxzZSBzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oMSAvIGEpOwoJCQkJcmV0dXJuIGEgKiBNYXRoLnBvdygyLCAtMTAgKiB0KSAqIE1hdGguc2luKCh0ICogMSAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICsgMTsKCQkJfSwKCQkJZWFzZUluT3V0RWxhc3RpYzogZnVuY3Rpb24gKHQpIHsKCQkJCXZhciBzID0gMS43MDE1ODsKCQkJCXZhciBwID0gMDsKCQkJCXZhciBhID0gMTsKCQkJCWlmICh0ID09PSAwKSByZXR1cm4gMDsKCQkJCWlmICgodCAvPSAxIC8gMikgPT0gMikgcmV0dXJuIDE7CgkJCQlpZiAoIXApIHAgPSAxICogKDAuMyAqIDEuNSk7CgkJCQlpZiAoYSA8IE1hdGguYWJzKDEpKSB7CgkJCQkJYSA9IDE7CgkJCQkJcyA9IHAgLyA0OwoJCQkJfSBlbHNlIHMgPSBwIC8gKDIgKiBNYXRoLlBJKSAqIE1hdGguYXNpbigxIC8gYSk7CgkJCQlpZiAodCA8IDEpIHJldHVybiAtMC41ICogKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogMSAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKTsKCQkJCXJldHVybiBhICogTWF0aC5wb3coMiwgLTEwICogKHQgLT0gMSkpICogTWF0aC5zaW4oKHQgKiAxIC0gcykgKiAoMiAqIE1hdGguUEkpIC8gcCkgKiAwLjUgKyAxOwoJCQl9LAoJCQllYXNlSW5CYWNrOiBmdW5jdGlvbiAodCkgewoJCQkJdmFyIHMgPSAxLjcwMTU4OwoJCQkJcmV0dXJuIDEgKiAodCAvPSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgLSBzKTsKCQkJfSwKCQkJZWFzZU91dEJhY2s6IGZ1bmN0aW9uICh0KSB7CgkJCQl2YXIgcyA9IDEuNzAxNTg7CgkJCQlyZXR1cm4gMSAqICgodCA9IHQgLyAxIC0gMSkgKiB0ICogKChzICsgMSkgKiB0ICsgcykgKyAxKTsKCQkJfSwKCQkJZWFzZUluT3V0QmFjazogZnVuY3Rpb24gKHQpIHsKCQkJCXZhciBzID0gMS43MDE1ODsKCQkJCWlmICgodCAvPSAxIC8gMikgPCAxKSByZXR1cm4gMSAvIDIgKiAodCAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0IC0gcykpOwoJCQkJcmV0dXJuIDEgLyAyICogKCh0IC09IDIpICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgKyBzKSArIDIpOwoJCQl9LAoJCQllYXNlSW5Cb3VuY2U6IGZ1bmN0aW9uICh0KSB7CgkJCQlyZXR1cm4gMSAtIGVhc2luZ0VmZmVjdHMuZWFzZU91dEJvdW5jZSgxIC0gdCk7CgkJCX0sCgkJCWVhc2VPdXRCb3VuY2U6IGZ1bmN0aW9uICh0KSB7CgkJCQlpZiAoKHQgLz0gMSkgPCAoMSAvIDIuNzUpKSB7CgkJCQkJcmV0dXJuIDEgKiAoNy41NjI1ICogdCAqIHQpOwoJCQkJfSBlbHNlIGlmICh0IDwgKDIgLyAyLjc1KSkgewoJCQkJCXJldHVybiAxICogKDcuNTYyNSAqICh0IC09ICgxLjUgLyAyLjc1KSkgKiB0ICsgMC43NSk7CgkJCQl9IGVsc2UgaWYgKHQgPCAoMi41IC8gMi43NSkpIHsKCQkJCQlyZXR1cm4gMSAqICg3LjU2MjUgKiAodCAtPSAoMi4yNSAvIDIuNzUpKSAqIHQgKyAwLjkzNzUpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gMSAqICg3LjU2MjUgKiAodCAtPSAoMi42MjUgLyAyLjc1KSkgKiB0ICsgMC45ODQzNzUpOwoJCQkJfQoJCQl9LAoJCQllYXNlSW5PdXRCb3VuY2U6IGZ1bmN0aW9uICh0KSB7CgkJCQlpZiAodCA8IDEgLyAyKSByZXR1cm4gZWFzaW5nRWZmZWN0cy5lYXNlSW5Cb3VuY2UodCAqIDIpICogMC41OwoJCQkJcmV0dXJuIGVhc2luZ0VmZmVjdHMuZWFzZU91dEJvdW5jZSh0ICogMiAtIDEpICogMC41ICsgMSAqIDAuNTsKCQkJfQoJCX0sCgkJLy9SZXF1ZXN0IGFuaW1hdGlvbiBwb2x5ZmlsbCAtIGh0dHA6Ly93d3cucGF1bGlyaXNoLmNvbS8yMDExL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtYW5pbWF0aW5nLwoJCXJlcXVlc3RBbmltRnJhbWUgPSBoZWxwZXJzLnJlcXVlc3RBbmltRnJhbWUgPSAoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKCQkJCXdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKCQkJCXdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKCQkJCXdpbmRvdy5vUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CgkJCQl3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKCQkJCWZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJCQkJcmV0dXJuIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxMDAwIC8gNjApOwoJCQkJfTsKCQl9KSgpLAoJCWNhbmNlbEFuaW1GcmFtZSA9IGhlbHBlcnMuY2FuY2VsQW5pbUZyYW1lID0gKGZ1bmN0aW9uKCl7CgkJCXJldHVybiB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKCQkJCXdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAoJCQkJd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CgkJCQl3aW5kb3cub0NhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CgkJCQl3aW5kb3cubXNDYW5jZWxBbmltYXRpb25GcmFtZSB8fAoJCQkJZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCQlyZXR1cm4gd2luZG93LmNsZWFyVGltZW91dChjYWxsYmFjaywgMTAwMCAvIDYwKTsKCQkJCX07CgkJfSkoKSwKCQlhbmltYXRpb25Mb29wID0gaGVscGVycy5hbmltYXRpb25Mb29wID0gZnVuY3Rpb24oY2FsbGJhY2ssdG90YWxTdGVwcyxlYXNpbmdTdHJpbmcsb25Qcm9ncmVzcyxvbkNvbXBsZXRlLGNoYXJ0SW5zdGFuY2UpewoKCQkJdmFyIGN1cnJlbnRTdGVwID0gMCwKCQkJCWVhc2luZ0Z1bmN0aW9uID0gZWFzaW5nRWZmZWN0c1tlYXNpbmdTdHJpbmddIHx8IGVhc2luZ0VmZmVjdHMubGluZWFyOwoKCQkJdmFyIGFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oKXsKCQkJCWN1cnJlbnRTdGVwKys7CgkJCQl2YXIgc3RlcERlY2ltYWwgPSBjdXJyZW50U3RlcC90b3RhbFN0ZXBzOwoJCQkJdmFyIGVhc2VEZWNpbWFsID0gZWFzaW5nRnVuY3Rpb24oc3RlcERlY2ltYWwpOwoKCQkJCWNhbGxiYWNrLmNhbGwoY2hhcnRJbnN0YW5jZSxlYXNlRGVjaW1hbCxzdGVwRGVjaW1hbCwgY3VycmVudFN0ZXApOwoJCQkJb25Qcm9ncmVzcy5jYWxsKGNoYXJ0SW5zdGFuY2UsZWFzZURlY2ltYWwsc3RlcERlY2ltYWwpOwoJCQkJaWYgKGN1cnJlbnRTdGVwIDwgdG90YWxTdGVwcyl7CgkJCQkJY2hhcnRJbnN0YW5jZS5hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltRnJhbWUoYW5pbWF0aW9uRnJhbWUpOwoJCQkJfSBlbHNlewoJCQkJCW9uQ29tcGxldGUuYXBwbHkoY2hhcnRJbnN0YW5jZSk7CgkJCQl9CgkJCX07CgkJCXJlcXVlc3RBbmltRnJhbWUoYW5pbWF0aW9uRnJhbWUpOwoJCX0sCgkJLy8tLSBET00gbWV0aG9kcwoJCWdldFJlbGF0aXZlUG9zaXRpb24gPSBoZWxwZXJzLmdldFJlbGF0aXZlUG9zaXRpb24gPSBmdW5jdGlvbihldnQpewoJCQl2YXIgbW91c2VYLCBtb3VzZVk7CgkJCXZhciBlID0gZXZ0Lm9yaWdpbmFsRXZlbnQgfHwgZXZ0LAoJCQkJY2FudmFzID0gZXZ0LmN1cnJlbnRUYXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQsCgkJCQlib3VuZGluZ1JlY3QgPSBjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgoJCQlpZiAoZS50b3VjaGVzKXsKCQkJCW1vdXNlWCA9IGUudG91Y2hlc1swXS5jbGllbnRYIC0gYm91bmRpbmdSZWN0LmxlZnQ7CgkJCQltb3VzZVkgPSBlLnRvdWNoZXNbMF0uY2xpZW50WSAtIGJvdW5kaW5nUmVjdC50b3A7CgoJCQl9CgkJCWVsc2V7CgkJCQltb3VzZVggPSBlLmNsaWVudFggLSBib3VuZGluZ1JlY3QubGVmdDsKCQkJCW1vdXNlWSA9IGUuY2xpZW50WSAtIGJvdW5kaW5nUmVjdC50b3A7CgkJCX0KCgkJCXJldHVybiB7CgkJCQl4IDogbW91c2VYLAoJCQkJeSA6IG1vdXNlWQoJCQl9OwoKCQl9LAoJCWFkZEV2ZW50ID0gaGVscGVycy5hZGRFdmVudCA9IGZ1bmN0aW9uKG5vZGUsZXZlbnRUeXBlLG1ldGhvZCl7CgkJCWlmIChub2RlLmFkZEV2ZW50TGlzdGVuZXIpewoJCQkJbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSxtZXRob2QpOwoJCQl9IGVsc2UgaWYgKG5vZGUuYXR0YWNoRXZlbnQpewoJCQkJbm9kZS5hdHRhY2hFdmVudCgib24iK2V2ZW50VHlwZSwgbWV0aG9kKTsKCQkJfSBlbHNlIHsKCQkJCW5vZGVbIm9uIitldmVudFR5cGVdID0gbWV0aG9kOwoJCQl9CgkJfSwKCQlyZW1vdmVFdmVudCA9IGhlbHBlcnMucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbihub2RlLCBldmVudFR5cGUsIGhhbmRsZXIpewoJCQlpZiAobm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKXsKCQkJCW5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKCQkJfSBlbHNlIGlmIChub2RlLmRldGFjaEV2ZW50KXsKCQkJCW5vZGUuZGV0YWNoRXZlbnQoIm9uIitldmVudFR5cGUsaGFuZGxlcik7CgkJCX0gZWxzZXsKCQkJCW5vZGVbIm9uIiArIGV2ZW50VHlwZV0gPSBub29wOwoJCQl9CgkJfSwKCQliaW5kRXZlbnRzID0gaGVscGVycy5iaW5kRXZlbnRzID0gZnVuY3Rpb24oY2hhcnRJbnN0YW5jZSwgYXJyYXlPZkV2ZW50cywgaGFuZGxlcil7CgkJCS8vIENyZWF0ZSB0aGUgZXZlbnRzIG9iamVjdCBpZiBpdCdzIG5vdCBhbHJlYWR5IHByZXNlbnQKCQkJaWYgKCFjaGFydEluc3RhbmNlLmV2ZW50cykgY2hhcnRJbnN0YW5jZS5ldmVudHMgPSB7fTsKCgkJCWVhY2goYXJyYXlPZkV2ZW50cyxmdW5jdGlvbihldmVudE5hbWUpewoJCQkJY2hhcnRJbnN0YW5jZS5ldmVudHNbZXZlbnROYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCQkJaGFuZGxlci5hcHBseShjaGFydEluc3RhbmNlLCBhcmd1bWVudHMpOwoJCQkJfTsKCQkJCWFkZEV2ZW50KGNoYXJ0SW5zdGFuY2UuY2hhcnQuY2FudmFzLGV2ZW50TmFtZSxjaGFydEluc3RhbmNlLmV2ZW50c1tldmVudE5hbWVdKTsKCQkJfSk7CgkJfSwKCQl1bmJpbmRFdmVudHMgPSBoZWxwZXJzLnVuYmluZEV2ZW50cyA9IGZ1bmN0aW9uIChjaGFydEluc3RhbmNlLCBhcnJheU9mRXZlbnRzKSB7CgkJCWVhY2goYXJyYXlPZkV2ZW50cywgZnVuY3Rpb24oaGFuZGxlcixldmVudE5hbWUpewoJCQkJcmVtb3ZlRXZlbnQoY2hhcnRJbnN0YW5jZS5jaGFydC5jYW52YXMsIGV2ZW50TmFtZSwgaGFuZGxlcik7CgkJCX0pOwoJCX0sCgkJZ2V0TWF4aW11bVdpZHRoID0gaGVscGVycy5nZXRNYXhpbXVtV2lkdGggPSBmdW5jdGlvbihkb21Ob2RlKXsKCQkJdmFyIGNvbnRhaW5lciA9IGRvbU5vZGUucGFyZW50Tm9kZTsKCQkJLy8gVE9ETyA9IGNoZWNrIGNyb3NzIGJyb3dzZXIgc3R1ZmYgd2l0aCB0aGlzLgoJCQlyZXR1cm4gY29udGFpbmVyLmNsaWVudFdpZHRoOwoJCX0sCgkJZ2V0TWF4aW11bUhlaWdodCA9IGhlbHBlcnMuZ2V0TWF4aW11bUhlaWdodCA9IGZ1bmN0aW9uKGRvbU5vZGUpewoJCQl2YXIgY29udGFpbmVyID0gZG9tTm9kZS5wYXJlbnROb2RlOwoJCQkvLyBUT0RPID0gY2hlY2sgY3Jvc3MgYnJvd3NlciBzdHVmZiB3aXRoIHRoaXMuCgkJCXJldHVybiBjb250YWluZXIuY2xpZW50SGVpZ2h0OwoJCX0sCgkJZ2V0TWF4aW11bVNpemUgPSBoZWxwZXJzLmdldE1heGltdW1TaXplID0gaGVscGVycy5nZXRNYXhpbXVtV2lkdGgsIC8vIGxlZ2FjeSBzdXBwb3J0CgkJcmV0aW5hU2NhbGUgPSBoZWxwZXJzLnJldGluYVNjYWxlID0gZnVuY3Rpb24oY2hhcnQpewoJCQl2YXIgY3R4ID0gY2hhcnQuY3R4LAoJCQkJd2lkdGggPSBjaGFydC5jYW52YXMud2lkdGgsCgkJCQloZWlnaHQgPSBjaGFydC5jYW52YXMuaGVpZ2h0OwoKCQkJaWYgKHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKSB7CgkJCQljdHguY2FudmFzLnN0eWxlLndpZHRoID0gd2lkdGggKyAicHgiOwoJCQkJY3R4LmNhbnZhcy5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAicHgiOwoJCQkJY3R4LmNhbnZhcy5oZWlnaHQgPSBoZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbzsKCQkJCWN0eC5jYW52YXMud2lkdGggPSB3aWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwoJCQkJY3R4LnNjYWxlKHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvLCB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7CgkJCX0KCQl9LAoJCS8vLS0gQ2FudmFzIG1ldGhvZHMKCQljbGVhciA9IGhlbHBlcnMuY2xlYXIgPSBmdW5jdGlvbihjaGFydCl7CgkJCWNoYXJ0LmN0eC5jbGVhclJlY3QoMCwwLGNoYXJ0LndpZHRoLGNoYXJ0LmhlaWdodCk7CgkJfSwKCQlmb250U3RyaW5nID0gaGVscGVycy5mb250U3RyaW5nID0gZnVuY3Rpb24ocGl4ZWxTaXplLGZvbnRTdHlsZSxmb250RmFtaWx5KXsKCQkJcmV0dXJuIGZvbnRTdHlsZSArICIgIiArIHBpeGVsU2l6ZSsicHggIiArIGZvbnRGYW1pbHk7CgkJfSwKCQlsb25nZXN0VGV4dCA9IGhlbHBlcnMubG9uZ2VzdFRleHQgPSBmdW5jdGlvbihjdHgsZm9udCxhcnJheU9mU3RyaW5ncyl7CgkJCWN0eC5mb250ID0gZm9udDsKCQkJdmFyIGxvbmdlc3QgPSAwOwoJCQllYWNoKGFycmF5T2ZTdHJpbmdzLGZ1bmN0aW9uKHN0cmluZyl7CgkJCQl2YXIgdGV4dFdpZHRoID0gY3R4Lm1lYXN1cmVUZXh0KHN0cmluZykud2lkdGg7CgkJCQlsb25nZXN0ID0gKHRleHRXaWR0aCA+IGxvbmdlc3QpID8gdGV4dFdpZHRoIDogbG9uZ2VzdDsKCQkJfSk7CgkJCXJldHVybiBsb25nZXN0OwoJCX0sCgkJZHJhd1JvdW5kZWRSZWN0YW5nbGUgPSBoZWxwZXJzLmRyYXdSb3VuZGVkUmVjdGFuZ2xlID0gZnVuY3Rpb24oY3R4LHgseSx3aWR0aCxoZWlnaHQscmFkaXVzKXsKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQljdHgubW92ZVRvKHggKyByYWRpdXMsIHkpOwoJCQljdHgubGluZVRvKHggKyB3aWR0aCAtIHJhZGl1cywgeSk7CgkJCWN0eC5xdWFkcmF0aWNDdXJ2ZVRvKHggKyB3aWR0aCwgeSwgeCArIHdpZHRoLCB5ICsgcmFkaXVzKTsKCQkJY3R4LmxpbmVUbyh4ICsgd2lkdGgsIHkgKyBoZWlnaHQgLSByYWRpdXMpOwoJCQljdHgucXVhZHJhdGljQ3VydmVUbyh4ICsgd2lkdGgsIHkgKyBoZWlnaHQsIHggKyB3aWR0aCAtIHJhZGl1cywgeSArIGhlaWdodCk7CgkJCWN0eC5saW5lVG8oeCArIHJhZGl1cywgeSArIGhlaWdodCk7CgkJCWN0eC5xdWFkcmF0aWNDdXJ2ZVRvKHgsIHkgKyBoZWlnaHQsIHgsIHkgKyBoZWlnaHQgLSByYWRpdXMpOwoJCQljdHgubGluZVRvKHgsIHkgKyByYWRpdXMpOwoJCQljdHgucXVhZHJhdGljQ3VydmVUbyh4LCB5LCB4ICsgcmFkaXVzLCB5KTsKCQkJY3R4LmNsb3NlUGF0aCgpOwoJCX07CgoKCS8vU3RvcmUgYSByZWZlcmVuY2UgdG8gZWFjaCBpbnN0YW5jZSAtIGFsbG93aW5nIHVzIHRvIGdsb2JhbGx5IHJlc2l6ZSBjaGFydCBpbnN0YW5jZXMgb24gd2luZG93IHJlc2l6ZS4KCS8vRGVzdHJveSBtZXRob2Qgb24gdGhlIGNoYXJ0IHdpbGwgcmVtb3ZlIHRoZSBpbnN0YW5jZSBvZiB0aGUgY2hhcnQgZnJvbSB0aGlzIHJlZmVyZW5jZS4KCUNoYXJ0Lmluc3RhbmNlcyA9IHt9OwoKCUNoYXJ0LlR5cGUgPSBmdW5jdGlvbihkYXRhLG9wdGlvbnMsY2hhcnQpewoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5jaGFydCA9IGNoYXJ0OwoJCXRoaXMuaWQgPSB1aWQoKTsKCQkvL0FkZCB0aGUgY2hhcnQgaW5zdGFuY2UgdG8gdGhlIGdsb2JhbCBuYW1lc3BhY2UKCQlDaGFydC5pbnN0YW5jZXNbdGhpcy5pZF0gPSB0aGlzOwoKCQkvLyBJbml0aWFsaXplIGlzIGFsd2F5cyBjYWxsZWQgd2hlbiBhIGNoYXJ0IHR5cGUgaXMgY3JlYXRlZAoJCS8vIEJ5IGRlZmF1bHQgaXQgaXMgYSBubyBvcCwgYnV0IGl0IHNob3VsZCBiZSBleHRlbmRlZAoJCWlmIChvcHRpb25zLnJlc3BvbnNpdmUpewoJCQl0aGlzLnJlc2l6ZSgpOwoJCX0KCQl0aGlzLmluaXRpYWxpemUuY2FsbCh0aGlzLGRhdGEpOwoJfTsKCgkvL0NvcmUgbWV0aG9kcyB0aGF0J2xsIGJlIGEgcGFydCBvZiBldmVyeSBjaGFydCB0eXBlCglleHRlbmQoQ2hhcnQuVHlwZS5wcm90b3R5cGUsewoJCWluaXRpYWxpemUgOiBmdW5jdGlvbigpe3JldHVybiB0aGlzO30sCgkJY2xlYXIgOiBmdW5jdGlvbigpewoJCQljbGVhcih0aGlzLmNoYXJ0KTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQlzdG9wIDogZnVuY3Rpb24oKXsKCQkJLy8gU3RvcHMgYW55IGN1cnJlbnQgYW5pbWF0aW9uIGxvb3Agb2NjdXJpbmcKCQkJY2FuY2VsQW5pbUZyYW1lKHRoaXMuYW5pbWF0aW9uRnJhbWUpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCXJlc2l6ZSA6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKCQkJdGhpcy5zdG9wKCk7CgkJCXZhciBjYW52YXMgPSB0aGlzLmNoYXJ0LmNhbnZhcywKCQkJCW5ld1dpZHRoID0gZ2V0TWF4aW11bVdpZHRoKHRoaXMuY2hhcnQuY2FudmFzKSwKCQkJCW5ld0hlaWdodCA9IHRoaXMub3B0aW9ucy5tYWludGFpbkFzcGVjdFJhdGlvID8gbmV3V2lkdGggLyB0aGlzLmNoYXJ0LmFzcGVjdFJhdGlvIDogZ2V0TWF4aW11bUhlaWdodCh0aGlzLmNoYXJ0LmNhbnZhcyk7CgoJCQljYW52YXMud2lkdGggPSB0aGlzLmNoYXJ0LndpZHRoID0gbmV3V2lkdGg7CgkJCWNhbnZhcy5oZWlnaHQgPSB0aGlzLmNoYXJ0LmhlaWdodCA9IG5ld0hlaWdodDsKCgkJCXJldGluYVNjYWxlKHRoaXMuY2hhcnQpOwoKCQkJaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIil7CgkJCQljYWxsYmFjay5hcHBseSh0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCXJlZmxvdyA6IG5vb3AsCgkJcmVuZGVyIDogZnVuY3Rpb24ocmVmbG93KXsKCQkJaWYgKHJlZmxvdyl7CgkJCQl0aGlzLnJlZmxvdygpOwoJCQl9CgkJCWlmICh0aGlzLm9wdGlvbnMuYW5pbWF0aW9uICYmICFyZWZsb3cpewoJCQkJaGVscGVycy5hbmltYXRpb25Mb29wKAoJCQkJCXRoaXMuZHJhdywKCQkJCQl0aGlzLm9wdGlvbnMuYW5pbWF0aW9uU3RlcHMsCgkJCQkJdGhpcy5vcHRpb25zLmFuaW1hdGlvbkVhc2luZywKCQkJCQl0aGlzLm9wdGlvbnMub25BbmltYXRpb25Qcm9ncmVzcywKCQkJCQl0aGlzLm9wdGlvbnMub25BbmltYXRpb25Db21wbGV0ZSwKCQkJCQl0aGlzCgkJCQkpOwoJCQl9CgkJCWVsc2V7CgkJCQl0aGlzLmRyYXcoKTsKCQkJCXRoaXMub3B0aW9ucy5vbkFuaW1hdGlvbkNvbXBsZXRlLmNhbGwodGhpcyk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQlnZW5lcmF0ZUxlZ2VuZCA6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0ZW1wbGF0ZSh0aGlzLm9wdGlvbnMubGVnZW5kVGVtcGxhdGUsdGhpcyk7CgkJfSwKCQlkZXN0cm95IDogZnVuY3Rpb24oKXsKCQkJdGhpcy5jbGVhcigpOwoJCQl1bmJpbmRFdmVudHModGhpcywgdGhpcy5ldmVudHMpOwoJCQl2YXIgY2FudmFzID0gdGhpcy5jaGFydC5jYW52YXM7CgoJCQkvLyBSZXNldCBjYW52YXMgaGVpZ2h0L3dpZHRoIGF0dHJpYnV0ZXMgc3RhcnRzIGEgZnJlc2ggd2l0aCB0aGUgY2FudmFzIGNvbnRleHQKCQkJY2FudmFzLndpZHRoID0gdGhpcy5jaGFydC53aWR0aDsKCQkJY2FudmFzLmhlaWdodCA9IHRoaXMuY2hhcnQuaGVpZ2h0OwoKCQkJLy8gPCBJRTkgZG9lc24ndCBzdXBwb3J0IHJlbW92ZVByb3BlcnR5CgkJCWlmIChjYW52YXMuc3R5bGUucmVtb3ZlUHJvcGVydHkpIHsKCQkJCWNhbnZhcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgnd2lkdGgnKTsKCQkJCWNhbnZhcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgnaGVpZ2h0Jyk7CgkJCX0gZWxzZSB7CgkJCQljYW52YXMuc3R5bGUucmVtb3ZlQXR0cmlidXRlKCd3aWR0aCcpOwoJCQkJY2FudmFzLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSgnaGVpZ2h0Jyk7CgkJCX0KCgkJCWRlbGV0ZSBDaGFydC5pbnN0YW5jZXNbdGhpcy5pZF07CgkJfSwKCQlzaG93VG9vbHRpcCA6IGZ1bmN0aW9uKENoYXJ0RWxlbWVudHMsIGZvcmNlUmVkcmF3KXsKCQkJLy8gT25seSByZWRyYXcgdGhlIGNoYXJ0IGlmIHdlJ3ZlIGFjdHVhbGx5IGNoYW5nZWQgd2hhdCB3ZSdyZSBob3ZlcmluZyBvbi4KCQkJaWYgKHR5cGVvZiB0aGlzLmFjdGl2ZUVsZW1lbnRzID09PSAndW5kZWZpbmVkJykgdGhpcy5hY3RpdmVFbGVtZW50cyA9IFtdOwoKCQkJdmFyIGlzQ2hhbmdlZCA9IChmdW5jdGlvbihFbGVtZW50cyl7CgkJCQl2YXIgY2hhbmdlZCA9IGZhbHNlOwoKCQkJCWlmIChFbGVtZW50cy5sZW5ndGggIT09IHRoaXMuYWN0aXZlRWxlbWVudHMubGVuZ3RoKXsKCQkJCQljaGFuZ2VkID0gdHJ1ZTsKCQkJCQlyZXR1cm4gY2hhbmdlZDsKCQkJCX0KCgkJCQllYWNoKEVsZW1lbnRzLCBmdW5jdGlvbihlbGVtZW50LCBpbmRleCl7CgkJCQkJaWYgKGVsZW1lbnQgIT09IHRoaXMuYWN0aXZlRWxlbWVudHNbaW5kZXhdKXsKCQkJCQkJY2hhbmdlZCA9IHRydWU7CgkJCQkJfQoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gY2hhbmdlZDsKCQkJfSkuY2FsbCh0aGlzLCBDaGFydEVsZW1lbnRzKTsKCgkJCWlmICghaXNDaGFuZ2VkICYmICFmb3JjZVJlZHJhdyl7CgkJCQlyZXR1cm47CgkJCX0KCQkJZWxzZXsKCQkJCXRoaXMuYWN0aXZlRWxlbWVudHMgPSBDaGFydEVsZW1lbnRzOwoJCQl9CgkJCXRoaXMuZHJhdygpOwoJCQlpZih0aGlzLm9wdGlvbnMuY3VzdG9tVG9vbHRpcHMpewoJCQkJdGhpcy5vcHRpb25zLmN1c3RvbVRvb2x0aXBzKGZhbHNlKTsKCQkJfQoJCQlpZiAoQ2hhcnRFbGVtZW50cy5sZW5ndGggPiAwKXsKCQkJCS8vIElmIHdlIGhhdmUgbXVsdGlwbGUgZGF0YXNldHMsIHNob3cgYSBNdWx0aVRvb2x0aXAgZm9yIGFsbCBvZiB0aGUgZGF0YSBwb2ludHMgYXQgdGhhdCBpbmRleAoJCQkJaWYgKHRoaXMuZGF0YXNldHMgJiYgdGhpcy5kYXRhc2V0cy5sZW5ndGggPiAxKSB7CgkJCQkJdmFyIGRhdGFBcnJheSwKCQkJCQkJZGF0YUluZGV4OwoKCQkJCQlmb3IgKHZhciBpID0gdGhpcy5kYXRhc2V0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJCQkJCQlkYXRhQXJyYXkgPSB0aGlzLmRhdGFzZXRzW2ldLnBvaW50cyB8fCB0aGlzLmRhdGFzZXRzW2ldLmJhcnMgfHwgdGhpcy5kYXRhc2V0c1tpXS5zZWdtZW50czsKCQkJCQkJZGF0YUluZGV4ID0gaW5kZXhPZihkYXRhQXJyYXksIENoYXJ0RWxlbWVudHNbMF0pOwoJCQkJCQlpZiAoZGF0YUluZGV4ICE9PSAtMSl7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQl2YXIgdG9vbHRpcExhYmVscyA9IFtdLAoJCQkJCQl0b29sdGlwQ29sb3JzID0gW10sCgkJCQkJCW1lZGlhblBvc2l0aW9uID0gKGZ1bmN0aW9uKGluZGV4KSB7CgoJCQkJCQkJLy8gR2V0IGFsbCB0aGUgcG9pbnRzIGF0IHRoYXQgcGFydGljdWxhciBpbmRleAoJCQkJCQkJdmFyIEVsZW1lbnRzID0gW10sCgkJCQkJCQkJZGF0YUNvbGxlY3Rpb24sCgkJCQkJCQkJeFBvc2l0aW9ucyA9IFtdLAoJCQkJCQkJCXlQb3NpdGlvbnMgPSBbXSwKCQkJCQkJCQl4TWF4LAoJCQkJCQkJCXlNYXgsCgkJCQkJCQkJeE1pbiwKCQkJCQkJCQl5TWluOwoJCQkJCQkJaGVscGVycy5lYWNoKHRoaXMuZGF0YXNldHMsIGZ1bmN0aW9uKGRhdGFzZXQpewoJCQkJCQkJCWRhdGFDb2xsZWN0aW9uID0gZGF0YXNldC5wb2ludHMgfHwgZGF0YXNldC5iYXJzIHx8IGRhdGFzZXQuc2VnbWVudHM7CgkJCQkJCQkJaWYgKGRhdGFDb2xsZWN0aW9uW2RhdGFJbmRleF0gJiYgZGF0YUNvbGxlY3Rpb25bZGF0YUluZGV4XS5oYXNWYWx1ZSgpKXsKCQkJCQkJCQkJRWxlbWVudHMucHVzaChkYXRhQ29sbGVjdGlvbltkYXRhSW5kZXhdKTsKCQkJCQkJCQl9CgkJCQkJCQl9KTsKCgkJCQkJCQloZWxwZXJzLmVhY2goRWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQkJCQkJCQl4UG9zaXRpb25zLnB1c2goZWxlbWVudC54KTsKCQkJCQkJCQl5UG9zaXRpb25zLnB1c2goZWxlbWVudC55KTsKCgoJCQkJCQkJCS8vSW5jbHVkZSBhbnkgY29sb3VyIGluZm9ybWF0aW9uIGFib3V0IHRoZSBlbGVtZW50CgkJCQkJCQkJdG9vbHRpcExhYmVscy5wdXNoKGhlbHBlcnMudGVtcGxhdGUodGhpcy5vcHRpb25zLm11bHRpVG9vbHRpcFRlbXBsYXRlLCBlbGVtZW50KSk7CgkJCQkJCQkJdG9vbHRpcENvbG9ycy5wdXNoKHsKCQkJCQkJCQkJZmlsbDogZWxlbWVudC5fc2F2ZWQuZmlsbENvbG9yIHx8IGVsZW1lbnQuZmlsbENvbG9yLAoJCQkJCQkJCQlzdHJva2U6IGVsZW1lbnQuX3NhdmVkLnN0cm9rZUNvbG9yIHx8IGVsZW1lbnQuc3Ryb2tlQ29sb3IKCQkJCQkJCQl9KTsKCgkJCQkJCQl9LCB0aGlzKTsKCgkJCQkJCQl5TWluID0gbWluKHlQb3NpdGlvbnMpOwoJCQkJCQkJeU1heCA9IG1heCh5UG9zaXRpb25zKTsKCgkJCQkJCQl4TWluID0gbWluKHhQb3NpdGlvbnMpOwoJCQkJCQkJeE1heCA9IG1heCh4UG9zaXRpb25zKTsKCgkJCQkJCQlyZXR1cm4gewoJCQkJCQkJCXg6ICh4TWluID4gdGhpcy5jaGFydC53aWR0aC8yKSA/IHhNaW4gOiB4TWF4LAoJCQkJCQkJCXk6ICh5TWluICsgeU1heCkvMgoJCQkJCQkJfTsKCQkJCQkJfSkuY2FsbCh0aGlzLCBkYXRhSW5kZXgpOwoKCQkJCQluZXcgQ2hhcnQuTXVsdGlUb29sdGlwKHsKCQkJCQkJeDogbWVkaWFuUG9zaXRpb24ueCwKCQkJCQkJeTogbWVkaWFuUG9zaXRpb24ueSwKCQkJCQkJeFBhZGRpbmc6IHRoaXMub3B0aW9ucy50b29sdGlwWFBhZGRpbmcsCgkJCQkJCXlQYWRkaW5nOiB0aGlzLm9wdGlvbnMudG9vbHRpcFlQYWRkaW5nLAoJCQkJCQl4T2Zmc2V0OiB0aGlzLm9wdGlvbnMudG9vbHRpcFhPZmZzZXQsCgkJCQkJCWZpbGxDb2xvcjogdGhpcy5vcHRpb25zLnRvb2x0aXBGaWxsQ29sb3IsCgkJCQkJCXRleHRDb2xvcjogdGhpcy5vcHRpb25zLnRvb2x0aXBGb250Q29sb3IsCgkJCQkJCWZvbnRGYW1pbHk6IHRoaXMub3B0aW9ucy50b29sdGlwRm9udEZhbWlseSwKCQkJCQkJZm9udFN0eWxlOiB0aGlzLm9wdGlvbnMudG9vbHRpcEZvbnRTdHlsZSwKCQkJCQkJZm9udFNpemU6IHRoaXMub3B0aW9ucy50b29sdGlwRm9udFNpemUsCgkJCQkJCXRpdGxlVGV4dENvbG9yOiB0aGlzLm9wdGlvbnMudG9vbHRpcFRpdGxlRm9udENvbG9yLAoJCQkJCQl0aXRsZUZvbnRGYW1pbHk6IHRoaXMub3B0aW9ucy50b29sdGlwVGl0bGVGb250RmFtaWx5LAoJCQkJCQl0aXRsZUZvbnRTdHlsZTogdGhpcy5vcHRpb25zLnRvb2x0aXBUaXRsZUZvbnRTdHlsZSwKCQkJCQkJdGl0bGVGb250U2l6ZTogdGhpcy5vcHRpb25zLnRvb2x0aXBUaXRsZUZvbnRTaXplLAoJCQkJCQljb3JuZXJSYWRpdXM6IHRoaXMub3B0aW9ucy50b29sdGlwQ29ybmVyUmFkaXVzLAoJCQkJCQlsYWJlbHM6IHRvb2x0aXBMYWJlbHMsCgkJCQkJCWxlZ2VuZENvbG9yczogdG9vbHRpcENvbG9ycywKCQkJCQkJbGVnZW5kQ29sb3JCYWNrZ3JvdW5kIDogdGhpcy5vcHRpb25zLm11bHRpVG9vbHRpcEtleUJhY2tncm91bmQsCgkJCQkJCXRpdGxlOiBDaGFydEVsZW1lbnRzWzBdLmxhYmVsLAoJCQkJCQljaGFydDogdGhpcy5jaGFydCwKCQkJCQkJY3R4OiB0aGlzLmNoYXJ0LmN0eCwKCQkJCQkJY3VzdG9tOiB0aGlzLm9wdGlvbnMuY3VzdG9tVG9vbHRpcHMKCQkJCQl9KS5kcmF3KCk7CgoJCQkJfSBlbHNlIHsKCQkJCQllYWNoKENoYXJ0RWxlbWVudHMsIGZ1bmN0aW9uKEVsZW1lbnQpIHsKCQkJCQkJdmFyIHRvb2x0aXBQb3NpdGlvbiA9IEVsZW1lbnQudG9vbHRpcFBvc2l0aW9uKCk7CgkJCQkJCW5ldyBDaGFydC5Ub29sdGlwKHsKCQkJCQkJCXg6IE1hdGgucm91bmQodG9vbHRpcFBvc2l0aW9uLngpLAoJCQkJCQkJeTogTWF0aC5yb3VuZCh0b29sdGlwUG9zaXRpb24ueSksCgkJCQkJCQl4UGFkZGluZzogdGhpcy5vcHRpb25zLnRvb2x0aXBYUGFkZGluZywKCQkJCQkJCXlQYWRkaW5nOiB0aGlzLm9wdGlvbnMudG9vbHRpcFlQYWRkaW5nLAoJCQkJCQkJZmlsbENvbG9yOiB0aGlzLm9wdGlvbnMudG9vbHRpcEZpbGxDb2xvciwKCQkJCQkJCXRleHRDb2xvcjogdGhpcy5vcHRpb25zLnRvb2x0aXBGb250Q29sb3IsCgkJCQkJCQlmb250RmFtaWx5OiB0aGlzLm9wdGlvbnMudG9vbHRpcEZvbnRGYW1pbHksCgkJCQkJCQlmb250U3R5bGU6IHRoaXMub3B0aW9ucy50b29sdGlwRm9udFN0eWxlLAoJCQkJCQkJZm9udFNpemU6IHRoaXMub3B0aW9ucy50b29sdGlwRm9udFNpemUsCgkJCQkJCQljYXJldEhlaWdodDogdGhpcy5vcHRpb25zLnRvb2x0aXBDYXJldFNpemUsCgkJCQkJCQljb3JuZXJSYWRpdXM6IHRoaXMub3B0aW9ucy50b29sdGlwQ29ybmVyUmFkaXVzLAoJCQkJCQkJdGV4dDogdGVtcGxhdGUodGhpcy5vcHRpb25zLnRvb2x0aXBUZW1wbGF0ZSwgRWxlbWVudCksCgkJCQkJCQljaGFydDogdGhpcy5jaGFydCwKCQkJCQkJCWN1c3RvbTogdGhpcy5vcHRpb25zLmN1c3RvbVRvb2x0aXBzCgkJCQkJCX0pLmRyYXcoKTsKCQkJCQl9LCB0aGlzKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCXRvQmFzZTY0SW1hZ2UgOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy5jaGFydC5jYW52YXMudG9EYXRhVVJMLmFwcGx5KHRoaXMuY2hhcnQuY2FudmFzLCBhcmd1bWVudHMpOwoJCX0KCX0pOwoKCUNoYXJ0LlR5cGUuZXh0ZW5kID0gZnVuY3Rpb24oZXh0ZW5zaW9ucyl7CgoJCXZhciBwYXJlbnQgPSB0aGlzOwoKCQl2YXIgQ2hhcnRUeXBlID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLGFyZ3VtZW50cyk7CgkJfTsKCgkJLy9Db3B5IHRoZSBwcm90b3R5cGUgb2JqZWN0IG9mIHRoZSB0aGlzIGNsYXNzCgkJQ2hhcnRUeXBlLnByb3RvdHlwZSA9IGNsb25lKHBhcmVudC5wcm90b3R5cGUpOwoJCS8vTm93IG92ZXJ3cml0ZSBzb21lIG9mIHRoZSBwcm9wZXJ0aWVzIGluIHRoZSBiYXNlIGNsYXNzIHdpdGggdGhlIG5ldyBleHRlbnNpb25zCgkJZXh0ZW5kKENoYXJ0VHlwZS5wcm90b3R5cGUsIGV4dGVuc2lvbnMpOwoKCQlDaGFydFR5cGUuZXh0ZW5kID0gQ2hhcnQuVHlwZS5leHRlbmQ7CgoJCWlmIChleHRlbnNpb25zLm5hbWUgfHwgcGFyZW50LnByb3RvdHlwZS5uYW1lKXsKCgkJCXZhciBjaGFydE5hbWUgPSBleHRlbnNpb25zLm5hbWUgfHwgcGFyZW50LnByb3RvdHlwZS5uYW1lOwoJCQkvL0Fzc2lnbiBhbnkgcG90ZW50aWFsIGRlZmF1bHQgdmFsdWVzIG9mIHRoZSBuZXcgY2hhcnQgdHlwZQoKCQkJLy9JZiBub25lIGFyZSBkZWZpbmVkLCB3ZSdsbCB1c2UgYSBjbG9uZSBvZiB0aGUgY2hhcnQgdHlwZSB0aGlzIGlzIGJlaW5nIGV4dGVuZGVkIGZyb20uCgkJCS8vSS5lLiBpZiB3ZSBleHRlbmQgYSBsaW5lIGNoYXJ0LCB3ZSdsbCB1c2UgdGhlIGRlZmF1bHRzIGZyb20gdGhlIGxpbmUgY2hhcnQgaWYgb3VyIG5ldyBjaGFydAoJCQkvL2RvZXNuJ3QgZGVmaW5lIHNvbWUgZGVmYXVsdHMgb2YgdGhlaXIgb3duLgoKCQkJdmFyIGJhc2VEZWZhdWx0cyA9IChDaGFydC5kZWZhdWx0c1twYXJlbnQucHJvdG90eXBlLm5hbWVdKSA/IGNsb25lKENoYXJ0LmRlZmF1bHRzW3BhcmVudC5wcm90b3R5cGUubmFtZV0pIDoge307CgoJCQlDaGFydC5kZWZhdWx0c1tjaGFydE5hbWVdID0gZXh0ZW5kKGJhc2VEZWZhdWx0cyxleHRlbnNpb25zLmRlZmF1bHRzKTsKCgkJCUNoYXJ0LnR5cGVzW2NoYXJ0TmFtZV0gPSBDaGFydFR5cGU7CgoJCQkvL1JlZ2lzdGVyIHRoaXMgbmV3IGNoYXJ0IHR5cGUgaW4gdGhlIENoYXJ0IHByb3RvdHlwZQoJCQlDaGFydC5wcm90b3R5cGVbY2hhcnROYW1lXSA9IGZ1bmN0aW9uKGRhdGEsb3B0aW9ucyl7CgkJCQl2YXIgY29uZmlnID0gbWVyZ2UoQ2hhcnQuZGVmYXVsdHMuZ2xvYmFsLCBDaGFydC5kZWZhdWx0c1tjaGFydE5hbWVdLCBvcHRpb25zIHx8IHt9KTsKCQkJCXJldHVybiBuZXcgQ2hhcnRUeXBlKGRhdGEsY29uZmlnLHRoaXMpOwoJCQl9OwoJCX0gZWxzZXsKCQkJd2FybigiTmFtZSBub3QgcHJvdmlkZWQgZm9yIHRoaXMgY2hhcnQsIHNvIGl0IGhhc24ndCBiZWVuIHJlZ2lzdGVyZWQiKTsKCQl9CgkJcmV0dXJuIHBhcmVudDsKCX07CgoJQ2hhcnQuRWxlbWVudCA9IGZ1bmN0aW9uKGNvbmZpZ3VyYXRpb24pewoJCWV4dGVuZCh0aGlzLGNvbmZpZ3VyYXRpb24pOwoJCXRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLGFyZ3VtZW50cyk7CgkJdGhpcy5zYXZlKCk7Cgl9OwoJZXh0ZW5kKENoYXJ0LkVsZW1lbnQucHJvdG90eXBlLHsKCQlpbml0aWFsaXplIDogZnVuY3Rpb24oKXt9LAoJCXJlc3RvcmUgOiBmdW5jdGlvbihwcm9wcyl7CgkJCWlmICghcHJvcHMpewoJCQkJZXh0ZW5kKHRoaXMsdGhpcy5fc2F2ZWQpOwoJCQl9IGVsc2UgewoJCQkJZWFjaChwcm9wcyxmdW5jdGlvbihrZXkpewoJCQkJCXRoaXNba2V5XSA9IHRoaXMuX3NhdmVkW2tleV07CgkJCQl9LHRoaXMpOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgkJc2F2ZSA6IGZ1bmN0aW9uKCl7CgkJCXRoaXMuX3NhdmVkID0gY2xvbmUodGhpcyk7CgkJCWRlbGV0ZSB0aGlzLl9zYXZlZC5fc2F2ZWQ7CgkJCXJldHVybiB0aGlzOwoJCX0sCgkJdXBkYXRlIDogZnVuY3Rpb24obmV3UHJvcHMpewoJCQllYWNoKG5ld1Byb3BzLGZ1bmN0aW9uKHZhbHVlLGtleSl7CgkJCQl0aGlzLl9zYXZlZFtrZXldID0gdGhpc1trZXldOwoJCQkJdGhpc1trZXldID0gdmFsdWU7CgkJCX0sdGhpcyk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgkJdHJhbnNpdGlvbiA6IGZ1bmN0aW9uKHByb3BzLGVhc2UpewoJCQllYWNoKHByb3BzLGZ1bmN0aW9uKHZhbHVlLGtleSl7CgkJCQl0aGlzW2tleV0gPSAoKHZhbHVlIC0gdGhpcy5fc2F2ZWRba2V5XSkgKiBlYXNlKSArIHRoaXMuX3NhdmVkW2tleV07CgkJCX0sdGhpcyk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgkJdG9vbHRpcFBvc2l0aW9uIDogZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHsKCQkJCXggOiB0aGlzLngsCgkJCQl5IDogdGhpcy55CgkJCX07CgkJfSwKCQloYXNWYWx1ZTogZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGlzTnVtYmVyKHRoaXMudmFsdWUpOwoJCX0KCX0pOwoKCUNoYXJ0LkVsZW1lbnQuZXh0ZW5kID0gaW5oZXJpdHM7CgoKCUNoYXJ0LlBvaW50ID0gQ2hhcnQuRWxlbWVudC5leHRlbmQoewoJCWRpc3BsYXk6IHRydWUsCgkJaW5SYW5nZTogZnVuY3Rpb24oY2hhcnRYLGNoYXJ0WSl7CgkJCXZhciBoaXREZXRlY3Rpb25SYW5nZSA9IHRoaXMuaGl0RGV0ZWN0aW9uUmFkaXVzICsgdGhpcy5yYWRpdXM7CgkJCXJldHVybiAoKE1hdGgucG93KGNoYXJ0WC10aGlzLngsIDIpK01hdGgucG93KGNoYXJ0WS10aGlzLnksIDIpKSA8IE1hdGgucG93KGhpdERldGVjdGlvblJhbmdlLDIpKTsKCQl9LAoJCWRyYXcgOiBmdW5jdGlvbigpewoJCQlpZiAodGhpcy5kaXNwbGF5KXsKCQkJCXZhciBjdHggPSB0aGlzLmN0eDsKCQkJCWN0eC5iZWdpblBhdGgoKTsKCgkJCQljdHguYXJjKHRoaXMueCwgdGhpcy55LCB0aGlzLnJhZGl1cywgMCwgTWF0aC5QSSoyKTsKCQkJCWN0eC5jbG9zZVBhdGgoKTsKCgkJCQljdHguc3Ryb2tlU3R5bGUgPSB0aGlzLnN0cm9rZUNvbG9yOwoJCQkJY3R4LmxpbmVXaWR0aCA9IHRoaXMuc3Ryb2tlV2lkdGg7CgoJCQkJY3R4LmZpbGxTdHlsZSA9IHRoaXMuZmlsbENvbG9yOwoKCQkJCWN0eC5maWxsKCk7CgkJCQljdHguc3Ryb2tlKCk7CgkJCX0KCgoJCQkvL1F1aWNrIGRlYnVnIGZvciBiZXppZXIgY3VydmUgc3BsaW5pbmcKCQkJLy9IaWdobGlnaHRzIGNvbnRyb2wgcG9pbnRzIGFuZCB0aGUgbGluZSBiZXR3ZWVuIHRoZW0uCgkJCS8vSGFuZHkgZm9yIGRldiAtIHN0cmlwcGVkIGluIHRoZSBtaW4gdmVyc2lvbi4KCgkJCS8vIGN0eC5zYXZlKCk7CgkJCS8vIGN0eC5maWxsU3R5bGUgPSAiYmxhY2siOwoJCQkvLyBjdHguc3Ryb2tlU3R5bGUgPSAiYmxhY2siCgkJCS8vIGN0eC5iZWdpblBhdGgoKTsKCQkJLy8gY3R4LmFyYyh0aGlzLmNvbnRyb2xQb2ludHMuaW5uZXIueCx0aGlzLmNvbnRyb2xQb2ludHMuaW5uZXIueSwgMiwgMCwgTWF0aC5QSSoyKTsKCQkJLy8gY3R4LmZpbGwoKTsKCgkJCS8vIGN0eC5iZWdpblBhdGgoKTsKCQkJLy8gY3R4LmFyYyh0aGlzLmNvbnRyb2xQb2ludHMub3V0ZXIueCx0aGlzLmNvbnRyb2xQb2ludHMub3V0ZXIueSwgMiwgMCwgTWF0aC5QSSoyKTsKCQkJLy8gY3R4LmZpbGwoKTsKCgkJCS8vIGN0eC5tb3ZlVG8odGhpcy5jb250cm9sUG9pbnRzLmlubmVyLngsdGhpcy5jb250cm9sUG9pbnRzLmlubmVyLnkpOwoJCQkvLyBjdHgubGluZVRvKHRoaXMueCwgdGhpcy55KTsKCQkJLy8gY3R4LmxpbmVUbyh0aGlzLmNvbnRyb2xQb2ludHMub3V0ZXIueCx0aGlzLmNvbnRyb2xQb2ludHMub3V0ZXIueSk7CgkJCS8vIGN0eC5zdHJva2UoKTsKCgkJCS8vIGN0eC5yZXN0b3JlKCk7CgoKCgkJfQoJfSk7CgoJQ2hhcnQuQXJjID0gQ2hhcnQuRWxlbWVudC5leHRlbmQoewoJCWluUmFuZ2UgOiBmdW5jdGlvbihjaGFydFgsY2hhcnRZKXsKCgkJCXZhciBwb2ludFJlbGF0aXZlUG9zaXRpb24gPSBoZWxwZXJzLmdldEFuZ2xlRnJvbVBvaW50KHRoaXMsIHsKCQkJCXg6IGNoYXJ0WCwKCQkJCXk6IGNoYXJ0WQoJCQl9KTsKCgkJCS8vQ2hlY2sgaWYgd2l0aGluIHRoZSByYW5nZSBvZiB0aGUgb3Blbi9jbG9zZSBhbmdsZQoJCQl2YXIgYmV0d2VlbkFuZ2xlcyA9IChwb2ludFJlbGF0aXZlUG9zaXRpb24uYW5nbGUgPj0gdGhpcy5zdGFydEFuZ2xlICYmIHBvaW50UmVsYXRpdmVQb3NpdGlvbi5hbmdsZSA8PSB0aGlzLmVuZEFuZ2xlKSwKCQkJCXdpdGhpblJhZGl1cyA9IChwb2ludFJlbGF0aXZlUG9zaXRpb24uZGlzdGFuY2UgPj0gdGhpcy5pbm5lclJhZGl1cyAmJiBwb2ludFJlbGF0aXZlUG9zaXRpb24uZGlzdGFuY2UgPD0gdGhpcy5vdXRlclJhZGl1cyk7CgoJCQlyZXR1cm4gKGJldHdlZW5BbmdsZXMgJiYgd2l0aGluUmFkaXVzKTsKCQkJLy9FbnN1cmUgd2l0aGluIHRoZSBvdXRzaWRlIG9mIHRoZSBhcmMgY2VudHJlLCBidXQgaW5zaWRlIGFyYyBvdXRlcgoJCX0sCgkJdG9vbHRpcFBvc2l0aW9uIDogZnVuY3Rpb24oKXsKCQkJdmFyIGNlbnRyZUFuZ2xlID0gdGhpcy5zdGFydEFuZ2xlICsgKCh0aGlzLmVuZEFuZ2xlIC0gdGhpcy5zdGFydEFuZ2xlKSAvIDIpLAoJCQkJcmFuZ2VGcm9tQ2VudHJlID0gKHRoaXMub3V0ZXJSYWRpdXMgLSB0aGlzLmlubmVyUmFkaXVzKSAvIDIgKyB0aGlzLmlubmVyUmFkaXVzOwoJCQlyZXR1cm4gewoJCQkJeCA6IHRoaXMueCArIChNYXRoLmNvcyhjZW50cmVBbmdsZSkgKiByYW5nZUZyb21DZW50cmUpLAoJCQkJeSA6IHRoaXMueSArIChNYXRoLnNpbihjZW50cmVBbmdsZSkgKiByYW5nZUZyb21DZW50cmUpCgkJCX07CgkJfSwKCQlkcmF3IDogZnVuY3Rpb24oYW5pbWF0aW9uUGVyY2VudCl7CgoJCQl2YXIgZWFzaW5nRGVjaW1hbCA9IGFuaW1hdGlvblBlcmNlbnQgfHwgMTsKCgkJCXZhciBjdHggPSB0aGlzLmN0eDsKCgkJCWN0eC5iZWdpblBhdGgoKTsKCgkJCWN0eC5hcmModGhpcy54LCB0aGlzLnksIHRoaXMub3V0ZXJSYWRpdXMsIHRoaXMuc3RhcnRBbmdsZSwgdGhpcy5lbmRBbmdsZSk7CgoJCQljdHguYXJjKHRoaXMueCwgdGhpcy55LCB0aGlzLmlubmVyUmFkaXVzLCB0aGlzLmVuZEFuZ2xlLCB0aGlzLnN0YXJ0QW5nbGUsIHRydWUpOwoKCQkJY3R4LmNsb3NlUGF0aCgpOwoJCQljdHguc3Ryb2tlU3R5bGUgPSB0aGlzLnN0cm9rZUNvbG9yOwoJCQljdHgubGluZVdpZHRoID0gdGhpcy5zdHJva2VXaWR0aDsKCgkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLmZpbGxDb2xvcjsKCgkJCWN0eC5maWxsKCk7CgkJCWN0eC5saW5lSm9pbiA9ICdiZXZlbCc7CgoJCQlpZiAodGhpcy5zaG93U3Ryb2tlKXsKCQkJCWN0eC5zdHJva2UoKTsKCQkJfQoJCX0KCX0pOwoKCUNoYXJ0LlJlY3RhbmdsZSA9IENoYXJ0LkVsZW1lbnQuZXh0ZW5kKHsKCQlkcmF3IDogZnVuY3Rpb24oKXsKCQkJdmFyIGN0eCA9IHRoaXMuY3R4LAoJCQkJaGFsZldpZHRoID0gdGhpcy53aWR0aC8yLAoJCQkJbGVmdFggPSB0aGlzLnggLSBoYWxmV2lkdGgsCgkJCQlyaWdodFggPSB0aGlzLnggKyBoYWxmV2lkdGgsCgkJCQl0b3AgPSB0aGlzLmJhc2UgLSAodGhpcy5iYXNlIC0gdGhpcy55KSwKCQkJCWhhbGZTdHJva2UgPSB0aGlzLnN0cm9rZVdpZHRoIC8gMjsKCgkJCS8vIENhbnZhcyBkb2Vzbid0IGFsbG93IHVzIHRvIHN0cm9rZSBpbnNpZGUgdGhlIHdpZHRoIHNvIHdlIGNhbgoJCQkvLyBhZGp1c3QgdGhlIHNpemVzIHRvIGZpdCBpZiB3ZSdyZSBzZXR0aW5nIGEgc3Ryb2tlIG9uIHRoZSBsaW5lCgkJCWlmICh0aGlzLnNob3dTdHJva2UpewoJCQkJbGVmdFggKz0gaGFsZlN0cm9rZTsKCQkJCXJpZ2h0WCAtPSBoYWxmU3Ryb2tlOwoJCQkJdG9wICs9IGhhbGZTdHJva2U7CgkJCX0KCgkJCWN0eC5iZWdpblBhdGgoKTsKCgkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLmZpbGxDb2xvcjsKCQkJY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5zdHJva2VDb2xvcjsKCQkJY3R4LmxpbmVXaWR0aCA9IHRoaXMuc3Ryb2tlV2lkdGg7CgoJCQkvLyBJdCdkIGJlIG5pY2UgdG8ga2VlcCB0aGlzIGNsYXNzIHRvdGFsbHkgZ2VuZXJpYyB0byBhbnkgcmVjdGFuZ2xlCgkJCS8vIGFuZCBzaW1wbHkgc3BlY2lmeSB3aGljaCBib3JkZXIgdG8gbWlzcyBvdXQuCgkJCWN0eC5tb3ZlVG8obGVmdFgsIHRoaXMuYmFzZSk7CgkJCWN0eC5saW5lVG8obGVmdFgsIHRvcCk7CgkJCWN0eC5saW5lVG8ocmlnaHRYLCB0b3ApOwoJCQljdHgubGluZVRvKHJpZ2h0WCwgdGhpcy5iYXNlKTsKCQkJY3R4LmZpbGwoKTsKCQkJaWYgKHRoaXMuc2hvd1N0cm9rZSl7CgkJCQljdHguc3Ryb2tlKCk7CgkJCX0KCQl9LAoJCWhlaWdodCA6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLmJhc2UgLSB0aGlzLnk7CgkJfSwKCQlpblJhbmdlIDogZnVuY3Rpb24oY2hhcnRYLGNoYXJ0WSl7CgkJCXJldHVybiAoY2hhcnRYID49IHRoaXMueCAtIHRoaXMud2lkdGgvMiAmJiBjaGFydFggPD0gdGhpcy54ICsgdGhpcy53aWR0aC8yKSAmJiAoY2hhcnRZID49IHRoaXMueSAmJiBjaGFydFkgPD0gdGhpcy5iYXNlKTsKCQl9Cgl9KTsKCglDaGFydC5Ub29sdGlwID0gQ2hhcnQuRWxlbWVudC5leHRlbmQoewoJCWRyYXcgOiBmdW5jdGlvbigpewoKCQkJdmFyIGN0eCA9IHRoaXMuY2hhcnQuY3R4OwoKCQkJY3R4LmZvbnQgPSBmb250U3RyaW5nKHRoaXMuZm9udFNpemUsdGhpcy5mb250U3R5bGUsdGhpcy5mb250RmFtaWx5KTsKCgkJCXRoaXMueEFsaWduID0gImNlbnRlciI7CgkJCXRoaXMueUFsaWduID0gImFib3ZlIjsKCgkJCS8vRGlzdGFuY2UgYmV0d2VlbiB0aGUgYWN0dWFsIGVsZW1lbnQueSBwb3NpdGlvbiBhbmQgdGhlIHN0YXJ0IG9mIHRoZSB0b29sdGlwIGNhcmV0CgkJCXZhciBjYXJldFBhZGRpbmcgPSB0aGlzLmNhcmV0UGFkZGluZyA9IDI7CgoJCQl2YXIgdG9vbHRpcFdpZHRoID0gY3R4Lm1lYXN1cmVUZXh0KHRoaXMudGV4dCkud2lkdGggKyAyKnRoaXMueFBhZGRpbmcsCgkJCQl0b29sdGlwUmVjdEhlaWdodCA9IHRoaXMuZm9udFNpemUgKyAyKnRoaXMueVBhZGRpbmcsCgkJCQl0b29sdGlwSGVpZ2h0ID0gdG9vbHRpcFJlY3RIZWlnaHQgKyB0aGlzLmNhcmV0SGVpZ2h0ICsgY2FyZXRQYWRkaW5nOwoKCQkJaWYgKHRoaXMueCArIHRvb2x0aXBXaWR0aC8yID50aGlzLmNoYXJ0LndpZHRoKXsKCQkJCXRoaXMueEFsaWduID0gImxlZnQiOwoJCQl9IGVsc2UgaWYgKHRoaXMueCAtIHRvb2x0aXBXaWR0aC8yIDwgMCl7CgkJCQl0aGlzLnhBbGlnbiA9ICJyaWdodCI7CgkJCX0KCgkJCWlmICh0aGlzLnkgLSB0b29sdGlwSGVpZ2h0IDwgMCl7CgkJCQl0aGlzLnlBbGlnbiA9ICJiZWxvdyI7CgkJCX0KCgoJCQl2YXIgdG9vbHRpcFggPSB0aGlzLnggLSB0b29sdGlwV2lkdGgvMiwKCQkJCXRvb2x0aXBZID0gdGhpcy55IC0gdG9vbHRpcEhlaWdodDsKCgkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLmZpbGxDb2xvcjsKCgkJCS8vIEN1c3RvbSBUb29sdGlwcwoJCQlpZih0aGlzLmN1c3RvbSl7CgkJCQl0aGlzLmN1c3RvbSh0aGlzKTsKCQkJfQoJCQllbHNlewoJCQkJc3dpdGNoKHRoaXMueUFsaWduKQoJCQkJewoJCQkJY2FzZSAiYWJvdmUiOgoJCQkJCS8vRHJhdyBhIGNhcmV0IGFib3ZlIHRoZSB4L3kKCQkJCQljdHguYmVnaW5QYXRoKCk7CgkJCQkJY3R4Lm1vdmVUbyh0aGlzLngsdGhpcy55IC0gY2FyZXRQYWRkaW5nKTsKCQkJCQljdHgubGluZVRvKHRoaXMueCArIHRoaXMuY2FyZXRIZWlnaHQsIHRoaXMueSAtIChjYXJldFBhZGRpbmcgKyB0aGlzLmNhcmV0SGVpZ2h0KSk7CgkJCQkJY3R4LmxpbmVUbyh0aGlzLnggLSB0aGlzLmNhcmV0SGVpZ2h0LCB0aGlzLnkgLSAoY2FyZXRQYWRkaW5nICsgdGhpcy5jYXJldEhlaWdodCkpOwoJCQkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJCQljdHguZmlsbCgpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAiYmVsb3ciOgoJCQkJCXRvb2x0aXBZID0gdGhpcy55ICsgY2FyZXRQYWRkaW5nICsgdGhpcy5jYXJldEhlaWdodDsKCQkJCQkvL0RyYXcgYSBjYXJldCBiZWxvdyB0aGUgeC95CgkJCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQkJCWN0eC5tb3ZlVG8odGhpcy54LCB0aGlzLnkgKyBjYXJldFBhZGRpbmcpOwoJCQkJCWN0eC5saW5lVG8odGhpcy54ICsgdGhpcy5jYXJldEhlaWdodCwgdGhpcy55ICsgY2FyZXRQYWRkaW5nICsgdGhpcy5jYXJldEhlaWdodCk7CgkJCQkJY3R4LmxpbmVUbyh0aGlzLnggLSB0aGlzLmNhcmV0SGVpZ2h0LCB0aGlzLnkgKyBjYXJldFBhZGRpbmcgKyB0aGlzLmNhcmV0SGVpZ2h0KTsKCQkJCQljdHguY2xvc2VQYXRoKCk7CgkJCQkJY3R4LmZpbGwoKTsKCQkJCQlicmVhazsKCQkJCX0KCgkJCQlzd2l0Y2godGhpcy54QWxpZ24pCgkJCQl7CgkJCQljYXNlICJsZWZ0IjoKCQkJCQl0b29sdGlwWCA9IHRoaXMueCAtIHRvb2x0aXBXaWR0aCArICh0aGlzLmNvcm5lclJhZGl1cyArIHRoaXMuY2FyZXRIZWlnaHQpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAicmlnaHQiOgoJCQkJCXRvb2x0aXBYID0gdGhpcy54IC0gKHRoaXMuY29ybmVyUmFkaXVzICsgdGhpcy5jYXJldEhlaWdodCk7CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZHJhd1JvdW5kZWRSZWN0YW5nbGUoY3R4LHRvb2x0aXBYLHRvb2x0aXBZLHRvb2x0aXBXaWR0aCx0b29sdGlwUmVjdEhlaWdodCx0aGlzLmNvcm5lclJhZGl1cyk7CgoJCQkJY3R4LmZpbGwoKTsKCgkJCQljdHguZmlsbFN0eWxlID0gdGhpcy50ZXh0Q29sb3I7CgkJCQljdHgudGV4dEFsaWduID0gImNlbnRlciI7CgkJCQljdHgudGV4dEJhc2VsaW5lID0gIm1pZGRsZSI7CgkJCQljdHguZmlsbFRleHQodGhpcy50ZXh0LCB0b29sdGlwWCArIHRvb2x0aXBXaWR0aC8yLCB0b29sdGlwWSArIHRvb2x0aXBSZWN0SGVpZ2h0LzIpOwoJCQl9CgkJfQoJfSk7CgoJQ2hhcnQuTXVsdGlUb29sdGlwID0gQ2hhcnQuRWxlbWVudC5leHRlbmQoewoJCWluaXRpYWxpemUgOiBmdW5jdGlvbigpewoJCQl0aGlzLmZvbnQgPSBmb250U3RyaW5nKHRoaXMuZm9udFNpemUsdGhpcy5mb250U3R5bGUsdGhpcy5mb250RmFtaWx5KTsKCgkJCXRoaXMudGl0bGVGb250ID0gZm9udFN0cmluZyh0aGlzLnRpdGxlRm9udFNpemUsdGhpcy50aXRsZUZvbnRTdHlsZSx0aGlzLnRpdGxlRm9udEZhbWlseSk7CgoJCQl0aGlzLmhlaWdodCA9ICh0aGlzLmxhYmVscy5sZW5ndGggKiB0aGlzLmZvbnRTaXplKSArICgodGhpcy5sYWJlbHMubGVuZ3RoLTEpICogKHRoaXMuZm9udFNpemUvMikpICsgKHRoaXMueVBhZGRpbmcqMikgKyB0aGlzLnRpdGxlRm9udFNpemUgKjEuNTsKCgkJCXRoaXMuY3R4LmZvbnQgPSB0aGlzLnRpdGxlRm9udDsKCgkJCXZhciB0aXRsZVdpZHRoID0gdGhpcy5jdHgubWVhc3VyZVRleHQodGhpcy50aXRsZSkud2lkdGgsCgkJCQkvL0xhYmVsIGhhcyBhIGxlZ2VuZCBzcXVhcmUgYXMgd2VsbCBzbyBhY2NvdW50IGZvciB0aGlzLgoJCQkJbGFiZWxXaWR0aCA9IGxvbmdlc3RUZXh0KHRoaXMuY3R4LHRoaXMuZm9udCx0aGlzLmxhYmVscykgKyB0aGlzLmZvbnRTaXplICsgMywKCQkJCWxvbmdlc3RUZXh0V2lkdGggPSBtYXgoW2xhYmVsV2lkdGgsdGl0bGVXaWR0aF0pOwoKCQkJdGhpcy53aWR0aCA9IGxvbmdlc3RUZXh0V2lkdGggKyAodGhpcy54UGFkZGluZyoyKTsKCgoJCQl2YXIgaGFsZkhlaWdodCA9IHRoaXMuaGVpZ2h0LzI7CgoJCQkvL0NoZWNrIHRvIGVuc3VyZSB0aGUgaGVpZ2h0IHdpbGwgZml0IG9uIHRoZSBjYW52YXMKCQkJaWYgKHRoaXMueSAtIGhhbGZIZWlnaHQgPCAwICl7CgkJCQl0aGlzLnkgPSBoYWxmSGVpZ2h0OwoJCQl9IGVsc2UgaWYgKHRoaXMueSArIGhhbGZIZWlnaHQgPiB0aGlzLmNoYXJ0LmhlaWdodCl7CgkJCQl0aGlzLnkgPSB0aGlzLmNoYXJ0LmhlaWdodCAtIGhhbGZIZWlnaHQ7CgkJCX0KCgkJCS8vRGVjaWRlIHdoZXRoZXIgdG8gYWxpZ24gbGVmdCBvciByaWdodCBiYXNlZCBvbiBwb3NpdGlvbiBvbiBjYW52YXMKCQkJaWYgKHRoaXMueCA+IHRoaXMuY2hhcnQud2lkdGgvMil7CgkJCQl0aGlzLnggLT0gdGhpcy54T2Zmc2V0ICsgdGhpcy53aWR0aDsKCQkJfSBlbHNlIHsKCQkJCXRoaXMueCArPSB0aGlzLnhPZmZzZXQ7CgkJCX0KCgoJCX0sCgkJZ2V0TGluZUhlaWdodCA6IGZ1bmN0aW9uKGluZGV4KXsKCQkJdmFyIGJhc2VMaW5lSGVpZ2h0ID0gdGhpcy55IC0gKHRoaXMuaGVpZ2h0LzIpICsgdGhpcy55UGFkZGluZywKCQkJCWFmdGVyVGl0bGVJbmRleCA9IGluZGV4LTE7CgoJCQkvL0lmIHRoZSBpbmRleCBpcyB6ZXJvLCB3ZSdyZSBnZXR0aW5nIHRoZSB0aXRsZQoJCQlpZiAoaW5kZXggPT09IDApewoJCQkJcmV0dXJuIGJhc2VMaW5lSGVpZ2h0ICsgdGhpcy50aXRsZUZvbnRTaXplLzI7CgkJCX0gZWxzZXsKCQkJCXJldHVybiBiYXNlTGluZUhlaWdodCArICgodGhpcy5mb250U2l6ZSoxLjUqYWZ0ZXJUaXRsZUluZGV4KSArIHRoaXMuZm9udFNpemUvMikgKyB0aGlzLnRpdGxlRm9udFNpemUgKiAxLjU7CgkJCX0KCgkJfSwKCQlkcmF3IDogZnVuY3Rpb24oKXsKCQkJLy8gQ3VzdG9tIFRvb2x0aXBzCgkJCWlmKHRoaXMuY3VzdG9tKXsKCQkJCXRoaXMuY3VzdG9tKHRoaXMpOwoJCQl9CgkJCWVsc2V7CgkJCQlkcmF3Um91bmRlZFJlY3RhbmdsZSh0aGlzLmN0eCx0aGlzLngsdGhpcy55IC0gdGhpcy5oZWlnaHQvMix0aGlzLndpZHRoLHRoaXMuaGVpZ2h0LHRoaXMuY29ybmVyUmFkaXVzKTsKCQkJCXZhciBjdHggPSB0aGlzLmN0eDsKCQkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLmZpbGxDb2xvcjsKCQkJCWN0eC5maWxsKCk7CgkJCQljdHguY2xvc2VQYXRoKCk7CgoJCQkJY3R4LnRleHRBbGlnbiA9ICJsZWZ0IjsKCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKCQkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLnRpdGxlVGV4dENvbG9yOwoJCQkJY3R4LmZvbnQgPSB0aGlzLnRpdGxlRm9udDsKCgkJCQljdHguZmlsbFRleHQodGhpcy50aXRsZSx0aGlzLnggKyB0aGlzLnhQYWRkaW5nLCB0aGlzLmdldExpbmVIZWlnaHQoMCkpOwoKCQkJCWN0eC5mb250ID0gdGhpcy5mb250OwoJCQkJaGVscGVycy5lYWNoKHRoaXMubGFiZWxzLGZ1bmN0aW9uKGxhYmVsLGluZGV4KXsKCQkJCQljdHguZmlsbFN0eWxlID0gdGhpcy50ZXh0Q29sb3I7CgkJCQkJY3R4LmZpbGxUZXh0KGxhYmVsLHRoaXMueCArIHRoaXMueFBhZGRpbmcgKyB0aGlzLmZvbnRTaXplICsgMywgdGhpcy5nZXRMaW5lSGVpZ2h0KGluZGV4ICsgMSkpOwoKCQkJCQkvL0EgYml0IGduYXJseSwgYnV0IGNsZWFyaW5nIHRoaXMgcmVjdGFuZ2xlIGJyZWFrcyB3aGVuIHVzaW5nIGV4cGxvcmVyY2FudmFzIChjbGVhcnMgd2hvbGUgY2FudmFzKQoJCQkJCS8vY3R4LmNsZWFyUmVjdCh0aGlzLnggKyB0aGlzLnhQYWRkaW5nLCB0aGlzLmdldExpbmVIZWlnaHQoaW5kZXggKyAxKSAtIHRoaXMuZm9udFNpemUvMiwgdGhpcy5mb250U2l6ZSwgdGhpcy5mb250U2l6ZSk7CgkJCQkJLy9JbnN0ZWFkIHdlJ2xsIG1ha2UgYSB3aGl0ZSBmaWxsZWQgYmxvY2sgdG8gcHV0IHRoZSBsZWdlbmRDb2xvdXIgcGFsZXR0ZSBvdmVyLgoKCQkJCQljdHguZmlsbFN0eWxlID0gdGhpcy5sZWdlbmRDb2xvckJhY2tncm91bmQ7CgkJCQkJY3R4LmZpbGxSZWN0KHRoaXMueCArIHRoaXMueFBhZGRpbmcsIHRoaXMuZ2V0TGluZUhlaWdodChpbmRleCArIDEpIC0gdGhpcy5mb250U2l6ZS8yLCB0aGlzLmZvbnRTaXplLCB0aGlzLmZvbnRTaXplKTsKCgkJCQkJY3R4LmZpbGxTdHlsZSA9IHRoaXMubGVnZW5kQ29sb3JzW2luZGV4XS5maWxsOwoJCQkJCWN0eC5maWxsUmVjdCh0aGlzLnggKyB0aGlzLnhQYWRkaW5nLCB0aGlzLmdldExpbmVIZWlnaHQoaW5kZXggKyAxKSAtIHRoaXMuZm9udFNpemUvMiwgdGhpcy5mb250U2l6ZSwgdGhpcy5mb250U2l6ZSk7CgoKCQkJCX0sdGhpcyk7CgkJCX0KCQl9Cgl9KTsKCglDaGFydC5TY2FsZSA9IENoYXJ0LkVsZW1lbnQuZXh0ZW5kKHsKCQlpbml0aWFsaXplIDogZnVuY3Rpb24oKXsKCQkJdGhpcy5maXQoKTsKCQl9LAoJCWJ1aWxkWUxhYmVscyA6IGZ1bmN0aW9uKCl7CgkJCXRoaXMueUxhYmVscyA9IFtdOwoKCQkJdmFyIHN0ZXBEZWNpbWFsUGxhY2VzID0gZ2V0RGVjaW1hbFBsYWNlcyh0aGlzLnN0ZXBWYWx1ZSk7CgoJCQlmb3IgKHZhciBpPTA7IGk8PXRoaXMuc3RlcHM7IGkrKyl7CgkJCQl0aGlzLnlMYWJlbHMucHVzaCh0ZW1wbGF0ZSh0aGlzLnRlbXBsYXRlU3RyaW5nLHt2YWx1ZToodGhpcy5taW4gKyAoaSAqIHRoaXMuc3RlcFZhbHVlKSkudG9GaXhlZChzdGVwRGVjaW1hbFBsYWNlcyl9KSk7CgkJCX0KCQkJdGhpcy55TGFiZWxXaWR0aCA9ICh0aGlzLmRpc3BsYXkgJiYgdGhpcy5zaG93TGFiZWxzKSA/IGxvbmdlc3RUZXh0KHRoaXMuY3R4LHRoaXMuZm9udCx0aGlzLnlMYWJlbHMpIDogMDsKCQl9LAoJCWFkZFhMYWJlbCA6IGZ1bmN0aW9uKGxhYmVsKXsKCQkJdGhpcy54TGFiZWxzLnB1c2gobGFiZWwpOwoJCQl0aGlzLnZhbHVlc0NvdW50Kys7CgkJCXRoaXMuZml0KCk7CgkJfSwKCQlyZW1vdmVYTGFiZWwgOiBmdW5jdGlvbigpewoJCQl0aGlzLnhMYWJlbHMuc2hpZnQoKTsKCQkJdGhpcy52YWx1ZXNDb3VudC0tOwoJCQl0aGlzLmZpdCgpOwoJCX0sCgkJLy8gRml0dGluZyBsb29wIHRvIHJvdGF0ZSB4IExhYmVscyBhbmQgZmlndXJlIG91dCB3aGF0IGZpdHMgdGhlcmUsIGFuZCBhbHNvIGNhbGN1bGF0ZSBob3cgbWFueSBZIHN0ZXBzIHRvIHVzZQoJCWZpdDogZnVuY3Rpb24oKXsKCQkJLy8gRmlyc3Qgd2UgbmVlZCB0aGUgd2lkdGggb2YgdGhlIHlMYWJlbHMsIGFzc3VtaW5nIHRoZSB4TGFiZWxzIGFyZW4ndCByb3RhdGVkCgoJCQkvLyBUbyBkbyB0aGF0IHdlIG5lZWQgdGhlIGJhc2UgbGluZSBhdCB0aGUgdG9wIGFuZCBiYXNlIG9mIHRoZSBjaGFydCwgYXNzdW1pbmcgdGhlcmUgaXMgbm8geCBsYWJlbCByb3RhdGlvbgoJCQl0aGlzLnN0YXJ0UG9pbnQgPSAodGhpcy5kaXNwbGF5KSA/IHRoaXMuZm9udFNpemUgOiAwOwoJCQl0aGlzLmVuZFBvaW50ID0gKHRoaXMuZGlzcGxheSkgPyB0aGlzLmhlaWdodCAtICh0aGlzLmZvbnRTaXplICogMS41KSAtIDUgOiB0aGlzLmhlaWdodDsgLy8gLTUgdG8gcGFkIGxhYmVscwoKCQkJLy8gQXBwbHkgcGFkZGluZyBzZXR0aW5ncyB0byB0aGUgc3RhcnQgYW5kIGVuZCBwb2ludC4KCQkJdGhpcy5zdGFydFBvaW50ICs9IHRoaXMucGFkZGluZzsKCQkJdGhpcy5lbmRQb2ludCAtPSB0aGlzLnBhZGRpbmc7CgoJCQkvLyBDYWNoZSB0aGUgc3RhcnRpbmcgaGVpZ2h0LCBzbyBjYW4gZGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gcmVjYWxjdWxhdGUgdGhlIHNjYWxlIHlBeGlzCgkJCXZhciBjYWNoZWRIZWlnaHQgPSB0aGlzLmVuZFBvaW50IC0gdGhpcy5zdGFydFBvaW50LAoJCQkJY2FjaGVkWUxhYmVsV2lkdGg7CgoJCQkvLyBCdWlsZCB0aGUgY3VycmVudCB5TGFiZWxzIHNvIHdlIGhhdmUgYW4gaWRlYSBvZiB3aGF0IHNpemUgdGhleSdsbCBiZSB0byBzdGFydAoJCQkvKgoJCQkgKglUaGlzIHNldHMgd2hhdCBpcyByZXR1cm5lZCBmcm9tIGNhbGN1bGF0ZVNjYWxlUmFuZ2UgYXMgc3RhdGljIHByb3BlcnRpZXMgb2YgdGhpcyBjbGFzczoKCQkJICoKCQkJCXRoaXMuc3RlcHM7CgkJCQl0aGlzLnN0ZXBWYWx1ZTsKCQkJCXRoaXMubWluOwoJCQkJdGhpcy5tYXg7CgkJCSAqCgkJCSAqLwoJCQl0aGlzLmNhbGN1bGF0ZVlSYW5nZShjYWNoZWRIZWlnaHQpOwoKCQkJLy8gV2l0aCB0aGVzZSBwcm9wZXJ0aWVzIHNldCB3ZSBjYW4gbm93IGJ1aWxkIHRoZSBhcnJheSBvZiB5TGFiZWxzCgkJCS8vIGFuZCBhbHNvIHRoZSB3aWR0aCBvZiB0aGUgbGFyZ2VzdCB5TGFiZWwKCQkJdGhpcy5idWlsZFlMYWJlbHMoKTsKCgkJCXRoaXMuY2FsY3VsYXRlWExhYmVsUm90YXRpb24oKTsKCgkJCXdoaWxlKChjYWNoZWRIZWlnaHQgPiB0aGlzLmVuZFBvaW50IC0gdGhpcy5zdGFydFBvaW50KSl7CgkJCQljYWNoZWRIZWlnaHQgPSB0aGlzLmVuZFBvaW50IC0gdGhpcy5zdGFydFBvaW50OwoJCQkJY2FjaGVkWUxhYmVsV2lkdGggPSB0aGlzLnlMYWJlbFdpZHRoOwoKCQkJCXRoaXMuY2FsY3VsYXRlWVJhbmdlKGNhY2hlZEhlaWdodCk7CgkJCQl0aGlzLmJ1aWxkWUxhYmVscygpOwoKCQkJCS8vIE9ubHkgZ28gdGhyb3VnaCB0aGUgeExhYmVsIGxvb3AgYWdhaW4gaWYgdGhlIHlMYWJlbCB3aWR0aCBoYXMgY2hhbmdlZAoJCQkJaWYgKGNhY2hlZFlMYWJlbFdpZHRoIDwgdGhpcy55TGFiZWxXaWR0aCl7CgkJCQkJdGhpcy5jYWxjdWxhdGVYTGFiZWxSb3RhdGlvbigpOwoJCQkJfQoJCQl9CgoJCX0sCgkJY2FsY3VsYXRlWExhYmVsUm90YXRpb24gOiBmdW5jdGlvbigpewoJCQkvL0dldCB0aGUgd2lkdGggb2YgZWFjaCBncmlkIGJ5IGNhbGN1bGF0aW5nIHRoZSBkaWZmZXJlbmNlCgkJCS8vYmV0d2VlbiB4IG9mZnNldHMgYmV0d2VlbiAwIGFuZCAxLgoKCQkJdGhpcy5jdHguZm9udCA9IHRoaXMuZm9udDsKCgkJCXZhciBmaXJzdFdpZHRoID0gdGhpcy5jdHgubWVhc3VyZVRleHQodGhpcy54TGFiZWxzWzBdKS53aWR0aCwKCQkJCWxhc3RXaWR0aCA9IHRoaXMuY3R4Lm1lYXN1cmVUZXh0KHRoaXMueExhYmVsc1t0aGlzLnhMYWJlbHMubGVuZ3RoIC0gMV0pLndpZHRoLAoJCQkJZmlyc3RSb3RhdGVkLAoJCQkJbGFzdFJvdGF0ZWQ7CgoKCQkJdGhpcy54U2NhbGVQYWRkaW5nUmlnaHQgPSBsYXN0V2lkdGgvMiArIDM7CgkJCXRoaXMueFNjYWxlUGFkZGluZ0xlZnQgPSAoZmlyc3RXaWR0aC8yID4gdGhpcy55TGFiZWxXaWR0aCArIDEwKSA/IGZpcnN0V2lkdGgvMiA6IHRoaXMueUxhYmVsV2lkdGggKyAxMDsKCgkJCXRoaXMueExhYmVsUm90YXRpb24gPSAwOwoJCQlpZiAodGhpcy5kaXNwbGF5KXsKCQkJCXZhciBvcmlnaW5hbExhYmVsV2lkdGggPSBsb25nZXN0VGV4dCh0aGlzLmN0eCx0aGlzLmZvbnQsdGhpcy54TGFiZWxzKSwKCQkJCQljb3NSb3RhdGlvbiwKCQkJCQlmaXJzdFJvdGF0ZWRXaWR0aDsKCQkJCXRoaXMueExhYmVsV2lkdGggPSBvcmlnaW5hbExhYmVsV2lkdGg7CgkJCQkvL0FsbG93IDMgcGl4ZWxzIHgyIHBhZGRpbmcgZWl0aGVyIHNpZGUgZm9yIGxhYmVsIHJlYWRhYmlsaXR5CgkJCQl2YXIgeEdyaWRXaWR0aCA9IE1hdGguZmxvb3IodGhpcy5jYWxjdWxhdGVYKDEpIC0gdGhpcy5jYWxjdWxhdGVYKDApKSAtIDY7CgoJCQkJLy9NYXggbGFiZWwgcm90YXRlIHNob3VsZCBiZSA5MCAtIGFsc28gYWN0IGFzIGEgbG9vcCBjb3VudGVyCgkJCQl3aGlsZSAoKHRoaXMueExhYmVsV2lkdGggPiB4R3JpZFdpZHRoICYmIHRoaXMueExhYmVsUm90YXRpb24gPT09IDApIHx8ICh0aGlzLnhMYWJlbFdpZHRoID4geEdyaWRXaWR0aCAmJiB0aGlzLnhMYWJlbFJvdGF0aW9uIDw9IDkwICYmIHRoaXMueExhYmVsUm90YXRpb24gPiAwKSl7CgkJCQkJY29zUm90YXRpb24gPSBNYXRoLmNvcyh0b1JhZGlhbnModGhpcy54TGFiZWxSb3RhdGlvbikpOwoKCQkJCQlmaXJzdFJvdGF0ZWQgPSBjb3NSb3RhdGlvbiAqIGZpcnN0V2lkdGg7CgkJCQkJbGFzdFJvdGF0ZWQgPSBjb3NSb3RhdGlvbiAqIGxhc3RXaWR0aDsKCgkJCQkJLy8gV2UncmUgcmlnaHQgYWxpZ25pbmcgdGhlIHRleHQgbm93LgoJCQkJCWlmIChmaXJzdFJvdGF0ZWQgKyB0aGlzLmZvbnRTaXplIC8gMiA+IHRoaXMueUxhYmVsV2lkdGggKyA4KXsKCQkJCQkJdGhpcy54U2NhbGVQYWRkaW5nTGVmdCA9IGZpcnN0Um90YXRlZCArIHRoaXMuZm9udFNpemUgLyAyOwoJCQkJCX0KCQkJCQl0aGlzLnhTY2FsZVBhZGRpbmdSaWdodCA9IHRoaXMuZm9udFNpemUvMjsKCgoJCQkJCXRoaXMueExhYmVsUm90YXRpb24rKzsKCQkJCQl0aGlzLnhMYWJlbFdpZHRoID0gY29zUm90YXRpb24gKiBvcmlnaW5hbExhYmVsV2lkdGg7CgoJCQkJfQoJCQkJaWYgKHRoaXMueExhYmVsUm90YXRpb24gPiAwKXsKCQkJCQl0aGlzLmVuZFBvaW50IC09IE1hdGguc2luKHRvUmFkaWFucyh0aGlzLnhMYWJlbFJvdGF0aW9uKSkqb3JpZ2luYWxMYWJlbFdpZHRoICsgMzsKCQkJCX0KCQkJfQoJCQllbHNlewoJCQkJdGhpcy54TGFiZWxXaWR0aCA9IDA7CgkJCQl0aGlzLnhTY2FsZVBhZGRpbmdSaWdodCA9IHRoaXMucGFkZGluZzsKCQkJCXRoaXMueFNjYWxlUGFkZGluZ0xlZnQgPSB0aGlzLnBhZGRpbmc7CgkJCX0KCgkJfSwKCQkvLyBOZWVkcyB0byBiZSBvdmVyaWRkZW4gaW4gZWFjaCBDaGFydCB0eXBlCgkJLy8gT3RoZXJ3aXNlIHdlIG5lZWQgdG8gcGFzcyBhbGwgdGhlIGRhdGEgaW50byB0aGUgc2NhbGUgY2xhc3MKCQljYWxjdWxhdGVZUmFuZ2U6IG5vb3AsCgkJZHJhd2luZ0FyZWE6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLnN0YXJ0UG9pbnQgLSB0aGlzLmVuZFBvaW50OwoJCX0sCgkJY2FsY3VsYXRlWSA6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJdmFyIHNjYWxpbmdGYWN0b3IgPSB0aGlzLmRyYXdpbmdBcmVhKCkgLyAodGhpcy5taW4gLSB0aGlzLm1heCk7CgkJCXJldHVybiB0aGlzLmVuZFBvaW50IC0gKHNjYWxpbmdGYWN0b3IgKiAodmFsdWUgLSB0aGlzLm1pbikpOwoJCX0sCgkJY2FsY3VsYXRlWCA6IGZ1bmN0aW9uKGluZGV4KXsKCQkJdmFyIGlzUm90YXRlZCA9ICh0aGlzLnhMYWJlbFJvdGF0aW9uID4gMCksCgkJCQkvLyBpbm5lcldpZHRoID0gKHRoaXMub2Zmc2V0R3JpZExpbmVzKSA/IHRoaXMud2lkdGggLSBvZmZzZXRMZWZ0IC0gdGhpcy5wYWRkaW5nIDogdGhpcy53aWR0aCAtIChvZmZzZXRMZWZ0ICsgaGFsZkxhYmVsV2lkdGggKiAyKSAtIHRoaXMucGFkZGluZywKCQkJCWlubmVyV2lkdGggPSB0aGlzLndpZHRoIC0gKHRoaXMueFNjYWxlUGFkZGluZ0xlZnQgKyB0aGlzLnhTY2FsZVBhZGRpbmdSaWdodCksCgkJCQl2YWx1ZVdpZHRoID0gaW5uZXJXaWR0aC9NYXRoLm1heCgodGhpcy52YWx1ZXNDb3VudCAtICgodGhpcy5vZmZzZXRHcmlkTGluZXMpID8gMCA6IDEpKSwgMSksCgkJCQl2YWx1ZU9mZnNldCA9ICh2YWx1ZVdpZHRoICogaW5kZXgpICsgdGhpcy54U2NhbGVQYWRkaW5nTGVmdDsKCgkJCWlmICh0aGlzLm9mZnNldEdyaWRMaW5lcyl7CgkJCQl2YWx1ZU9mZnNldCArPSAodmFsdWVXaWR0aC8yKTsKCQkJfQoKCQkJcmV0dXJuIE1hdGgucm91bmQodmFsdWVPZmZzZXQpOwoJCX0sCgkJdXBkYXRlIDogZnVuY3Rpb24obmV3UHJvcHMpewoJCQloZWxwZXJzLmV4dGVuZCh0aGlzLCBuZXdQcm9wcyk7CgkJCXRoaXMuZml0KCk7CgkJfSwKCQlkcmF3IDogZnVuY3Rpb24oKXsKCQkJdmFyIGN0eCA9IHRoaXMuY3R4LAoJCQkJeUxhYmVsR2FwID0gKHRoaXMuZW5kUG9pbnQgLSB0aGlzLnN0YXJ0UG9pbnQpIC8gdGhpcy5zdGVwcywKCQkJCXhTdGFydCA9IE1hdGgucm91bmQodGhpcy54U2NhbGVQYWRkaW5nTGVmdCk7CgkJCWlmICh0aGlzLmRpc3BsYXkpewoJCQkJY3R4LmZpbGxTdHlsZSA9IHRoaXMudGV4dENvbG9yOwoJCQkJY3R4LmZvbnQgPSB0aGlzLmZvbnQ7CgkJCQllYWNoKHRoaXMueUxhYmVscyxmdW5jdGlvbihsYWJlbFN0cmluZyxpbmRleCl7CgkJCQkJdmFyIHlMYWJlbENlbnRlciA9IHRoaXMuZW5kUG9pbnQgLSAoeUxhYmVsR2FwICogaW5kZXgpLAoJCQkJCQlsaW5lUG9zaXRpb25ZID0gTWF0aC5yb3VuZCh5TGFiZWxDZW50ZXIpLAoJCQkJCQlkcmF3SG9yaXpvbnRhbExpbmUgPSB0aGlzLnNob3dIb3Jpem9udGFsTGluZXM7CgoJCQkJCWN0eC50ZXh0QWxpZ24gPSAicmlnaHQiOwoJCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKCQkJCQlpZiAodGhpcy5zaG93TGFiZWxzKXsKCQkJCQkJY3R4LmZpbGxUZXh0KGxhYmVsU3RyaW5nLHhTdGFydCAtIDEwLHlMYWJlbENlbnRlcik7CgkJCQkJfQoKCQkJCQkvLyBUaGlzIGlzIFggYXhpcywgc28gZHJhdyBpdAoJCQkJCWlmIChpbmRleCA9PT0gMCAmJiAhZHJhd0hvcml6b250YWxMaW5lKXsKCQkJCQkJZHJhd0hvcml6b250YWxMaW5lID0gdHJ1ZTsKCQkJCQl9CgoJCQkJCWlmIChkcmF3SG9yaXpvbnRhbExpbmUpewoJCQkJCQljdHguYmVnaW5QYXRoKCk7CgkJCQkJfQoKCQkJCQlpZiAoaW5kZXggPiAwKXsKCQkJCQkJLy8gVGhpcyBpcyBhIGdyaWQgbGluZSBpbiB0aGUgY2VudHJlLCBzbyBkcm9wIHRoYXQKCQkJCQkJY3R4LmxpbmVXaWR0aCA9IHRoaXMuZ3JpZExpbmVXaWR0aDsKCQkJCQkJY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5ncmlkTGluZUNvbG9yOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIFRoaXMgaXMgdGhlIGZpcnN0IGxpbmUgb24gdGhlIHNjYWxlCgkJCQkJCWN0eC5saW5lV2lkdGggPSB0aGlzLmxpbmVXaWR0aDsKCQkJCQkJY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5saW5lQ29sb3I7CgkJCQkJfQoKCQkJCQlsaW5lUG9zaXRpb25ZICs9IGhlbHBlcnMuYWxpYXNQaXhlbChjdHgubGluZVdpZHRoKTsKCgkJCQkJaWYoZHJhd0hvcml6b250YWxMaW5lKXsKCQkJCQkJY3R4Lm1vdmVUbyh4U3RhcnQsIGxpbmVQb3NpdGlvblkpOwoJCQkJCQljdHgubGluZVRvKHRoaXMud2lkdGgsIGxpbmVQb3NpdGlvblkpOwoJCQkJCQljdHguc3Ryb2tlKCk7CgkJCQkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJCQl9CgoJCQkJCWN0eC5saW5lV2lkdGggPSB0aGlzLmxpbmVXaWR0aDsKCQkJCQljdHguc3Ryb2tlU3R5bGUgPSB0aGlzLmxpbmVDb2xvcjsKCQkJCQljdHguYmVnaW5QYXRoKCk7CgkJCQkJY3R4Lm1vdmVUbyh4U3RhcnQgLSA1LCBsaW5lUG9zaXRpb25ZKTsKCQkJCQljdHgubGluZVRvKHhTdGFydCwgbGluZVBvc2l0aW9uWSk7CgkJCQkJY3R4LnN0cm9rZSgpOwoJCQkJCWN0eC5jbG9zZVBhdGgoKTsKCgkJCQl9LHRoaXMpOwoKCQkJCWVhY2godGhpcy54TGFiZWxzLGZ1bmN0aW9uKGxhYmVsLGluZGV4KXsKCQkJCQl2YXIgeFBvcyA9IHRoaXMuY2FsY3VsYXRlWChpbmRleCkgKyBhbGlhc1BpeGVsKHRoaXMubGluZVdpZHRoKSwKCQkJCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIGxpbmUvYmFyIGhlcmUgYW5kIGRlY2lkZSB3aGVyZSB0byBwbGFjZSB0aGUgbGluZQoJCQkJCQlsaW5lUG9zID0gdGhpcy5jYWxjdWxhdGVYKGluZGV4IC0gKHRoaXMub2Zmc2V0R3JpZExpbmVzID8gMC41IDogMCkpICsgYWxpYXNQaXhlbCh0aGlzLmxpbmVXaWR0aCksCgkJCQkJCWlzUm90YXRlZCA9ICh0aGlzLnhMYWJlbFJvdGF0aW9uID4gMCksCgkJCQkJCWRyYXdWZXJ0aWNhbExpbmUgPSB0aGlzLnNob3dWZXJ0aWNhbExpbmVzOwoKCQkJCQkvLyBUaGlzIGlzIFkgYXhpcywgc28gZHJhdyBpdAoJCQkJCWlmIChpbmRleCA9PT0gMCAmJiAhZHJhd1ZlcnRpY2FsTGluZSl7CgkJCQkJCWRyYXdWZXJ0aWNhbExpbmUgPSB0cnVlOwoJCQkJCX0KCgkJCQkJaWYgKGRyYXdWZXJ0aWNhbExpbmUpewoJCQkJCQljdHguYmVnaW5QYXRoKCk7CgkJCQkJfQoKCQkJCQlpZiAoaW5kZXggPiAwKXsKCQkJCQkJLy8gVGhpcyBpcyBhIGdyaWQgbGluZSBpbiB0aGUgY2VudHJlLCBzbyBkcm9wIHRoYXQKCQkJCQkJY3R4LmxpbmVXaWR0aCA9IHRoaXMuZ3JpZExpbmVXaWR0aDsKCQkJCQkJY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5ncmlkTGluZUNvbG9yOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIFRoaXMgaXMgdGhlIGZpcnN0IGxpbmUgb24gdGhlIHNjYWxlCgkJCQkJCWN0eC5saW5lV2lkdGggPSB0aGlzLmxpbmVXaWR0aDsKCQkJCQkJY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5saW5lQ29sb3I7CgkJCQkJfQoKCQkJCQlpZiAoZHJhd1ZlcnRpY2FsTGluZSl7CgkJCQkJCWN0eC5tb3ZlVG8obGluZVBvcyx0aGlzLmVuZFBvaW50KTsKCQkJCQkJY3R4LmxpbmVUbyhsaW5lUG9zLHRoaXMuc3RhcnRQb2ludCAtIDMpOwoJCQkJCQljdHguc3Ryb2tlKCk7CgkJCQkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJCQl9CgoKCQkJCQljdHgubGluZVdpZHRoID0gdGhpcy5saW5lV2lkdGg7CgkJCQkJY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5saW5lQ29sb3I7CgoKCQkJCQkvLyBTbWFsbCBsaW5lcyBhdCB0aGUgYm90dG9tIG9mIHRoZSBiYXNlIGdyaWQgbGluZQoJCQkJCWN0eC5iZWdpblBhdGgoKTsKCQkJCQljdHgubW92ZVRvKGxpbmVQb3MsdGhpcy5lbmRQb2ludCk7CgkJCQkJY3R4LmxpbmVUbyhsaW5lUG9zLHRoaXMuZW5kUG9pbnQgKyA1KTsKCQkJCQljdHguc3Ryb2tlKCk7CgkJCQkJY3R4LmNsb3NlUGF0aCgpOwoKCQkJCQljdHguc2F2ZSgpOwoJCQkJCWN0eC50cmFuc2xhdGUoeFBvcywoaXNSb3RhdGVkKSA/IHRoaXMuZW5kUG9pbnQgKyAxMiA6IHRoaXMuZW5kUG9pbnQgKyA4KTsKCQkJCQljdHgucm90YXRlKHRvUmFkaWFucyh0aGlzLnhMYWJlbFJvdGF0aW9uKSotMSk7CgkJCQkJY3R4LmZvbnQgPSB0aGlzLmZvbnQ7CgkJCQkJY3R4LnRleHRBbGlnbiA9IChpc1JvdGF0ZWQpID8gInJpZ2h0IiA6ICJjZW50ZXIiOwoJCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAoaXNSb3RhdGVkKSA/ICJtaWRkbGUiIDogInRvcCI7CgkJCQkJY3R4LmZpbGxUZXh0KGxhYmVsLCAwLCAwKTsKCQkJCQljdHgucmVzdG9yZSgpOwoJCQkJfSx0aGlzKTsKCgkJCX0KCQl9CgoJfSk7CgoJQ2hhcnQuUmFkaWFsU2NhbGUgPSBDaGFydC5FbGVtZW50LmV4dGVuZCh7CgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXsKCQkJdGhpcy5zaXplID0gbWluKFt0aGlzLmhlaWdodCwgdGhpcy53aWR0aF0pOwoJCQl0aGlzLmRyYXdpbmdBcmVhID0gKHRoaXMuZGlzcGxheSkgPyAodGhpcy5zaXplLzIpIC0gKHRoaXMuZm9udFNpemUvMiArIHRoaXMuYmFja2Ryb3BQYWRkaW5nWSkgOiAodGhpcy5zaXplLzIpOwoJCX0sCgkJY2FsY3VsYXRlQ2VudGVyT2Zmc2V0OiBmdW5jdGlvbih2YWx1ZSl7CgkJCS8vIFRha2UgaW50byBhY2NvdW50IGhhbGYgZm9udCBzaXplICsgdGhlIHlQYWRkaW5nIG9mIHRoZSB0b3AgdmFsdWUKCQkJdmFyIHNjYWxpbmdGYWN0b3IgPSB0aGlzLmRyYXdpbmdBcmVhIC8gKHRoaXMubWF4IC0gdGhpcy5taW4pOwoKCQkJcmV0dXJuICh2YWx1ZSAtIHRoaXMubWluKSAqIHNjYWxpbmdGYWN0b3I7CgkJfSwKCQl1cGRhdGUgOiBmdW5jdGlvbigpewoJCQlpZiAoIXRoaXMubGluZUFyYyl7CgkJCQl0aGlzLnNldFNjYWxlU2l6ZSgpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kcmF3aW5nQXJlYSA9ICh0aGlzLmRpc3BsYXkpID8gKHRoaXMuc2l6ZS8yKSAtICh0aGlzLmZvbnRTaXplLzIgKyB0aGlzLmJhY2tkcm9wUGFkZGluZ1kpIDogKHRoaXMuc2l6ZS8yKTsKCQkJfQoJCQl0aGlzLmJ1aWxkWUxhYmVscygpOwoJCX0sCgkJYnVpbGRZTGFiZWxzOiBmdW5jdGlvbigpewoJCQl0aGlzLnlMYWJlbHMgPSBbXTsKCgkJCXZhciBzdGVwRGVjaW1hbFBsYWNlcyA9IGdldERlY2ltYWxQbGFjZXModGhpcy5zdGVwVmFsdWUpOwoKCQkJZm9yICh2YXIgaT0wOyBpPD10aGlzLnN0ZXBzOyBpKyspewoJCQkJdGhpcy55TGFiZWxzLnB1c2godGVtcGxhdGUodGhpcy50ZW1wbGF0ZVN0cmluZyx7dmFsdWU6KHRoaXMubWluICsgKGkgKiB0aGlzLnN0ZXBWYWx1ZSkpLnRvRml4ZWQoc3RlcERlY2ltYWxQbGFjZXMpfSkpOwoJCQl9CgkJfSwKCQlnZXRDaXJjdW1mZXJlbmNlIDogZnVuY3Rpb24oKXsKCQkJcmV0dXJuICgoTWF0aC5QSSoyKSAvIHRoaXMudmFsdWVzQ291bnQpOwoJCX0sCgkJc2V0U2NhbGVTaXplOiBmdW5jdGlvbigpewoJCQkvKgoJCQkgKiBSaWdodCwgdGhpcyBpcyByZWFsbHkgY29uZnVzaW5nIGFuZCB0aGVyZSBpcyBhIGxvdCBvZiBtYXRocyBnb2luZyBvbiBoZXJlCgkJCSAqIFRoZSBnaXN0IG9mIHRoZSBwcm9ibGVtIGlzIGhlcmU6IGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL25ubmljay82OTZjYzljNTVmNGIwYmViOGZlOQoJCQkgKgoJCQkgKiBSZWFjdGlvbjogaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3UvMzQ2MDEzNjMvdG9vbXVjaHNjaWVuY2UuZ2lmCgkJCSAqCgkJCSAqIFNvbHV0aW9uOgoJCQkgKgoJCQkgKiBXZSBhc3N1bWUgdGhlIHJhZGl1cyBvZiB0aGUgcG9seWdvbiBpcyBoYWxmIHRoZSBzaXplIG9mIHRoZSBjYW52YXMgYXQgZmlyc3QKCQkJICogYXQgZWFjaCBpbmRleCB3ZSBjaGVjayBpZiB0aGUgdGV4dCBvdmVybGFwcy4KCQkJICoKCQkJICogV2hlcmUgaXQgZG9lcywgd2Ugc3RvcmUgdGhhdCBhbmdsZSBhbmQgdGhhdCBpbmRleC4KCQkJICoKCQkJICogQWZ0ZXIgZmluZGluZyB0aGUgbGFyZ2VzdCBpbmRleCBhbmQgYW5nbGUgd2UgY2FsY3VsYXRlIGhvdyBtdWNoIHdlIG5lZWQgdG8gcmVtb3ZlCgkJCSAqIGZyb20gdGhlIHNoYXBlIHJhZGl1cyB0byBtb3ZlIHRoZSBwb2ludCBpbndhcmRzIGJ5IHRoYXQgeC4KCQkJICoKCQkJICogV2UgYXZlcmFnZSB0aGUgbGVmdCBhbmQgcmlnaHQgZGlzdGFuY2VzIHRvIGdldCB0aGUgbWF4aW11bSBzaGFwZSByYWRpdXMgdGhhdCBjYW4gZml0IGluIHRoZSBib3gKCQkJICogYWxvbmcgd2l0aCBsYWJlbHMuCgkJCSAqCgkJCSAqIE9uY2Ugd2UgaGF2ZSB0aGF0LCB3ZSBjYW4gZmluZCB0aGUgY2VudHJlIHBvaW50IGZvciB0aGUgY2hhcnQsIGJ5IHRha2luZyB0aGUgeCB0ZXh0IHByb3RydXNpb24KCQkJICogb24gZWFjaCBzaWRlLCByZW1vdmluZyB0aGF0IGZyb20gdGhlIHNpemUsIGhhbHZpbmcgaXQgYW5kIGFkZGluZyB0aGUgbGVmdCB4IHByb3RydXNpb24gd2lkdGguCgkJCSAqCgkJCSAqIFRoaXMgd2lsbCBtZWFuIHdlIGhhdmUgYSBzaGFwZSBmaXR0ZWQgdG8gdGhlIGNhbnZhcywgYXMgbGFyZ2UgYXMgaXQgY2FuIGJlIHdpdGggdGhlIGxhYmVscwoJCQkgKiBhbmQgcG9zaXRpb24gaXQgaW4gdGhlIG1vc3Qgc3BhY2UgZWZmaWNpZW50IG1hbm5lcgoJCQkgKgoJCQkgKiBodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vdS8zNDYwMTM2My95ZWFoc2NpZW5jZS5naWYKCQkJICovCgoKCQkJLy8gR2V0IG1heGltdW0gcmFkaXVzIG9mIHRoZSBwb2x5Z29uLiBFaXRoZXIgaGFsZiB0aGUgaGVpZ2h0IChtaW51cyB0aGUgdGV4dCB3aWR0aCkgb3IgaGFsZiB0aGUgd2lkdGguCgkJCS8vIFVzZSB0aGlzIHRvIGNhbGN1bGF0ZSB0aGUgb2Zmc2V0ICsgY2hhbmdlLiAtIE1ha2Ugc3VyZSBML1IgcHJvdHJ1c2lvbiBpcyBhdCBsZWFzdCAwIHRvIHN0b3AgaXNzdWVzIHdpdGggY2VudHJlIHBvaW50cwoJCQl2YXIgbGFyZ2VzdFBvc3NpYmxlUmFkaXVzID0gbWluKFsodGhpcy5oZWlnaHQvMiAtIHRoaXMucG9pbnRMYWJlbEZvbnRTaXplIC0gNSksIHRoaXMud2lkdGgvMl0pLAoJCQkJcG9pbnRQb3NpdGlvbiwKCQkJCWksCgkJCQl0ZXh0V2lkdGgsCgkJCQloYWxmVGV4dFdpZHRoLAoJCQkJZnVydGhlc3RSaWdodCA9IHRoaXMud2lkdGgsCgkJCQlmdXJ0aGVzdFJpZ2h0SW5kZXgsCgkJCQlmdXJ0aGVzdFJpZ2h0QW5nbGUsCgkJCQlmdXJ0aGVzdExlZnQgPSAwLAoJCQkJZnVydGhlc3RMZWZ0SW5kZXgsCgkJCQlmdXJ0aGVzdExlZnRBbmdsZSwKCQkJCXhQcm90cnVzaW9uTGVmdCwKCQkJCXhQcm90cnVzaW9uUmlnaHQsCgkJCQlyYWRpdXNSZWR1Y3Rpb25SaWdodCwKCQkJCXJhZGl1c1JlZHVjdGlvbkxlZnQsCgkJCQltYXhXaWR0aFJhZGl1czsKCQkJdGhpcy5jdHguZm9udCA9IGZvbnRTdHJpbmcodGhpcy5wb2ludExhYmVsRm9udFNpemUsdGhpcy5wb2ludExhYmVsRm9udFN0eWxlLHRoaXMucG9pbnRMYWJlbEZvbnRGYW1pbHkpOwoJCQlmb3IgKGk9MDtpPHRoaXMudmFsdWVzQ291bnQ7aSsrKXsKCQkJCS8vIDVweCB0byBzcGFjZSB0aGUgdGV4dCBzbGlnaHRseSBvdXQgLSBzaW1pbGFyIHRvIHdoYXQgd2UgZG8gaW4gdGhlIGRyYXcgZnVuY3Rpb24uCgkJCQlwb2ludFBvc2l0aW9uID0gdGhpcy5nZXRQb2ludFBvc2l0aW9uKGksIGxhcmdlc3RQb3NzaWJsZVJhZGl1cyk7CgkJCQl0ZXh0V2lkdGggPSB0aGlzLmN0eC5tZWFzdXJlVGV4dCh0ZW1wbGF0ZSh0aGlzLnRlbXBsYXRlU3RyaW5nLCB7IHZhbHVlOiB0aGlzLmxhYmVsc1tpXSB9KSkud2lkdGggKyA1OwoJCQkJaWYgKGkgPT09IDAgfHwgaSA9PT0gdGhpcy52YWx1ZXNDb3VudC8yKXsKCQkJCQkvLyBJZiB3ZSdyZSBhdCBpbmRleCB6ZXJvLCBvciBleGFjdGx5IHRoZSBtaWRkbGUsIHdlJ3JlIGF0IGV4YWN0bHkgdGhlIHRvcC9ib3R0b20KCQkJCQkvLyBvZiB0aGUgcmFkYXIgY2hhcnQsIHNvIHRleHQgd2lsbCBiZSBhbGlnbmVkIGNlbnRyYWxseSwgc28gd2UnbGwgaGFsZiBpdCBhbmQgY29tcGFyZQoJCQkJCS8vIHcvbGVmdCBhbmQgcmlnaHQgdGV4dCBzaXplcwoJCQkJCWhhbGZUZXh0V2lkdGggPSB0ZXh0V2lkdGgvMjsKCQkJCQlpZiAocG9pbnRQb3NpdGlvbi54ICsgaGFsZlRleHRXaWR0aCA+IGZ1cnRoZXN0UmlnaHQpIHsKCQkJCQkJZnVydGhlc3RSaWdodCA9IHBvaW50UG9zaXRpb24ueCArIGhhbGZUZXh0V2lkdGg7CgkJCQkJCWZ1cnRoZXN0UmlnaHRJbmRleCA9IGk7CgkJCQkJfQoJCQkJCWlmIChwb2ludFBvc2l0aW9uLnggLSBoYWxmVGV4dFdpZHRoIDwgZnVydGhlc3RMZWZ0KSB7CgkJCQkJCWZ1cnRoZXN0TGVmdCA9IHBvaW50UG9zaXRpb24ueCAtIGhhbGZUZXh0V2lkdGg7CgkJCQkJCWZ1cnRoZXN0TGVmdEluZGV4ID0gaTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChpIDwgdGhpcy52YWx1ZXNDb3VudC8yKSB7CgkJCQkJLy8gTGVzcyB0aGFuIGhhbGYgdGhlIHZhbHVlcyBtZWFucyB3ZSdsbCBsZWZ0IGFsaWduIHRoZSB0ZXh0CgkJCQkJaWYgKHBvaW50UG9zaXRpb24ueCArIHRleHRXaWR0aCA+IGZ1cnRoZXN0UmlnaHQpIHsKCQkJCQkJZnVydGhlc3RSaWdodCA9IHBvaW50UG9zaXRpb24ueCArIHRleHRXaWR0aDsKCQkJCQkJZnVydGhlc3RSaWdodEluZGV4ID0gaTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChpID4gdGhpcy52YWx1ZXNDb3VudC8yKXsKCQkJCQkvLyBNb3JlIHRoYW4gaGFsZiB0aGUgdmFsdWVzIG1lYW5zIHdlJ2xsIHJpZ2h0IGFsaWduIHRoZSB0ZXh0CgkJCQkJaWYgKHBvaW50UG9zaXRpb24ueCAtIHRleHRXaWR0aCA8IGZ1cnRoZXN0TGVmdCkgewoJCQkJCQlmdXJ0aGVzdExlZnQgPSBwb2ludFBvc2l0aW9uLnggLSB0ZXh0V2lkdGg7CgkJCQkJCWZ1cnRoZXN0TGVmdEluZGV4ID0gaTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXhQcm90cnVzaW9uTGVmdCA9IGZ1cnRoZXN0TGVmdDsKCgkJCXhQcm90cnVzaW9uUmlnaHQgPSBNYXRoLmNlaWwoZnVydGhlc3RSaWdodCAtIHRoaXMud2lkdGgpOwoKCQkJZnVydGhlc3RSaWdodEFuZ2xlID0gdGhpcy5nZXRJbmRleEFuZ2xlKGZ1cnRoZXN0UmlnaHRJbmRleCk7CgoJCQlmdXJ0aGVzdExlZnRBbmdsZSA9IHRoaXMuZ2V0SW5kZXhBbmdsZShmdXJ0aGVzdExlZnRJbmRleCk7CgoJCQlyYWRpdXNSZWR1Y3Rpb25SaWdodCA9IHhQcm90cnVzaW9uUmlnaHQgLyBNYXRoLnNpbihmdXJ0aGVzdFJpZ2h0QW5nbGUgKyBNYXRoLlBJLzIpOwoKCQkJcmFkaXVzUmVkdWN0aW9uTGVmdCA9IHhQcm90cnVzaW9uTGVmdCAvIE1hdGguc2luKGZ1cnRoZXN0TGVmdEFuZ2xlICsgTWF0aC5QSS8yKTsKCgkJCS8vIEVuc3VyZSB3ZSBhY3R1YWxseSBuZWVkIHRvIHJlZHVjZSB0aGUgc2l6ZSBvZiB0aGUgY2hhcnQKCQkJcmFkaXVzUmVkdWN0aW9uUmlnaHQgPSAoaXNOdW1iZXIocmFkaXVzUmVkdWN0aW9uUmlnaHQpKSA/IHJhZGl1c1JlZHVjdGlvblJpZ2h0IDogMDsKCQkJcmFkaXVzUmVkdWN0aW9uTGVmdCA9IChpc051bWJlcihyYWRpdXNSZWR1Y3Rpb25MZWZ0KSkgPyByYWRpdXNSZWR1Y3Rpb25MZWZ0IDogMDsKCgkJCXRoaXMuZHJhd2luZ0FyZWEgPSBsYXJnZXN0UG9zc2libGVSYWRpdXMgLSAocmFkaXVzUmVkdWN0aW9uTGVmdCArIHJhZGl1c1JlZHVjdGlvblJpZ2h0KS8yOwoKCQkJLy90aGlzLmRyYXdpbmdBcmVhID0gbWluKFttYXhXaWR0aFJhZGl1cywgKHRoaXMuaGVpZ2h0IC0gKDIgKiAodGhpcy5wb2ludExhYmVsRm9udFNpemUgKyA1KSkpLzJdKQoJCQl0aGlzLnNldENlbnRlclBvaW50KHJhZGl1c1JlZHVjdGlvbkxlZnQsIHJhZGl1c1JlZHVjdGlvblJpZ2h0KTsKCgkJfSwKCQlzZXRDZW50ZXJQb2ludDogZnVuY3Rpb24obGVmdE1vdmVtZW50LCByaWdodE1vdmVtZW50KXsKCgkJCXZhciBtYXhSaWdodCA9IHRoaXMud2lkdGggLSByaWdodE1vdmVtZW50IC0gdGhpcy5kcmF3aW5nQXJlYSwKCQkJCW1heExlZnQgPSBsZWZ0TW92ZW1lbnQgKyB0aGlzLmRyYXdpbmdBcmVhOwoKCQkJdGhpcy54Q2VudGVyID0gKG1heExlZnQgKyBtYXhSaWdodCkvMjsKCQkJLy8gQWx3YXlzIHZlcnRpY2FsbHkgaW4gdGhlIGNlbnRyZSBhcyB0aGUgdGV4dCBoZWlnaHQgZG9lc24ndCBjaGFuZ2UKCQkJdGhpcy55Q2VudGVyID0gKHRoaXMuaGVpZ2h0LzIpOwoJCX0sCgoJCWdldEluZGV4QW5nbGUgOiBmdW5jdGlvbihpbmRleCl7CgkJCXZhciBhbmdsZU11bHRpcGxpZXIgPSAoTWF0aC5QSSAqIDIpIC8gdGhpcy52YWx1ZXNDb3VudDsKCQkJLy8gU3RhcnQgZnJvbSB0aGUgdG9wIGluc3RlYWQgb2YgcmlnaHQsIHNvIHJlbW92ZSBhIHF1YXJ0ZXIgb2YgdGhlIGNpcmNsZQoKCQkJcmV0dXJuIGluZGV4ICogYW5nbGVNdWx0aXBsaWVyIC0gKE1hdGguUEkvMik7CgkJfSwKCQlnZXRQb2ludFBvc2l0aW9uIDogZnVuY3Rpb24oaW5kZXgsIGRpc3RhbmNlRnJvbUNlbnRlcil7CgkJCXZhciB0aGlzQW5nbGUgPSB0aGlzLmdldEluZGV4QW5nbGUoaW5kZXgpOwoJCQlyZXR1cm4gewoJCQkJeCA6IChNYXRoLmNvcyh0aGlzQW5nbGUpICogZGlzdGFuY2VGcm9tQ2VudGVyKSArIHRoaXMueENlbnRlciwKCQkJCXkgOiAoTWF0aC5zaW4odGhpc0FuZ2xlKSAqIGRpc3RhbmNlRnJvbUNlbnRlcikgKyB0aGlzLnlDZW50ZXIKCQkJfTsKCQl9LAoJCWRyYXc6IGZ1bmN0aW9uKCl7CgkJCWlmICh0aGlzLmRpc3BsYXkpewoJCQkJdmFyIGN0eCA9IHRoaXMuY3R4OwoJCQkJZWFjaCh0aGlzLnlMYWJlbHMsIGZ1bmN0aW9uKGxhYmVsLCBpbmRleCl7CgkJCQkJLy8gRG9uJ3QgZHJhdyBhIGNlbnRyZSB2YWx1ZQoJCQkJCWlmIChpbmRleCA+IDApewoJCQkJCQl2YXIgeUNlbnRlck9mZnNldCA9IGluZGV4ICogKHRoaXMuZHJhd2luZ0FyZWEvdGhpcy5zdGVwcyksCgkJCQkJCQl5SGVpZ2h0ID0gdGhpcy55Q2VudGVyIC0geUNlbnRlck9mZnNldCwKCQkJCQkJCXBvaW50UG9zaXRpb247CgoJCQkJCQkvLyBEcmF3IGNpcmN1bGFyIGxpbmVzIGFyb3VuZCB0aGUgc2NhbGUKCQkJCQkJaWYgKHRoaXMubGluZVdpZHRoID4gMCl7CgkJCQkJCQljdHguc3Ryb2tlU3R5bGUgPSB0aGlzLmxpbmVDb2xvcjsKCQkJCQkJCWN0eC5saW5lV2lkdGggPSB0aGlzLmxpbmVXaWR0aDsKCgkJCQkJCQlpZih0aGlzLmxpbmVBcmMpewoJCQkJCQkJCWN0eC5iZWdpblBhdGgoKTsKCQkJCQkJCQljdHguYXJjKHRoaXMueENlbnRlciwgdGhpcy55Q2VudGVyLCB5Q2VudGVyT2Zmc2V0LCAwLCBNYXRoLlBJKjIpOwoJCQkJCQkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJCQkJCQljdHguc3Ryb2tlKCk7CgkJCQkJCQl9IGVsc2V7CgkJCQkJCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQkJCQkJCWZvciAodmFyIGk9MDtpPHRoaXMudmFsdWVzQ291bnQ7aSsrKQoJCQkJCQkJCXsKCQkJCQkJCQkJcG9pbnRQb3NpdGlvbiA9IHRoaXMuZ2V0UG9pbnRQb3NpdGlvbihpLCB0aGlzLmNhbGN1bGF0ZUNlbnRlck9mZnNldCh0aGlzLm1pbiArIChpbmRleCAqIHRoaXMuc3RlcFZhbHVlKSkpOwoJCQkJCQkJCQlpZiAoaSA9PT0gMCl7CgkJCQkJCQkJCQljdHgubW92ZVRvKHBvaW50UG9zaXRpb24ueCwgcG9pbnRQb3NpdGlvbi55KTsKCQkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJCWN0eC5saW5lVG8ocG9pbnRQb3NpdGlvbi54LCBwb2ludFBvc2l0aW9uLnkpOwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJCQkJCQljdHguc3Ryb2tlKCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYodGhpcy5zaG93TGFiZWxzKXsKCQkJCQkJCWN0eC5mb250ID0gZm9udFN0cmluZyh0aGlzLmZvbnRTaXplLHRoaXMuZm9udFN0eWxlLHRoaXMuZm9udEZhbWlseSk7CgkJCQkJCQlpZiAodGhpcy5zaG93TGFiZWxCYWNrZHJvcCl7CgkJCQkJCQkJdmFyIGxhYmVsV2lkdGggPSBjdHgubWVhc3VyZVRleHQobGFiZWwpLndpZHRoOwoJCQkJCQkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLmJhY2tkcm9wQ29sb3I7CgkJCQkJCQkJY3R4LmZpbGxSZWN0KAoJCQkJCQkJCQl0aGlzLnhDZW50ZXIgLSBsYWJlbFdpZHRoLzIgLSB0aGlzLmJhY2tkcm9wUGFkZGluZ1gsCgkJCQkJCQkJCXlIZWlnaHQgLSB0aGlzLmZvbnRTaXplLzIgLSB0aGlzLmJhY2tkcm9wUGFkZGluZ1ksCgkJCQkJCQkJCWxhYmVsV2lkdGggKyB0aGlzLmJhY2tkcm9wUGFkZGluZ1gqMiwKCQkJCQkJCQkJdGhpcy5mb250U2l6ZSArIHRoaXMuYmFja2Ryb3BQYWRkaW5nWSoyCgkJCQkJCQkJKTsKCQkJCQkJCX0KCQkJCQkJCWN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKCQkJCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKCQkJCQkJCWN0eC5maWxsU3R5bGUgPSB0aGlzLmZvbnRDb2xvcjsKCQkJCQkJCWN0eC5maWxsVGV4dChsYWJlbCwgdGhpcy54Q2VudGVyLCB5SGVpZ2h0KTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHRoaXMpOwoKCQkJCWlmICghdGhpcy5saW5lQXJjKXsKCQkJCQljdHgubGluZVdpZHRoID0gdGhpcy5hbmdsZUxpbmVXaWR0aDsKCQkJCQljdHguc3Ryb2tlU3R5bGUgPSB0aGlzLmFuZ2xlTGluZUNvbG9yOwoJCQkJCWZvciAodmFyIGkgPSB0aGlzLnZhbHVlc0NvdW50IC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQkJaWYgKHRoaXMuYW5nbGVMaW5lV2lkdGggPiAwKXsKCQkJCQkJCXZhciBvdXRlclBvc2l0aW9uID0gdGhpcy5nZXRQb2ludFBvc2l0aW9uKGksIHRoaXMuY2FsY3VsYXRlQ2VudGVyT2Zmc2V0KHRoaXMubWF4KSk7CgkJCQkJCQljdHguYmVnaW5QYXRoKCk7CgkJCQkJCQljdHgubW92ZVRvKHRoaXMueENlbnRlciwgdGhpcy55Q2VudGVyKTsKCQkJCQkJCWN0eC5saW5lVG8ob3V0ZXJQb3NpdGlvbi54LCBvdXRlclBvc2l0aW9uLnkpOwoJCQkJCQkJY3R4LnN0cm9rZSgpOwoJCQkJCQkJY3R4LmNsb3NlUGF0aCgpOwoJCQkJCQl9CgkJCQkJCS8vIEV4dHJhIDNweCBvdXQgZm9yIHNvbWUgbGFiZWwgc3BhY2luZwoJCQkJCQl2YXIgcG9pbnRMYWJlbFBvc2l0aW9uID0gdGhpcy5nZXRQb2ludFBvc2l0aW9uKGksIHRoaXMuY2FsY3VsYXRlQ2VudGVyT2Zmc2V0KHRoaXMubWF4KSArIDUpOwoJCQkJCQljdHguZm9udCA9IGZvbnRTdHJpbmcodGhpcy5wb2ludExhYmVsRm9udFNpemUsdGhpcy5wb2ludExhYmVsRm9udFN0eWxlLHRoaXMucG9pbnRMYWJlbEZvbnRGYW1pbHkpOwoJCQkJCQljdHguZmlsbFN0eWxlID0gdGhpcy5wb2ludExhYmVsRm9udENvbG9yOwoKCQkJCQkJdmFyIGxhYmVsc0NvdW50ID0gdGhpcy5sYWJlbHMubGVuZ3RoLAoJCQkJCQkJaGFsZkxhYmVsc0NvdW50ID0gdGhpcy5sYWJlbHMubGVuZ3RoLzIsCgkJCQkJCQlxdWFydGVyTGFiZWxzQ291bnQgPSBoYWxmTGFiZWxzQ291bnQvMiwKCQkJCQkJCXVwcGVySGFsZiA9IChpIDwgcXVhcnRlckxhYmVsc0NvdW50IHx8IGkgPiBsYWJlbHNDb3VudCAtIHF1YXJ0ZXJMYWJlbHNDb3VudCksCgkJCQkJCQlleGFjdFF1YXJ0ZXIgPSAoaSA9PT0gcXVhcnRlckxhYmVsc0NvdW50IHx8IGkgPT09IGxhYmVsc0NvdW50IC0gcXVhcnRlckxhYmVsc0NvdW50KTsKCQkJCQkJaWYgKGkgPT09IDApewoJCQkJCQkJY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwoJCQkJCQl9IGVsc2UgaWYoaSA9PT0gaGFsZkxhYmVsc0NvdW50KXsKCQkJCQkJCWN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKCQkJCQkJfSBlbHNlIGlmIChpIDwgaGFsZkxhYmVsc0NvdW50KXsKCQkJCQkJCWN0eC50ZXh0QWxpZ24gPSAnbGVmdCc7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQljdHgudGV4dEFsaWduID0gJ3JpZ2h0JzsKCQkJCQkJfQoKCQkJCQkJLy8gU2V0IHRoZSBjb3JyZWN0IHRleHQgYmFzZWxpbmUgYmFzZWQgb24gb3V0ZXIgcG9zaXRpb25pbmcKCQkJCQkJaWYgKGV4YWN0UXVhcnRlcil7CgkJCQkJCQljdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CgkJCQkJCX0gZWxzZSBpZiAodXBwZXJIYWxmKXsKCQkJCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAnYm90dG9tJzsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAndG9wJzsKCQkJCQkJfQoKCQkJCQkJY3R4LmZpbGxUZXh0KHRoaXMubGFiZWxzW2ldLCBwb2ludExhYmVsUG9zaXRpb24ueCwgcG9pbnRMYWJlbFBvc2l0aW9uLnkpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0pOwoKCS8vIEF0dGFjaCBnbG9iYWwgZXZlbnQgdG8gcmVzaXplIGVhY2ggY2hhcnQgaW5zdGFuY2Ugd2hlbiB0aGUgYnJvd3NlciByZXNpemVzCgloZWxwZXJzLmFkZEV2ZW50KHdpbmRvdywgInJlc2l6ZSIsIChmdW5jdGlvbigpewoJCS8vIEJhc2ljIGRlYm91bmNlIG9mIHJlc2l6ZSBmdW5jdGlvbiBzbyBpdCBkb2Vzbid0IGh1cnQgcGVyZm9ybWFuY2Ugd2hlbiByZXNpemluZyBicm93c2VyLgoJCXZhciB0aW1lb3V0OwoJCXJldHVybiBmdW5jdGlvbigpewoJCQljbGVhclRpbWVvdXQodGltZW91dCk7CgkJCXRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCQllYWNoKENoYXJ0Lmluc3RhbmNlcyxmdW5jdGlvbihpbnN0YW5jZSl7CgkJCQkJLy8gSWYgdGhlIHJlc3BvbnNpdmUgZmxhZyBpcyBzZXQgaW4gdGhlIGNoYXJ0IGluc3RhbmNlIGNvbmZpZwoJCQkJCS8vIENhc2NhZGUgdGhlIHJlc2l6ZSBldmVudCBkb3duIHRvIHRoZSBjaGFydC4KCQkJCQlpZiAoaW5zdGFuY2Uub3B0aW9ucy5yZXNwb25zaXZlKXsKCQkJCQkJaW5zdGFuY2UucmVzaXplKGluc3RhbmNlLnJlbmRlciwgdHJ1ZSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0sIDUwKTsKCQl9OwoJfSkoKSk7CgoKCWlmIChhbWQpIHsKCQlkZWZpbmUoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIENoYXJ0OwoJCX0pOwoJfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiBtb2R1bGUuZXhwb3J0cykgewoJCW1vZHVsZS5leHBvcnRzID0gQ2hhcnQ7Cgl9CgoJcm9vdC5DaGFydCA9IENoYXJ0OwoKCUNoYXJ0Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpewoJCXJvb3QuQ2hhcnQgPSBwcmV2aW91czsKCQlyZXR1cm4gQ2hhcnQ7Cgl9OwoKfSkuY2FsbCh0aGlzKTsKCihmdW5jdGlvbigpewoJInVzZSBzdHJpY3QiOwoKCXZhciByb290ID0gdGhpcywKCQlDaGFydCA9IHJvb3QuQ2hhcnQsCgkJaGVscGVycyA9IENoYXJ0LmhlbHBlcnM7CgoKCXZhciBkZWZhdWx0Q29uZmlnID0gewoJCS8vQm9vbGVhbiAtIFdoZXRoZXIgdGhlIHNjYWxlIHNob3VsZCBzdGFydCBhdCB6ZXJvLCBvciBhbiBvcmRlciBvZiBtYWduaXR1ZGUgZG93biBmcm9tIHRoZSBsb3dlc3QgdmFsdWUKCQlzY2FsZUJlZ2luQXRaZXJvIDogdHJ1ZSwKCgkJLy9Cb29sZWFuIC0gV2hldGhlciBncmlkIGxpbmVzIGFyZSBzaG93biBhY3Jvc3MgdGhlIGNoYXJ0CgkJc2NhbGVTaG93R3JpZExpbmVzIDogdHJ1ZSwKCgkJLy9TdHJpbmcgLSBDb2xvdXIgb2YgdGhlIGdyaWQgbGluZXMKCQlzY2FsZUdyaWRMaW5lQ29sb3IgOiAicmdiYSgwLDAsMCwuMDUpIiwKCgkJLy9OdW1iZXIgLSBXaWR0aCBvZiB0aGUgZ3JpZCBsaW5lcwoJCXNjYWxlR3JpZExpbmVXaWR0aCA6IDEsCgoJCS8vQm9vbGVhbiAtIFdoZXRoZXIgdG8gc2hvdyBob3Jpem9udGFsIGxpbmVzIChleGNlcHQgWCBheGlzKQoJCXNjYWxlU2hvd0hvcml6b250YWxMaW5lczogdHJ1ZSwKCgkJLy9Cb29sZWFuIC0gV2hldGhlciB0byBzaG93IHZlcnRpY2FsIGxpbmVzIChleGNlcHQgWSBheGlzKQoJCXNjYWxlU2hvd1ZlcnRpY2FsTGluZXM6IHRydWUsCgoJCS8vQm9vbGVhbiAtIElmIHRoZXJlIGlzIGEgc3Ryb2tlIG9uIGVhY2ggYmFyCgkJYmFyU2hvd1N0cm9rZSA6IHRydWUsCgoJCS8vTnVtYmVyIC0gUGl4ZWwgd2lkdGggb2YgdGhlIGJhciBzdHJva2UKCQliYXJTdHJva2VXaWR0aCA6IDIsCgoJCS8vTnVtYmVyIC0gU3BhY2luZyBiZXR3ZWVuIGVhY2ggb2YgdGhlIFggdmFsdWUgc2V0cwoJCWJhclZhbHVlU3BhY2luZyA6IDUsCgoJCS8vTnVtYmVyIC0gU3BhY2luZyBiZXR3ZWVuIGRhdGEgc2V0cyB3aXRoaW4gWCB2YWx1ZXMKCQliYXJEYXRhc2V0U3BhY2luZyA6IDEsCgoJCS8vU3RyaW5nIC0gQSBsZWdlbmQgdGVtcGxhdGUKCQlsZWdlbmRUZW1wbGF0ZSA6ICI8dWwgY2xhc3M9XCI8JT1uYW1lLnRvTG93ZXJDYXNlKCklPi1sZWdlbmRcIj48JSBmb3IgKHZhciBpPTA7IGk8ZGF0YXNldHMubGVuZ3RoOyBpKyspeyU+PGxpPjxzcGFuIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjo8JT1kYXRhc2V0c1tpXS5maWxsQ29sb3IlPlwiPjwvc3Bhbj48JWlmKGRhdGFzZXRzW2ldLmxhYmVsKXslPjwlPWRhdGFzZXRzW2ldLmxhYmVsJT48JX0lPjwvbGk+PCV9JT48L3VsPiIKCgl9OwoKCglDaGFydC5UeXBlLmV4dGVuZCh7CgkJbmFtZTogIkJhciIsCgkJZGVmYXVsdHMgOiBkZWZhdWx0Q29uZmlnLAoJCWluaXRpYWxpemU6ICBmdW5jdGlvbihkYXRhKXsKCgkJCS8vRXhwb3NlIG9wdGlvbnMgYXMgYSBzY29wZSB2YXJpYWJsZSBoZXJlIHNvIHdlIGNhbiBhY2Nlc3MgaXQgaW4gdGhlIFNjYWxlQ2xhc3MKCQkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCQl0aGlzLlNjYWxlQ2xhc3MgPSBDaGFydC5TY2FsZS5leHRlbmQoewoJCQkJb2Zmc2V0R3JpZExpbmVzIDogdHJ1ZSwKCQkJCWNhbGN1bGF0ZUJhclggOiBmdW5jdGlvbihkYXRhc2V0Q291bnQsIGRhdGFzZXRJbmRleCwgYmFySW5kZXgpewoJCQkJCS8vUmV1c2FibGUgbWV0aG9kIGZvciBjYWxjdWxhdGluZyB0aGUgeFBvc2l0aW9uIG9mIGEgZ2l2ZW4gYmFyIGJhc2VkIG9uIGRhdGFzZXRJbmRleCAmIHdpZHRoIG9mIHRoZSBiYXIKCQkJCQl2YXIgeFdpZHRoID0gdGhpcy5jYWxjdWxhdGVCYXNlV2lkdGgoKSwKCQkJCQkJeEFic29sdXRlID0gdGhpcy5jYWxjdWxhdGVYKGJhckluZGV4KSAtICh4V2lkdGgvMiksCgkJCQkJCWJhcldpZHRoID0gdGhpcy5jYWxjdWxhdGVCYXJXaWR0aChkYXRhc2V0Q291bnQpOwoKCQkJCQlyZXR1cm4geEFic29sdXRlICsgKGJhcldpZHRoICogZGF0YXNldEluZGV4KSArIChkYXRhc2V0SW5kZXggKiBvcHRpb25zLmJhckRhdGFzZXRTcGFjaW5nKSArIGJhcldpZHRoLzI7CgkJCQl9LAoJCQkJY2FsY3VsYXRlQmFzZVdpZHRoIDogZnVuY3Rpb24oKXsKCQkJCQlyZXR1cm4gKHRoaXMuY2FsY3VsYXRlWCgxKSAtIHRoaXMuY2FsY3VsYXRlWCgwKSkgLSAoMipvcHRpb25zLmJhclZhbHVlU3BhY2luZyk7CgkJCQl9LAoJCQkJY2FsY3VsYXRlQmFyV2lkdGggOiBmdW5jdGlvbihkYXRhc2V0Q291bnQpewoJCQkJCS8vVGhlIHBhZGRpbmcgYmV0d2VlbiBkYXRhc2V0cyBpcyB0byB0aGUgcmlnaHQgb2YgZWFjaCBiYXIsIHByb3ZpZGluZyB0aGF0IHRoZXJlIGFyZSBtb3JlIHRoYW4gMSBkYXRhc2V0CgkJCQkJdmFyIGJhc2VXaWR0aCA9IHRoaXMuY2FsY3VsYXRlQmFzZVdpZHRoKCkgLSAoKGRhdGFzZXRDb3VudCAtIDEpICogb3B0aW9ucy5iYXJEYXRhc2V0U3BhY2luZyk7CgoJCQkJCXJldHVybiAoYmFzZVdpZHRoIC8gZGF0YXNldENvdW50KTsKCQkJCX0KCQkJfSk7CgoJCQl0aGlzLmRhdGFzZXRzID0gW107CgoJCQkvL1NldCB1cCB0b29sdGlwIGV2ZW50cyBvbiB0aGUgY2hhcnQKCQkJaWYgKHRoaXMub3B0aW9ucy5zaG93VG9vbHRpcHMpewoJCQkJaGVscGVycy5iaW5kRXZlbnRzKHRoaXMsIHRoaXMub3B0aW9ucy50b29sdGlwRXZlbnRzLCBmdW5jdGlvbihldnQpewoJCQkJCXZhciBhY3RpdmVCYXJzID0gKGV2dC50eXBlICE9PSAnbW91c2VvdXQnKSA/IHRoaXMuZ2V0QmFyc0F0RXZlbnQoZXZ0KSA6IFtdOwoKCQkJCQl0aGlzLmVhY2hCYXJzKGZ1bmN0aW9uKGJhcil7CgkJCQkJCWJhci5yZXN0b3JlKFsnZmlsbENvbG9yJywgJ3N0cm9rZUNvbG9yJ10pOwoJCQkJCX0pOwoJCQkJCWhlbHBlcnMuZWFjaChhY3RpdmVCYXJzLCBmdW5jdGlvbihhY3RpdmVCYXIpewoJCQkJCQlhY3RpdmVCYXIuZmlsbENvbG9yID0gYWN0aXZlQmFyLmhpZ2hsaWdodEZpbGw7CgkJCQkJCWFjdGl2ZUJhci5zdHJva2VDb2xvciA9IGFjdGl2ZUJhci5oaWdobGlnaHRTdHJva2U7CgkJCQkJfSk7CgkJCQkJdGhpcy5zaG93VG9vbHRpcChhY3RpdmVCYXJzKTsKCQkJCX0pOwoJCQl9CgoJCQkvL0RlY2xhcmUgdGhlIGV4dGVuc2lvbiBvZiB0aGUgZGVmYXVsdCBwb2ludCwgdG8gY2F0ZXIgZm9yIHRoZSBvcHRpb25zIHBhc3NlZCBpbiB0byB0aGUgY29uc3RydWN0b3IKCQkJdGhpcy5CYXJDbGFzcyA9IENoYXJ0LlJlY3RhbmdsZS5leHRlbmQoewoJCQkJc3Ryb2tlV2lkdGggOiB0aGlzLm9wdGlvbnMuYmFyU3Ryb2tlV2lkdGgsCgkJCQlzaG93U3Ryb2tlIDogdGhpcy5vcHRpb25zLmJhclNob3dTdHJva2UsCgkJCQljdHggOiB0aGlzLmNoYXJ0LmN0eAoJCQl9KTsKCgkJCS8vSXRlcmF0ZSB0aHJvdWdoIGVhY2ggb2YgdGhlIGRhdGFzZXRzLCBhbmQgYnVpbGQgdGhpcyBpbnRvIGEgcHJvcGVydHkgb2YgdGhlIGNoYXJ0CgkJCWhlbHBlcnMuZWFjaChkYXRhLmRhdGFzZXRzLGZ1bmN0aW9uKGRhdGFzZXQsZGF0YXNldEluZGV4KXsKCgkJCQl2YXIgZGF0YXNldE9iamVjdCA9IHsKCQkJCQlsYWJlbCA6IGRhdGFzZXQubGFiZWwgfHwgbnVsbCwKCQkJCQlmaWxsQ29sb3IgOiBkYXRhc2V0LmZpbGxDb2xvciwKCQkJCQlzdHJva2VDb2xvciA6IGRhdGFzZXQuc3Ryb2tlQ29sb3IsCgkJCQkJYmFycyA6IFtdCgkJCQl9OwoKCQkJCXRoaXMuZGF0YXNldHMucHVzaChkYXRhc2V0T2JqZWN0KTsKCgkJCQloZWxwZXJzLmVhY2goZGF0YXNldC5kYXRhLGZ1bmN0aW9uKGRhdGFQb2ludCxpbmRleCl7CgkJCQkJLy9BZGQgYSBuZXcgcG9pbnQgZm9yIGVhY2ggcGllY2Ugb2YgZGF0YSwgcGFzc2luZyBhbnkgcmVxdWlyZWQgZGF0YSB0byBkcmF3LgoJCQkJCWRhdGFzZXRPYmplY3QuYmFycy5wdXNoKG5ldyB0aGlzLkJhckNsYXNzKHsKCQkJCQkJdmFsdWUgOiBkYXRhUG9pbnQsCgkJCQkJCWxhYmVsIDogZGF0YS5sYWJlbHNbaW5kZXhdLAoJCQkJCQlkYXRhc2V0TGFiZWw6IGRhdGFzZXQubGFiZWwsCgkJCQkJCXN0cm9rZUNvbG9yIDogZGF0YXNldC5zdHJva2VDb2xvciwKCQkJCQkJZmlsbENvbG9yIDogZGF0YXNldC5maWxsQ29sb3IsCgkJCQkJCWhpZ2hsaWdodEZpbGwgOiBkYXRhc2V0LmhpZ2hsaWdodEZpbGwgfHwgZGF0YXNldC5maWxsQ29sb3IsCgkJCQkJCWhpZ2hsaWdodFN0cm9rZSA6IGRhdGFzZXQuaGlnaGxpZ2h0U3Ryb2tlIHx8IGRhdGFzZXQuc3Ryb2tlQ29sb3IKCQkJCQl9KSk7CgkJCQl9LHRoaXMpOwoKCQkJfSx0aGlzKTsKCgkJCXRoaXMuYnVpbGRTY2FsZShkYXRhLmxhYmVscyk7CgoJCQl0aGlzLkJhckNsYXNzLnByb3RvdHlwZS5iYXNlID0gdGhpcy5zY2FsZS5lbmRQb2ludDsKCgkJCXRoaXMuZWFjaEJhcnMoZnVuY3Rpb24oYmFyLCBpbmRleCwgZGF0YXNldEluZGV4KXsKCQkJCWhlbHBlcnMuZXh0ZW5kKGJhciwgewoJCQkJCXdpZHRoIDogdGhpcy5zY2FsZS5jYWxjdWxhdGVCYXJXaWR0aCh0aGlzLmRhdGFzZXRzLmxlbmd0aCksCgkJCQkJeDogdGhpcy5zY2FsZS5jYWxjdWxhdGVCYXJYKHRoaXMuZGF0YXNldHMubGVuZ3RoLCBkYXRhc2V0SW5kZXgsIGluZGV4KSwKCQkJCQl5OiB0aGlzLnNjYWxlLmVuZFBvaW50CgkJCQl9KTsKCQkJCWJhci5zYXZlKCk7CgkJCX0sIHRoaXMpOwoKCQkJdGhpcy5yZW5kZXIoKTsKCQl9LAoJCXVwZGF0ZSA6IGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2NhbGUudXBkYXRlKCk7CgkJCS8vIFJlc2V0IGFueSBoaWdobGlnaHQgY29sb3VycyBiZWZvcmUgdXBkYXRpbmcuCgkJCWhlbHBlcnMuZWFjaCh0aGlzLmFjdGl2ZUVsZW1lbnRzLCBmdW5jdGlvbihhY3RpdmVFbGVtZW50KXsKCQkJCWFjdGl2ZUVsZW1lbnQucmVzdG9yZShbJ2ZpbGxDb2xvcicsICdzdHJva2VDb2xvciddKTsKCQkJfSk7CgoJCQl0aGlzLmVhY2hCYXJzKGZ1bmN0aW9uKGJhcil7CgkJCQliYXIuc2F2ZSgpOwoJCQl9KTsKCQkJdGhpcy5yZW5kZXIoKTsKCQl9LAoJCWVhY2hCYXJzIDogZnVuY3Rpb24oY2FsbGJhY2spewoJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0LCBkYXRhc2V0SW5kZXgpewoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQuYmFycywgY2FsbGJhY2ssIHRoaXMsIGRhdGFzZXRJbmRleCk7CgkJCX0sdGhpcyk7CgkJfSwKCQlnZXRCYXJzQXRFdmVudCA6IGZ1bmN0aW9uKGUpewoJCQl2YXIgYmFyc0FycmF5ID0gW10sCgkJCQlldmVudFBvc2l0aW9uID0gaGVscGVycy5nZXRSZWxhdGl2ZVBvc2l0aW9uKGUpLAoJCQkJZGF0YXNldEl0ZXJhdG9yID0gZnVuY3Rpb24oZGF0YXNldCl7CgkJCQkJYmFyc0FycmF5LnB1c2goZGF0YXNldC5iYXJzW2JhckluZGV4XSk7CgkJCQl9LAoJCQkJYmFySW5kZXg7CgoJCQlmb3IgKHZhciBkYXRhc2V0SW5kZXggPSAwOyBkYXRhc2V0SW5kZXggPCB0aGlzLmRhdGFzZXRzLmxlbmd0aDsgZGF0YXNldEluZGV4KyspIHsKCQkJCWZvciAoYmFySW5kZXggPSAwOyBiYXJJbmRleCA8IHRoaXMuZGF0YXNldHNbZGF0YXNldEluZGV4XS5iYXJzLmxlbmd0aDsgYmFySW5kZXgrKykgewoJCQkJCWlmICh0aGlzLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uYmFyc1tiYXJJbmRleF0uaW5SYW5nZShldmVudFBvc2l0aW9uLngsZXZlbnRQb3NpdGlvbi55KSl7CgkJCQkJCWhlbHBlcnMuZWFjaCh0aGlzLmRhdGFzZXRzLCBkYXRhc2V0SXRlcmF0b3IpOwoJCQkJCQlyZXR1cm4gYmFyc0FycmF5OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGJhcnNBcnJheTsKCQl9LAoJCWJ1aWxkU2NhbGUgOiBmdW5jdGlvbihsYWJlbHMpewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQl2YXIgZGF0YVRvdGFsID0gZnVuY3Rpb24oKXsKCQkJCXZhciB2YWx1ZXMgPSBbXTsKCQkJCXNlbGYuZWFjaEJhcnMoZnVuY3Rpb24oYmFyKXsKCQkJCQl2YWx1ZXMucHVzaChiYXIudmFsdWUpOwoJCQkJfSk7CgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9OwoKCQkJdmFyIHNjYWxlT3B0aW9ucyA9IHsKCQkJCXRlbXBsYXRlU3RyaW5nIDogdGhpcy5vcHRpb25zLnNjYWxlTGFiZWwsCgkJCQloZWlnaHQgOiB0aGlzLmNoYXJ0LmhlaWdodCwKCQkJCXdpZHRoIDogdGhpcy5jaGFydC53aWR0aCwKCQkJCWN0eCA6IHRoaXMuY2hhcnQuY3R4LAoJCQkJdGV4dENvbG9yIDogdGhpcy5vcHRpb25zLnNjYWxlRm9udENvbG9yLAoJCQkJZm9udFNpemUgOiB0aGlzLm9wdGlvbnMuc2NhbGVGb250U2l6ZSwKCQkJCWZvbnRTdHlsZSA6IHRoaXMub3B0aW9ucy5zY2FsZUZvbnRTdHlsZSwKCQkJCWZvbnRGYW1pbHkgOiB0aGlzLm9wdGlvbnMuc2NhbGVGb250RmFtaWx5LAoJCQkJdmFsdWVzQ291bnQgOiBsYWJlbHMubGVuZ3RoLAoJCQkJYmVnaW5BdFplcm8gOiB0aGlzLm9wdGlvbnMuc2NhbGVCZWdpbkF0WmVybywKCQkJCWludGVnZXJzT25seSA6IHRoaXMub3B0aW9ucy5zY2FsZUludGVnZXJzT25seSwKCQkJCWNhbGN1bGF0ZVlSYW5nZTogZnVuY3Rpb24oY3VycmVudEhlaWdodCl7CgkJCQkJdmFyIHVwZGF0ZWRSYW5nZXMgPSBoZWxwZXJzLmNhbGN1bGF0ZVNjYWxlUmFuZ2UoCgkJCQkJCWRhdGFUb3RhbCgpLAoJCQkJCQljdXJyZW50SGVpZ2h0LAoJCQkJCQl0aGlzLmZvbnRTaXplLAoJCQkJCQl0aGlzLmJlZ2luQXRaZXJvLAoJCQkJCQl0aGlzLmludGVnZXJzT25seQoJCQkJCSk7CgkJCQkJaGVscGVycy5leHRlbmQodGhpcywgdXBkYXRlZFJhbmdlcyk7CgkJCQl9LAoJCQkJeExhYmVscyA6IGxhYmVscywKCQkJCWZvbnQgOiBoZWxwZXJzLmZvbnRTdHJpbmcodGhpcy5vcHRpb25zLnNjYWxlRm9udFNpemUsIHRoaXMub3B0aW9ucy5zY2FsZUZvbnRTdHlsZSwgdGhpcy5vcHRpb25zLnNjYWxlRm9udEZhbWlseSksCgkJCQlsaW5lV2lkdGggOiB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lV2lkdGgsCgkJCQlsaW5lQ29sb3IgOiB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lQ29sb3IsCgkJCQlzaG93SG9yaXpvbnRhbExpbmVzIDogdGhpcy5vcHRpb25zLnNjYWxlU2hvd0hvcml6b250YWxMaW5lcywKCQkJCXNob3dWZXJ0aWNhbExpbmVzIDogdGhpcy5vcHRpb25zLnNjYWxlU2hvd1ZlcnRpY2FsTGluZXMsCgkJCQlncmlkTGluZVdpZHRoIDogKHRoaXMub3B0aW9ucy5zY2FsZVNob3dHcmlkTGluZXMpID8gdGhpcy5vcHRpb25zLnNjYWxlR3JpZExpbmVXaWR0aCA6IDAsCgkJCQlncmlkTGluZUNvbG9yIDogKHRoaXMub3B0aW9ucy5zY2FsZVNob3dHcmlkTGluZXMpID8gdGhpcy5vcHRpb25zLnNjYWxlR3JpZExpbmVDb2xvciA6ICJyZ2JhKDAsMCwwLDApIiwKCQkJCXBhZGRpbmcgOiAodGhpcy5vcHRpb25zLnNob3dTY2FsZSkgPyAwIDogKHRoaXMub3B0aW9ucy5iYXJTaG93U3Ryb2tlKSA/IHRoaXMub3B0aW9ucy5iYXJTdHJva2VXaWR0aCA6IDAsCgkJCQlzaG93TGFiZWxzIDogdGhpcy5vcHRpb25zLnNjYWxlU2hvd0xhYmVscywKCQkJCWRpc3BsYXkgOiB0aGlzLm9wdGlvbnMuc2hvd1NjYWxlCgkJCX07CgoJCQlpZiAodGhpcy5vcHRpb25zLnNjYWxlT3ZlcnJpZGUpewoJCQkJaGVscGVycy5leHRlbmQoc2NhbGVPcHRpb25zLCB7CgkJCQkJY2FsY3VsYXRlWVJhbmdlOiBoZWxwZXJzLm5vb3AsCgkJCQkJc3RlcHM6IHRoaXMub3B0aW9ucy5zY2FsZVN0ZXBzLAoJCQkJCXN0ZXBWYWx1ZTogdGhpcy5vcHRpb25zLnNjYWxlU3RlcFdpZHRoLAoJCQkJCW1pbjogdGhpcy5vcHRpb25zLnNjYWxlU3RhcnRWYWx1ZSwKCQkJCQltYXg6IHRoaXMub3B0aW9ucy5zY2FsZVN0YXJ0VmFsdWUgKyAodGhpcy5vcHRpb25zLnNjYWxlU3RlcHMgKiB0aGlzLm9wdGlvbnMuc2NhbGVTdGVwV2lkdGgpCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5zY2FsZSA9IG5ldyB0aGlzLlNjYWxlQ2xhc3Moc2NhbGVPcHRpb25zKTsKCQl9LAoJCWFkZERhdGEgOiBmdW5jdGlvbih2YWx1ZXNBcnJheSxsYWJlbCl7CgkJCS8vTWFwIHRoZSB2YWx1ZXMgYXJyYXkgZm9yIGVhY2ggb2YgdGhlIGRhdGFzZXRzCgkJCWhlbHBlcnMuZWFjaCh2YWx1ZXNBcnJheSxmdW5jdGlvbih2YWx1ZSxkYXRhc2V0SW5kZXgpewoJCQkJLy9BZGQgYSBuZXcgcG9pbnQgZm9yIGVhY2ggcGllY2Ugb2YgZGF0YSwgcGFzc2luZyBhbnkgcmVxdWlyZWQgZGF0YSB0byBkcmF3LgoJCQkJdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLmJhcnMucHVzaChuZXcgdGhpcy5CYXJDbGFzcyh7CgkJCQkJdmFsdWUgOiB2YWx1ZSwKCQkJCQlsYWJlbCA6IGxhYmVsLAoJCQkJCXg6IHRoaXMuc2NhbGUuY2FsY3VsYXRlQmFyWCh0aGlzLmRhdGFzZXRzLmxlbmd0aCwgZGF0YXNldEluZGV4LCB0aGlzLnNjYWxlLnZhbHVlc0NvdW50KzEpLAoJCQkJCXk6IHRoaXMuc2NhbGUuZW5kUG9pbnQsCgkJCQkJd2lkdGggOiB0aGlzLnNjYWxlLmNhbGN1bGF0ZUJhcldpZHRoKHRoaXMuZGF0YXNldHMubGVuZ3RoKSwKCQkJCQliYXNlIDogdGhpcy5zY2FsZS5lbmRQb2ludCwKCQkJCQlzdHJva2VDb2xvciA6IHRoaXMuZGF0YXNldHNbZGF0YXNldEluZGV4XS5zdHJva2VDb2xvciwKCQkJCQlmaWxsQ29sb3IgOiB0aGlzLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uZmlsbENvbG9yCgkJCQl9KSk7CgkJCX0sdGhpcyk7CgoJCQl0aGlzLnNjYWxlLmFkZFhMYWJlbChsYWJlbCk7CgkJCS8vVGhlbiByZS1yZW5kZXIgdGhlIGNoYXJ0LgoJCQl0aGlzLnVwZGF0ZSgpOwoJCX0sCgkJcmVtb3ZlRGF0YSA6IGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2NhbGUucmVtb3ZlWExhYmVsKCk7CgkJCS8vVGhlbiByZS1yZW5kZXIgdGhlIGNoYXJ0LgoJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0KXsKCQkJCWRhdGFzZXQuYmFycy5zaGlmdCgpOwoJCQl9LHRoaXMpOwoJCQl0aGlzLnVwZGF0ZSgpOwoJCX0sCgkJcmVmbG93IDogZnVuY3Rpb24oKXsKCQkJaGVscGVycy5leHRlbmQodGhpcy5CYXJDbGFzcy5wcm90b3R5cGUsewoJCQkJeTogdGhpcy5zY2FsZS5lbmRQb2ludCwKCQkJCWJhc2UgOiB0aGlzLnNjYWxlLmVuZFBvaW50CgkJCX0pOwoJCQl2YXIgbmV3U2NhbGVQcm9wcyA9IGhlbHBlcnMuZXh0ZW5kKHsKCQkJCWhlaWdodCA6IHRoaXMuY2hhcnQuaGVpZ2h0LAoJCQkJd2lkdGggOiB0aGlzLmNoYXJ0LndpZHRoCgkJCX0pOwoJCQl0aGlzLnNjYWxlLnVwZGF0ZShuZXdTY2FsZVByb3BzKTsKCQl9LAoJCWRyYXcgOiBmdW5jdGlvbihlYXNlKXsKCQkJdmFyIGVhc2luZ0RlY2ltYWwgPSBlYXNlIHx8IDE7CgkJCXRoaXMuY2xlYXIoKTsKCgkJCXZhciBjdHggPSB0aGlzLmNoYXJ0LmN0eDsKCgkJCXRoaXMuc2NhbGUuZHJhdyhlYXNpbmdEZWNpbWFsKTsKCgkJCS8vRHJhdyBhbGwgdGhlIGJhcnMgZm9yIGVhY2ggZGF0YXNldAoJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0LGRhdGFzZXRJbmRleCl7CgkJCQloZWxwZXJzLmVhY2goZGF0YXNldC5iYXJzLGZ1bmN0aW9uKGJhcixpbmRleCl7CgkJCQkJaWYgKGJhci5oYXNWYWx1ZSgpKXsKCQkJCQkJYmFyLmJhc2UgPSB0aGlzLnNjYWxlLmVuZFBvaW50OwoJCQkJCQkvL1RyYW5zaXRpb24gdGhlbiBkcmF3CgkJCQkJCWJhci50cmFuc2l0aW9uKHsKCQkJCQkJCXggOiB0aGlzLnNjYWxlLmNhbGN1bGF0ZUJhclgodGhpcy5kYXRhc2V0cy5sZW5ndGgsIGRhdGFzZXRJbmRleCwgaW5kZXgpLAoJCQkJCQkJeSA6IHRoaXMuc2NhbGUuY2FsY3VsYXRlWShiYXIudmFsdWUpLAoJCQkJCQkJd2lkdGggOiB0aGlzLnNjYWxlLmNhbGN1bGF0ZUJhcldpZHRoKHRoaXMuZGF0YXNldHMubGVuZ3RoKQoJCQkJCQl9LCBlYXNpbmdEZWNpbWFsKS5kcmF3KCk7CgkJCQkJfQoJCQkJfSx0aGlzKTsKCgkJCX0sdGhpcyk7CgkJfQoJfSk7CgoKfSkuY2FsbCh0aGlzKTsKCihmdW5jdGlvbigpewoJInVzZSBzdHJpY3QiOwoKCXZhciByb290ID0gdGhpcywKCQlDaGFydCA9IHJvb3QuQ2hhcnQsCgkJLy9DYWNoZSBhIGxvY2FsIHJlZmVyZW5jZSB0byBDaGFydC5oZWxwZXJzCgkJaGVscGVycyA9IENoYXJ0LmhlbHBlcnM7CgoJdmFyIGRlZmF1bHRDb25maWcgPSB7CgkJLy9Cb29sZWFuIC0gV2hldGhlciB3ZSBzaG91bGQgc2hvdyBhIHN0cm9rZSBvbiBlYWNoIHNlZ21lbnQKCQlzZWdtZW50U2hvd1N0cm9rZSA6IHRydWUsCgoJCS8vU3RyaW5nIC0gVGhlIGNvbG91ciBvZiBlYWNoIHNlZ21lbnQgc3Ryb2tlCgkJc2VnbWVudFN0cm9rZUNvbG9yIDogIiNmZmYiLAoKCQkvL051bWJlciAtIFRoZSB3aWR0aCBvZiBlYWNoIHNlZ21lbnQgc3Ryb2tlCgkJc2VnbWVudFN0cm9rZVdpZHRoIDogMiwKCgkJLy9UaGUgcGVyY2VudGFnZSBvZiB0aGUgY2hhcnQgdGhhdCB3ZSBjdXQgb3V0IG9mIHRoZSBtaWRkbGUuCgkJcGVyY2VudGFnZUlubmVyQ3V0b3V0IDogNTAsCgoJCS8vTnVtYmVyIC0gQW1vdW50IG9mIGFuaW1hdGlvbiBzdGVwcwoJCWFuaW1hdGlvblN0ZXBzIDogMTAwLAoKCQkvL1N0cmluZyAtIEFuaW1hdGlvbiBlYXNpbmcgZWZmZWN0CgkJYW5pbWF0aW9uRWFzaW5nIDogImVhc2VPdXRCb3VuY2UiLAoKCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHdlIGFuaW1hdGUgdGhlIHJvdGF0aW9uIG9mIHRoZSBEb3VnaG51dAoJCWFuaW1hdGVSb3RhdGUgOiB0cnVlLAoKCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHdlIGFuaW1hdGUgc2NhbGluZyB0aGUgRG91Z2hudXQgZnJvbSB0aGUgY2VudHJlCgkJYW5pbWF0ZVNjYWxlIDogZmFsc2UsCgoJCS8vU3RyaW5nIC0gQSBsZWdlbmQgdGVtcGxhdGUKCQlsZWdlbmRUZW1wbGF0ZSA6ICI8dWwgY2xhc3M9XCI8JT1uYW1lLnRvTG93ZXJDYXNlKCklPi1sZWdlbmRcIj48JSBmb3IgKHZhciBpPTA7IGk8c2VnbWVudHMubGVuZ3RoOyBpKyspeyU+PGxpPjxzcGFuIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjo8JT1zZWdtZW50c1tpXS5maWxsQ29sb3IlPlwiPjwvc3Bhbj48JWlmKHNlZ21lbnRzW2ldLmxhYmVsKXslPjwlPXNlZ21lbnRzW2ldLmxhYmVsJT48JX0lPjwvbGk+PCV9JT48L3VsPiIKCgl9OwoKCglDaGFydC5UeXBlLmV4dGVuZCh7CgkJLy9QYXNzaW5nIGluIGEgbmFtZSByZWdpc3RlcnMgdGhpcyBjaGFydCBpbiB0aGUgQ2hhcnQgbmFtZXNwYWNlCgkJbmFtZTogIkRvdWdobnV0IiwKCQkvL1Byb3ZpZGluZyBhIGRlZmF1bHRzIHdpbGwgYWxzbyByZWdpc3RlciB0aGUgZGVhZnVsdHMgaW4gdGhlIGNoYXJ0IG5hbWVzcGFjZQoJCWRlZmF1bHRzIDogZGVmYXVsdENvbmZpZywKCQkvL0luaXRpYWxpemUgaXMgZmlyZWQgd2hlbiB0aGUgY2hhcnQgaXMgaW5pdGlhbGl6ZWQgLSBEYXRhIGlzIHBhc3NlZCBpbiBhcyBhIHBhcmFtZXRlcgoJCS8vQ29uZmlnIGlzIGF1dG9tYXRpY2FsbHkgbWVyZ2VkIGJ5IHRoZSBjb3JlIG9mIENoYXJ0LmpzLCBhbmQgaXMgYXZhaWxhYmxlIGF0IHRoaXMub3B0aW9ucwoJCWluaXRpYWxpemU6ICBmdW5jdGlvbihkYXRhKXsKCgkJCS8vRGVjbGFyZSBzZWdtZW50cyBhcyBhIHN0YXRpYyBwcm9wZXJ0eSB0byBwcmV2ZW50IGluaGVyaXRpbmcgYWNyb3NzIHRoZSBDaGFydCB0eXBlIHByb3RvdHlwZQoJCQl0aGlzLnNlZ21lbnRzID0gW107CgkJCXRoaXMub3V0ZXJSYWRpdXMgPSAoaGVscGVycy5taW4oW3RoaXMuY2hhcnQud2lkdGgsdGhpcy5jaGFydC5oZWlnaHRdKSAtCXRoaXMub3B0aW9ucy5zZWdtZW50U3Ryb2tlV2lkdGgvMikvMjsKCgkJCXRoaXMuU2VnbWVudEFyYyA9IENoYXJ0LkFyYy5leHRlbmQoewoJCQkJY3R4IDogdGhpcy5jaGFydC5jdHgsCgkJCQl4IDogdGhpcy5jaGFydC53aWR0aC8yLAoJCQkJeSA6IHRoaXMuY2hhcnQuaGVpZ2h0LzIKCQkJfSk7CgoJCQkvL1NldCB1cCB0b29sdGlwIGV2ZW50cyBvbiB0aGUgY2hhcnQKCQkJaWYgKHRoaXMub3B0aW9ucy5zaG93VG9vbHRpcHMpewoJCQkJaGVscGVycy5iaW5kRXZlbnRzKHRoaXMsIHRoaXMub3B0aW9ucy50b29sdGlwRXZlbnRzLCBmdW5jdGlvbihldnQpewoJCQkJCXZhciBhY3RpdmVTZWdtZW50cyA9IChldnQudHlwZSAhPT0gJ21vdXNlb3V0JykgPyB0aGlzLmdldFNlZ21lbnRzQXRFdmVudChldnQpIDogW107CgoJCQkJCWhlbHBlcnMuZWFjaCh0aGlzLnNlZ21lbnRzLGZ1bmN0aW9uKHNlZ21lbnQpewoJCQkJCQlzZWdtZW50LnJlc3RvcmUoWyJmaWxsQ29sb3IiXSk7CgkJCQkJfSk7CgkJCQkJaGVscGVycy5lYWNoKGFjdGl2ZVNlZ21lbnRzLGZ1bmN0aW9uKGFjdGl2ZVNlZ21lbnQpewoJCQkJCQlhY3RpdmVTZWdtZW50LmZpbGxDb2xvciA9IGFjdGl2ZVNlZ21lbnQuaGlnaGxpZ2h0Q29sb3I7CgkJCQkJfSk7CgkJCQkJdGhpcy5zaG93VG9vbHRpcChhY3RpdmVTZWdtZW50cyk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLmNhbGN1bGF0ZVRvdGFsKGRhdGEpOwoKCQkJaGVscGVycy5lYWNoKGRhdGEsZnVuY3Rpb24oZGF0YXBvaW50LCBpbmRleCl7CgkJCQl0aGlzLmFkZERhdGEoZGF0YXBvaW50LCBpbmRleCwgdHJ1ZSk7CgkJCX0sdGhpcyk7CgoJCQl0aGlzLnJlbmRlcigpOwoJCX0sCgkJZ2V0U2VnbWVudHNBdEV2ZW50IDogZnVuY3Rpb24oZSl7CgkJCXZhciBzZWdtZW50c0FycmF5ID0gW107CgoJCQl2YXIgbG9jYXRpb24gPSBoZWxwZXJzLmdldFJlbGF0aXZlUG9zaXRpb24oZSk7CgoJCQloZWxwZXJzLmVhY2godGhpcy5zZWdtZW50cyxmdW5jdGlvbihzZWdtZW50KXsKCQkJCWlmIChzZWdtZW50LmluUmFuZ2UobG9jYXRpb24ueCxsb2NhdGlvbi55KSkgc2VnbWVudHNBcnJheS5wdXNoKHNlZ21lbnQpOwoJCQl9LHRoaXMpOwoJCQlyZXR1cm4gc2VnbWVudHNBcnJheTsKCQl9LAoJCWFkZERhdGEgOiBmdW5jdGlvbihzZWdtZW50LCBhdEluZGV4LCBzaWxlbnQpewoJCQl2YXIgaW5kZXggPSBhdEluZGV4IHx8IHRoaXMuc2VnbWVudHMubGVuZ3RoOwoJCQl0aGlzLnNlZ21lbnRzLnNwbGljZShpbmRleCwgMCwgbmV3IHRoaXMuU2VnbWVudEFyYyh7CgkJCQl2YWx1ZSA6IHNlZ21lbnQudmFsdWUsCgkJCQlvdXRlclJhZGl1cyA6ICh0aGlzLm9wdGlvbnMuYW5pbWF0ZVNjYWxlKSA/IDAgOiB0aGlzLm91dGVyUmFkaXVzLAoJCQkJaW5uZXJSYWRpdXMgOiAodGhpcy5vcHRpb25zLmFuaW1hdGVTY2FsZSkgPyAwIDogKHRoaXMub3V0ZXJSYWRpdXMvMTAwKSAqIHRoaXMub3B0aW9ucy5wZXJjZW50YWdlSW5uZXJDdXRvdXQsCgkJCQlmaWxsQ29sb3IgOiBzZWdtZW50LmNvbG9yLAoJCQkJaGlnaGxpZ2h0Q29sb3IgOiBzZWdtZW50LmhpZ2hsaWdodCB8fCBzZWdtZW50LmNvbG9yLAoJCQkJc2hvd1N0cm9rZSA6IHRoaXMub3B0aW9ucy5zZWdtZW50U2hvd1N0cm9rZSwKCQkJCXN0cm9rZVdpZHRoIDogdGhpcy5vcHRpb25zLnNlZ21lbnRTdHJva2VXaWR0aCwKCQkJCXN0cm9rZUNvbG9yIDogdGhpcy5vcHRpb25zLnNlZ21lbnRTdHJva2VDb2xvciwKCQkJCXN0YXJ0QW5nbGUgOiBNYXRoLlBJICogMS41LAoJCQkJY2lyY3VtZmVyZW5jZSA6ICh0aGlzLm9wdGlvbnMuYW5pbWF0ZVJvdGF0ZSkgPyAwIDogdGhpcy5jYWxjdWxhdGVDaXJjdW1mZXJlbmNlKHNlZ21lbnQudmFsdWUpLAoJCQkJbGFiZWwgOiBzZWdtZW50LmxhYmVsCgkJCX0pKTsKCQkJaWYgKCFzaWxlbnQpewoJCQkJdGhpcy5yZWZsb3coKTsKCQkJCXRoaXMudXBkYXRlKCk7CgkJCX0KCQl9LAoJCWNhbGN1bGF0ZUNpcmN1bWZlcmVuY2UgOiBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiAoTWF0aC5QSSoyKSooTWF0aC5hYnModmFsdWUpIC8gdGhpcy50b3RhbCk7CgkJfSwKCQljYWxjdWxhdGVUb3RhbCA6IGZ1bmN0aW9uKGRhdGEpewoJCQl0aGlzLnRvdGFsID0gMDsKCQkJaGVscGVycy5lYWNoKGRhdGEsZnVuY3Rpb24oc2VnbWVudCl7CgkJCQl0aGlzLnRvdGFsICs9IE1hdGguYWJzKHNlZ21lbnQudmFsdWUpOwoJCQl9LHRoaXMpOwoJCX0sCgkJdXBkYXRlIDogZnVuY3Rpb24oKXsKCQkJdGhpcy5jYWxjdWxhdGVUb3RhbCh0aGlzLnNlZ21lbnRzKTsKCgkJCS8vIFJlc2V0IGFueSBoaWdobGlnaHQgY29sb3VycyBiZWZvcmUgdXBkYXRpbmcuCgkJCWhlbHBlcnMuZWFjaCh0aGlzLmFjdGl2ZUVsZW1lbnRzLCBmdW5jdGlvbihhY3RpdmVFbGVtZW50KXsKCQkJCWFjdGl2ZUVsZW1lbnQucmVzdG9yZShbJ2ZpbGxDb2xvciddKTsKCQkJfSk7CgoJCQloZWxwZXJzLmVhY2godGhpcy5zZWdtZW50cyxmdW5jdGlvbihzZWdtZW50KXsKCQkJCXNlZ21lbnQuc2F2ZSgpOwoJCQl9KTsKCQkJdGhpcy5yZW5kZXIoKTsKCQl9LAoKCQlyZW1vdmVEYXRhOiBmdW5jdGlvbihhdEluZGV4KXsKCQkJdmFyIGluZGV4VG9EZWxldGUgPSAoaGVscGVycy5pc051bWJlcihhdEluZGV4KSkgPyBhdEluZGV4IDogdGhpcy5zZWdtZW50cy5sZW5ndGgtMTsKCQkJdGhpcy5zZWdtZW50cy5zcGxpY2UoaW5kZXhUb0RlbGV0ZSwgMSk7CgkJCXRoaXMucmVmbG93KCk7CgkJCXRoaXMudXBkYXRlKCk7CgkJfSwKCgkJcmVmbG93IDogZnVuY3Rpb24oKXsKCQkJaGVscGVycy5leHRlbmQodGhpcy5TZWdtZW50QXJjLnByb3RvdHlwZSx7CgkJCQl4IDogdGhpcy5jaGFydC53aWR0aC8yLAoJCQkJeSA6IHRoaXMuY2hhcnQuaGVpZ2h0LzIKCQkJfSk7CgkJCXRoaXMub3V0ZXJSYWRpdXMgPSAoaGVscGVycy5taW4oW3RoaXMuY2hhcnQud2lkdGgsdGhpcy5jaGFydC5oZWlnaHRdKSAtCXRoaXMub3B0aW9ucy5zZWdtZW50U3Ryb2tlV2lkdGgvMikvMjsKCQkJaGVscGVycy5lYWNoKHRoaXMuc2VnbWVudHMsIGZ1bmN0aW9uKHNlZ21lbnQpewoJCQkJc2VnbWVudC51cGRhdGUoewoJCQkJCW91dGVyUmFkaXVzIDogdGhpcy5vdXRlclJhZGl1cywKCQkJCQlpbm5lclJhZGl1cyA6ICh0aGlzLm91dGVyUmFkaXVzLzEwMCkgKiB0aGlzLm9wdGlvbnMucGVyY2VudGFnZUlubmVyQ3V0b3V0CgkJCQl9KTsKCQkJfSwgdGhpcyk7CgkJfSwKCQlkcmF3IDogZnVuY3Rpb24oZWFzZURlY2ltYWwpewoJCQl2YXIgYW5pbURlY2ltYWwgPSAoZWFzZURlY2ltYWwpID8gZWFzZURlY2ltYWwgOiAxOwoJCQl0aGlzLmNsZWFyKCk7CgkJCWhlbHBlcnMuZWFjaCh0aGlzLnNlZ21lbnRzLGZ1bmN0aW9uKHNlZ21lbnQsaW5kZXgpewoJCQkJc2VnbWVudC50cmFuc2l0aW9uKHsKCQkJCQljaXJjdW1mZXJlbmNlIDogdGhpcy5jYWxjdWxhdGVDaXJjdW1mZXJlbmNlKHNlZ21lbnQudmFsdWUpLAoJCQkJCW91dGVyUmFkaXVzIDogdGhpcy5vdXRlclJhZGl1cywKCQkJCQlpbm5lclJhZGl1cyA6ICh0aGlzLm91dGVyUmFkaXVzLzEwMCkgKiB0aGlzLm9wdGlvbnMucGVyY2VudGFnZUlubmVyQ3V0b3V0CgkJCQl9LGFuaW1EZWNpbWFsKTsKCgkJCQlzZWdtZW50LmVuZEFuZ2xlID0gc2VnbWVudC5zdGFydEFuZ2xlICsgc2VnbWVudC5jaXJjdW1mZXJlbmNlOwoKCQkJCXNlZ21lbnQuZHJhdygpOwoJCQkJaWYgKGluZGV4ID09PSAwKXsKCQkJCQlzZWdtZW50LnN0YXJ0QW5nbGUgPSBNYXRoLlBJICogMS41OwoJCQkJfQoJCQkJLy9DaGVjayB0byBzZWUgaWYgaXQncyB0aGUgbGFzdCBzZWdtZW50LCBpZiBub3QgZ2V0IHRoZSBuZXh0IGFuZCB1cGRhdGUgdGhlIHN0YXJ0IGFuZ2xlCgkJCQlpZiAoaW5kZXggPCB0aGlzLnNlZ21lbnRzLmxlbmd0aC0xKXsKCQkJCQl0aGlzLnNlZ21lbnRzW2luZGV4KzFdLnN0YXJ0QW5nbGUgPSBzZWdtZW50LmVuZEFuZ2xlOwoJCQkJfQoJCQl9LHRoaXMpOwoKCQl9Cgl9KTsKCglDaGFydC50eXBlcy5Eb3VnaG51dC5leHRlbmQoewoJCW5hbWUgOiAiUGllIiwKCQlkZWZhdWx0cyA6IGhlbHBlcnMubWVyZ2UoZGVmYXVsdENvbmZpZyx7cGVyY2VudGFnZUlubmVyQ3V0b3V0IDogMH0pCgl9KTsKCn0pLmNhbGwodGhpcyk7CihmdW5jdGlvbigpewoJInVzZSBzdHJpY3QiOwoKCXZhciByb290ID0gdGhpcywKCQlDaGFydCA9IHJvb3QuQ2hhcnQsCgkJaGVscGVycyA9IENoYXJ0LmhlbHBlcnM7CgoJdmFyIGRlZmF1bHRDb25maWcgPSB7CgoJCS8vL0Jvb2xlYW4gLSBXaGV0aGVyIGdyaWQgbGluZXMgYXJlIHNob3duIGFjcm9zcyB0aGUgY2hhcnQKCQlzY2FsZVNob3dHcmlkTGluZXMgOiB0cnVlLAoKCQkvL1N0cmluZyAtIENvbG91ciBvZiB0aGUgZ3JpZCBsaW5lcwoJCXNjYWxlR3JpZExpbmVDb2xvciA6ICJyZ2JhKDAsMCwwLC4wNSkiLAoKCQkvL051bWJlciAtIFdpZHRoIG9mIHRoZSBncmlkIGxpbmVzCgkJc2NhbGVHcmlkTGluZVdpZHRoIDogMSwKCgkJLy9Cb29sZWFuIC0gV2hldGhlciB0byBzaG93IGhvcml6b250YWwgbGluZXMgKGV4Y2VwdCBYIGF4aXMpCgkJc2NhbGVTaG93SG9yaXpvbnRhbExpbmVzOiB0cnVlLAoKCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHRvIHNob3cgdmVydGljYWwgbGluZXMgKGV4Y2VwdCBZIGF4aXMpCgkJc2NhbGVTaG93VmVydGljYWxMaW5lczogdHJ1ZSwKCgkJLy9Cb29sZWFuIC0gV2hldGhlciB0aGUgbGluZSBpcyBjdXJ2ZWQgYmV0d2VlbiBwb2ludHMKCQliZXppZXJDdXJ2ZSA6IHRydWUsCgoJCS8vTnVtYmVyIC0gVGVuc2lvbiBvZiB0aGUgYmV6aWVyIGN1cnZlIGJldHdlZW4gcG9pbnRzCgkJYmV6aWVyQ3VydmVUZW5zaW9uIDogMC40LAoKCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHRvIHNob3cgYSBkb3QgZm9yIGVhY2ggcG9pbnQKCQlwb2ludERvdCA6IHRydWUsCgoJCS8vTnVtYmVyIC0gUmFkaXVzIG9mIGVhY2ggcG9pbnQgZG90IGluIHBpeGVscwoJCXBvaW50RG90UmFkaXVzIDogNCwKCgkJLy9OdW1iZXIgLSBQaXhlbCB3aWR0aCBvZiBwb2ludCBkb3Qgc3Ryb2tlCgkJcG9pbnREb3RTdHJva2VXaWR0aCA6IDEsCgoJCS8vTnVtYmVyIC0gYW1vdW50IGV4dHJhIHRvIGFkZCB0byB0aGUgcmFkaXVzIHRvIGNhdGVyIGZvciBoaXQgZGV0ZWN0aW9uIG91dHNpZGUgdGhlIGRyYXduIHBvaW50CgkJcG9pbnRIaXREZXRlY3Rpb25SYWRpdXMgOiAyMCwKCgkJLy9Cb29sZWFuIC0gV2hldGhlciB0byBzaG93IGEgc3Ryb2tlIGZvciBkYXRhc2V0cwoJCWRhdGFzZXRTdHJva2UgOiB0cnVlLAoKCQkvL051bWJlciAtIFBpeGVsIHdpZHRoIG9mIGRhdGFzZXQgc3Ryb2tlCgkJZGF0YXNldFN0cm9rZVdpZHRoIDogMiwKCgkJLy9Cb29sZWFuIC0gV2hldGhlciB0byBmaWxsIHRoZSBkYXRhc2V0IHdpdGggYSBjb2xvdXIKCQlkYXRhc2V0RmlsbCA6IHRydWUsCgoJCS8vU3RyaW5nIC0gQSBsZWdlbmQgdGVtcGxhdGUKCQlsZWdlbmRUZW1wbGF0ZSA6ICI8dWwgY2xhc3M9XCI8JT1uYW1lLnRvTG93ZXJDYXNlKCklPi1sZWdlbmRcIj48JSBmb3IgKHZhciBpPTA7IGk8ZGF0YXNldHMubGVuZ3RoOyBpKyspeyU+PGxpPjxzcGFuIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjo8JT1kYXRhc2V0c1tpXS5zdHJva2VDb2xvciU+XCI+PC9zcGFuPjwlaWYoZGF0YXNldHNbaV0ubGFiZWwpeyU+PCU9ZGF0YXNldHNbaV0ubGFiZWwlPjwlfSU+PC9saT48JX0lPjwvdWw+IgoKCX07CgoKCUNoYXJ0LlR5cGUuZXh0ZW5kKHsKCQluYW1lOiAiTGluZSIsCgkJZGVmYXVsdHMgOiBkZWZhdWx0Q29uZmlnLAoJCWluaXRpYWxpemU6ICBmdW5jdGlvbihkYXRhKXsKCQkJLy9EZWNsYXJlIHRoZSBleHRlbnNpb24gb2YgdGhlIGRlZmF1bHQgcG9pbnQsIHRvIGNhdGVyIGZvciB0aGUgb3B0aW9ucyBwYXNzZWQgaW4gdG8gdGhlIGNvbnN0cnVjdG9yCgkJCXRoaXMuUG9pbnRDbGFzcyA9IENoYXJ0LlBvaW50LmV4dGVuZCh7CgkJCQlzdHJva2VXaWR0aCA6IHRoaXMub3B0aW9ucy5wb2ludERvdFN0cm9rZVdpZHRoLAoJCQkJcmFkaXVzIDogdGhpcy5vcHRpb25zLnBvaW50RG90UmFkaXVzLAoJCQkJZGlzcGxheTogdGhpcy5vcHRpb25zLnBvaW50RG90LAoJCQkJaGl0RGV0ZWN0aW9uUmFkaXVzIDogdGhpcy5vcHRpb25zLnBvaW50SGl0RGV0ZWN0aW9uUmFkaXVzLAoJCQkJY3R4IDogdGhpcy5jaGFydC5jdHgsCgkJCQlpblJhbmdlIDogZnVuY3Rpb24obW91c2VYKXsKCQkJCQlyZXR1cm4gKE1hdGgucG93KG1vdXNlWC10aGlzLngsIDIpIDwgTWF0aC5wb3codGhpcy5yYWRpdXMgKyB0aGlzLmhpdERldGVjdGlvblJhZGl1cywyKSk7CgkJCQl9CgkJCX0pOwoKCQkJdGhpcy5kYXRhc2V0cyA9IFtdOwoKCQkJLy9TZXQgdXAgdG9vbHRpcCBldmVudHMgb24gdGhlIGNoYXJ0CgkJCWlmICh0aGlzLm9wdGlvbnMuc2hvd1Rvb2x0aXBzKXsKCQkJCWhlbHBlcnMuYmluZEV2ZW50cyh0aGlzLCB0aGlzLm9wdGlvbnMudG9vbHRpcEV2ZW50cywgZnVuY3Rpb24oZXZ0KXsKCQkJCQl2YXIgYWN0aXZlUG9pbnRzID0gKGV2dC50eXBlICE9PSAnbW91c2VvdXQnKSA/IHRoaXMuZ2V0UG9pbnRzQXRFdmVudChldnQpIDogW107CgkJCQkJdGhpcy5lYWNoUG9pbnRzKGZ1bmN0aW9uKHBvaW50KXsKCQkJCQkJcG9pbnQucmVzdG9yZShbJ2ZpbGxDb2xvcicsICdzdHJva2VDb2xvciddKTsKCQkJCQl9KTsKCQkJCQloZWxwZXJzLmVhY2goYWN0aXZlUG9pbnRzLCBmdW5jdGlvbihhY3RpdmVQb2ludCl7CgkJCQkJCWFjdGl2ZVBvaW50LmZpbGxDb2xvciA9IGFjdGl2ZVBvaW50LmhpZ2hsaWdodEZpbGw7CgkJCQkJCWFjdGl2ZVBvaW50LnN0cm9rZUNvbG9yID0gYWN0aXZlUG9pbnQuaGlnaGxpZ2h0U3Ryb2tlOwoJCQkJCX0pOwoJCQkJCXRoaXMuc2hvd1Rvb2x0aXAoYWN0aXZlUG9pbnRzKTsKCQkJCX0pOwoJCQl9CgoJCQkvL0l0ZXJhdGUgdGhyb3VnaCBlYWNoIG9mIHRoZSBkYXRhc2V0cywgYW5kIGJ1aWxkIHRoaXMgaW50byBhIHByb3BlcnR5IG9mIHRoZSBjaGFydAoJCQloZWxwZXJzLmVhY2goZGF0YS5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0KXsKCgkJCQl2YXIgZGF0YXNldE9iamVjdCA9IHsKCQkJCQlsYWJlbCA6IGRhdGFzZXQubGFiZWwgfHwgbnVsbCwKCQkJCQlmaWxsQ29sb3IgOiBkYXRhc2V0LmZpbGxDb2xvciwKCQkJCQlzdHJva2VDb2xvciA6IGRhdGFzZXQuc3Ryb2tlQ29sb3IsCgkJCQkJcG9pbnRDb2xvciA6IGRhdGFzZXQucG9pbnRDb2xvciwKCQkJCQlwb2ludFN0cm9rZUNvbG9yIDogZGF0YXNldC5wb2ludFN0cm9rZUNvbG9yLAoJCQkJCXBvaW50cyA6IFtdCgkJCQl9OwoKCQkJCXRoaXMuZGF0YXNldHMucHVzaChkYXRhc2V0T2JqZWN0KTsKCgoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQuZGF0YSxmdW5jdGlvbihkYXRhUG9pbnQsaW5kZXgpewoJCQkJCS8vQWRkIGEgbmV3IHBvaW50IGZvciBlYWNoIHBpZWNlIG9mIGRhdGEsIHBhc3NpbmcgYW55IHJlcXVpcmVkIGRhdGEgdG8gZHJhdy4KCQkJCQlkYXRhc2V0T2JqZWN0LnBvaW50cy5wdXNoKG5ldyB0aGlzLlBvaW50Q2xhc3MoewoJCQkJCQl2YWx1ZSA6IGRhdGFQb2ludCwKCQkJCQkJbGFiZWwgOiBkYXRhLmxhYmVsc1tpbmRleF0sCgkJCQkJCWRhdGFzZXRMYWJlbDogZGF0YXNldC5sYWJlbCwKCQkJCQkJc3Ryb2tlQ29sb3IgOiBkYXRhc2V0LnBvaW50U3Ryb2tlQ29sb3IsCgkJCQkJCWZpbGxDb2xvciA6IGRhdGFzZXQucG9pbnRDb2xvciwKCQkJCQkJaGlnaGxpZ2h0RmlsbCA6IGRhdGFzZXQucG9pbnRIaWdobGlnaHRGaWxsIHx8IGRhdGFzZXQucG9pbnRDb2xvciwKCQkJCQkJaGlnaGxpZ2h0U3Ryb2tlIDogZGF0YXNldC5wb2ludEhpZ2hsaWdodFN0cm9rZSB8fCBkYXRhc2V0LnBvaW50U3Ryb2tlQ29sb3IKCQkJCQl9KSk7CgkJCQl9LHRoaXMpOwoKCQkJCXRoaXMuYnVpbGRTY2FsZShkYXRhLmxhYmVscyk7CgoKCQkJCXRoaXMuZWFjaFBvaW50cyhmdW5jdGlvbihwb2ludCwgaW5kZXgpewoJCQkJCWhlbHBlcnMuZXh0ZW5kKHBvaW50LCB7CgkJCQkJCXg6IHRoaXMuc2NhbGUuY2FsY3VsYXRlWChpbmRleCksCgkJCQkJCXk6IHRoaXMuc2NhbGUuZW5kUG9pbnQKCQkJCQl9KTsKCQkJCQlwb2ludC5zYXZlKCk7CgkJCQl9LCB0aGlzKTsKCgkJCX0sdGhpcyk7CgoKCQkJdGhpcy5yZW5kZXIoKTsKCQl9LAoJCXVwZGF0ZSA6IGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2NhbGUudXBkYXRlKCk7CgkJCS8vIFJlc2V0IGFueSBoaWdobGlnaHQgY29sb3VycyBiZWZvcmUgdXBkYXRpbmcuCgkJCWhlbHBlcnMuZWFjaCh0aGlzLmFjdGl2ZUVsZW1lbnRzLCBmdW5jdGlvbihhY3RpdmVFbGVtZW50KXsKCQkJCWFjdGl2ZUVsZW1lbnQucmVzdG9yZShbJ2ZpbGxDb2xvcicsICdzdHJva2VDb2xvciddKTsKCQkJfSk7CgkJCXRoaXMuZWFjaFBvaW50cyhmdW5jdGlvbihwb2ludCl7CgkJCQlwb2ludC5zYXZlKCk7CgkJCX0pOwoJCQl0aGlzLnJlbmRlcigpOwoJCX0sCgkJZWFjaFBvaW50cyA6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKCQkJaGVscGVycy5lYWNoKHRoaXMuZGF0YXNldHMsZnVuY3Rpb24oZGF0YXNldCl7CgkJCQloZWxwZXJzLmVhY2goZGF0YXNldC5wb2ludHMsY2FsbGJhY2ssdGhpcyk7CgkJCX0sdGhpcyk7CgkJfSwKCQlnZXRQb2ludHNBdEV2ZW50IDogZnVuY3Rpb24oZSl7CgkJCXZhciBwb2ludHNBcnJheSA9IFtdLAoJCQkJZXZlbnRQb3NpdGlvbiA9IGhlbHBlcnMuZ2V0UmVsYXRpdmVQb3NpdGlvbihlKTsKCQkJaGVscGVycy5lYWNoKHRoaXMuZGF0YXNldHMsZnVuY3Rpb24oZGF0YXNldCl7CgkJCQloZWxwZXJzLmVhY2goZGF0YXNldC5wb2ludHMsZnVuY3Rpb24ocG9pbnQpewoJCQkJCWlmIChwb2ludC5pblJhbmdlKGV2ZW50UG9zaXRpb24ueCxldmVudFBvc2l0aW9uLnkpKSBwb2ludHNBcnJheS5wdXNoKHBvaW50KTsKCQkJCX0pOwoJCQl9LHRoaXMpOwoJCQlyZXR1cm4gcG9pbnRzQXJyYXk7CgkJfSwKCQlidWlsZFNjYWxlIDogZnVuY3Rpb24obGFiZWxzKXsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJdmFyIGRhdGFUb3RhbCA9IGZ1bmN0aW9uKCl7CgkJCQl2YXIgdmFsdWVzID0gW107CgkJCQlzZWxmLmVhY2hQb2ludHMoZnVuY3Rpb24ocG9pbnQpewoJCQkJCXZhbHVlcy5wdXNoKHBvaW50LnZhbHVlKTsKCQkJCX0pOwoKCQkJCXJldHVybiB2YWx1ZXM7CgkJCX07CgoJCQl2YXIgc2NhbGVPcHRpb25zID0gewoJCQkJdGVtcGxhdGVTdHJpbmcgOiB0aGlzLm9wdGlvbnMuc2NhbGVMYWJlbCwKCQkJCWhlaWdodCA6IHRoaXMuY2hhcnQuaGVpZ2h0LAoJCQkJd2lkdGggOiB0aGlzLmNoYXJ0LndpZHRoLAoJCQkJY3R4IDogdGhpcy5jaGFydC5jdHgsCgkJCQl0ZXh0Q29sb3IgOiB0aGlzLm9wdGlvbnMuc2NhbGVGb250Q29sb3IsCgkJCQlmb250U2l6ZSA6IHRoaXMub3B0aW9ucy5zY2FsZUZvbnRTaXplLAoJCQkJZm9udFN0eWxlIDogdGhpcy5vcHRpb25zLnNjYWxlRm9udFN0eWxlLAoJCQkJZm9udEZhbWlseSA6IHRoaXMub3B0aW9ucy5zY2FsZUZvbnRGYW1pbHksCgkJCQl2YWx1ZXNDb3VudCA6IGxhYmVscy5sZW5ndGgsCgkJCQliZWdpbkF0WmVybyA6IHRoaXMub3B0aW9ucy5zY2FsZUJlZ2luQXRaZXJvLAoJCQkJaW50ZWdlcnNPbmx5IDogdGhpcy5vcHRpb25zLnNjYWxlSW50ZWdlcnNPbmx5LAoJCQkJY2FsY3VsYXRlWVJhbmdlIDogZnVuY3Rpb24oY3VycmVudEhlaWdodCl7CgkJCQkJdmFyIHVwZGF0ZWRSYW5nZXMgPSBoZWxwZXJzLmNhbGN1bGF0ZVNjYWxlUmFuZ2UoCgkJCQkJCWRhdGFUb3RhbCgpLAoJCQkJCQljdXJyZW50SGVpZ2h0LAoJCQkJCQl0aGlzLmZvbnRTaXplLAoJCQkJCQl0aGlzLmJlZ2luQXRaZXJvLAoJCQkJCQl0aGlzLmludGVnZXJzT25seQoJCQkJCSk7CgkJCQkJaGVscGVycy5leHRlbmQodGhpcywgdXBkYXRlZFJhbmdlcyk7CgkJCQl9LAoJCQkJeExhYmVscyA6IGxhYmVscywKCQkJCWZvbnQgOiBoZWxwZXJzLmZvbnRTdHJpbmcodGhpcy5vcHRpb25zLnNjYWxlRm9udFNpemUsIHRoaXMub3B0aW9ucy5zY2FsZUZvbnRTdHlsZSwgdGhpcy5vcHRpb25zLnNjYWxlRm9udEZhbWlseSksCgkJCQlsaW5lV2lkdGggOiB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lV2lkdGgsCgkJCQlsaW5lQ29sb3IgOiB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lQ29sb3IsCgkJCQlzaG93SG9yaXpvbnRhbExpbmVzIDogdGhpcy5vcHRpb25zLnNjYWxlU2hvd0hvcml6b250YWxMaW5lcywKCQkJCXNob3dWZXJ0aWNhbExpbmVzIDogdGhpcy5vcHRpb25zLnNjYWxlU2hvd1ZlcnRpY2FsTGluZXMsCgkJCQlncmlkTGluZVdpZHRoIDogKHRoaXMub3B0aW9ucy5zY2FsZVNob3dHcmlkTGluZXMpID8gdGhpcy5vcHRpb25zLnNjYWxlR3JpZExpbmVXaWR0aCA6IDAsCgkJCQlncmlkTGluZUNvbG9yIDogKHRoaXMub3B0aW9ucy5zY2FsZVNob3dHcmlkTGluZXMpID8gdGhpcy5vcHRpb25zLnNjYWxlR3JpZExpbmVDb2xvciA6ICJyZ2JhKDAsMCwwLDApIiwKCQkJCXBhZGRpbmc6ICh0aGlzLm9wdGlvbnMuc2hvd1NjYWxlKSA/IDAgOiB0aGlzLm9wdGlvbnMucG9pbnREb3RSYWRpdXMgKyB0aGlzLm9wdGlvbnMucG9pbnREb3RTdHJva2VXaWR0aCwKCQkJCXNob3dMYWJlbHMgOiB0aGlzLm9wdGlvbnMuc2NhbGVTaG93TGFiZWxzLAoJCQkJZGlzcGxheSA6IHRoaXMub3B0aW9ucy5zaG93U2NhbGUKCQkJfTsKCgkJCWlmICh0aGlzLm9wdGlvbnMuc2NhbGVPdmVycmlkZSl7CgkJCQloZWxwZXJzLmV4dGVuZChzY2FsZU9wdGlvbnMsIHsKCQkJCQljYWxjdWxhdGVZUmFuZ2U6IGhlbHBlcnMubm9vcCwKCQkJCQlzdGVwczogdGhpcy5vcHRpb25zLnNjYWxlU3RlcHMsCgkJCQkJc3RlcFZhbHVlOiB0aGlzLm9wdGlvbnMuc2NhbGVTdGVwV2lkdGgsCgkJCQkJbWluOiB0aGlzLm9wdGlvbnMuc2NhbGVTdGFydFZhbHVlLAoJCQkJCW1heDogdGhpcy5vcHRpb25zLnNjYWxlU3RhcnRWYWx1ZSArICh0aGlzLm9wdGlvbnMuc2NhbGVTdGVwcyAqIHRoaXMub3B0aW9ucy5zY2FsZVN0ZXBXaWR0aCkKCQkJCX0pOwoJCQl9CgoKCQkJdGhpcy5zY2FsZSA9IG5ldyBDaGFydC5TY2FsZShzY2FsZU9wdGlvbnMpOwoJCX0sCgkJYWRkRGF0YSA6IGZ1bmN0aW9uKHZhbHVlc0FycmF5LGxhYmVsKXsKCQkJLy9NYXAgdGhlIHZhbHVlcyBhcnJheSBmb3IgZWFjaCBvZiB0aGUgZGF0YXNldHMKCgkJCWhlbHBlcnMuZWFjaCh2YWx1ZXNBcnJheSxmdW5jdGlvbih2YWx1ZSxkYXRhc2V0SW5kZXgpewoJCQkJLy9BZGQgYSBuZXcgcG9pbnQgZm9yIGVhY2ggcGllY2Ugb2YgZGF0YSwgcGFzc2luZyBhbnkgcmVxdWlyZWQgZGF0YSB0byBkcmF3LgoJCQkJdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLnBvaW50cy5wdXNoKG5ldyB0aGlzLlBvaW50Q2xhc3MoewoJCQkJCXZhbHVlIDogdmFsdWUsCgkJCQkJbGFiZWwgOiBsYWJlbCwKCQkJCQl4OiB0aGlzLnNjYWxlLmNhbGN1bGF0ZVgodGhpcy5zY2FsZS52YWx1ZXNDb3VudCsxKSwKCQkJCQl5OiB0aGlzLnNjYWxlLmVuZFBvaW50LAoJCQkJCXN0cm9rZUNvbG9yIDogdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLnBvaW50U3Ryb2tlQ29sb3IsCgkJCQkJZmlsbENvbG9yIDogdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLnBvaW50Q29sb3IKCQkJCX0pKTsKCQkJfSx0aGlzKTsKCgkJCXRoaXMuc2NhbGUuYWRkWExhYmVsKGxhYmVsKTsKCQkJLy9UaGVuIHJlLXJlbmRlciB0aGUgY2hhcnQuCgkJCXRoaXMudXBkYXRlKCk7CgkJfSwKCQlyZW1vdmVEYXRhIDogZnVuY3Rpb24oKXsKCQkJdGhpcy5zY2FsZS5yZW1vdmVYTGFiZWwoKTsKCQkJLy9UaGVuIHJlLXJlbmRlciB0aGUgY2hhcnQuCgkJCWhlbHBlcnMuZWFjaCh0aGlzLmRhdGFzZXRzLGZ1bmN0aW9uKGRhdGFzZXQpewoJCQkJZGF0YXNldC5wb2ludHMuc2hpZnQoKTsKCQkJfSx0aGlzKTsKCQkJdGhpcy51cGRhdGUoKTsKCQl9LAoJCXJlZmxvdyA6IGZ1bmN0aW9uKCl7CgkJCXZhciBuZXdTY2FsZVByb3BzID0gaGVscGVycy5leHRlbmQoewoJCQkJaGVpZ2h0IDogdGhpcy5jaGFydC5oZWlnaHQsCgkJCQl3aWR0aCA6IHRoaXMuY2hhcnQud2lkdGgKCQkJfSk7CgkJCXRoaXMuc2NhbGUudXBkYXRlKG5ld1NjYWxlUHJvcHMpOwoJCX0sCgkJZHJhdyA6IGZ1bmN0aW9uKGVhc2UpewoJCQl2YXIgZWFzaW5nRGVjaW1hbCA9IGVhc2UgfHwgMTsKCQkJdGhpcy5jbGVhcigpOwoKCQkJdmFyIGN0eCA9IHRoaXMuY2hhcnQuY3R4OwoKCQkJLy8gU29tZSBoZWxwZXIgbWV0aG9kcyBmb3IgZ2V0dGluZyB0aGUgbmV4dC9wcmV2IHBvaW50cwoJCQl2YXIgaGFzVmFsdWUgPSBmdW5jdGlvbihpdGVtKXsKCQkJCXJldHVybiBpdGVtLnZhbHVlICE9PSBudWxsOwoJCQl9LAoJCQluZXh0UG9pbnQgPSBmdW5jdGlvbihwb2ludCwgY29sbGVjdGlvbiwgaW5kZXgpewoJCQkJcmV0dXJuIGhlbHBlcnMuZmluZE5leHRXaGVyZShjb2xsZWN0aW9uLCBoYXNWYWx1ZSwgaW5kZXgpIHx8IHBvaW50OwoJCQl9LAoJCQlwcmV2aW91c1BvaW50ID0gZnVuY3Rpb24ocG9pbnQsIGNvbGxlY3Rpb24sIGluZGV4KXsKCQkJCXJldHVybiBoZWxwZXJzLmZpbmRQcmV2aW91c1doZXJlKGNvbGxlY3Rpb24sIGhhc1ZhbHVlLCBpbmRleCkgfHwgcG9pbnQ7CgkJCX07CgoJCQl0aGlzLnNjYWxlLmRyYXcoZWFzaW5nRGVjaW1hbCk7CgoKCQkJaGVscGVycy5lYWNoKHRoaXMuZGF0YXNldHMsZnVuY3Rpb24oZGF0YXNldCl7CgkJCQl2YXIgcG9pbnRzV2l0aFZhbHVlcyA9IGhlbHBlcnMud2hlcmUoZGF0YXNldC5wb2ludHMsIGhhc1ZhbHVlKTsKCgkJCQkvL1RyYW5zaXRpb24gZWFjaCBwb2ludCBmaXJzdCBzbyB0aGF0IHRoZSBsaW5lIGFuZCBwb2ludCBkcmF3aW5nIGlzbid0IG91dCBvZiBzeW5jCgkJCQkvL1dlIGNhbiB1c2UgdGhpcyBleHRyYSBsb29wIHRvIGNhbGN1bGF0ZSB0aGUgY29udHJvbCBwb2ludHMgb2YgdGhpcyBkYXRhc2V0IGFsc28gaW4gdGhpcyBsb29wCgoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQucG9pbnRzLCBmdW5jdGlvbihwb2ludCwgaW5kZXgpewoJCQkJCWlmIChwb2ludC5oYXNWYWx1ZSgpKXsKCQkJCQkJcG9pbnQudHJhbnNpdGlvbih7CgkJCQkJCQl5IDogdGhpcy5zY2FsZS5jYWxjdWxhdGVZKHBvaW50LnZhbHVlKSwKCQkJCQkJCXggOiB0aGlzLnNjYWxlLmNhbGN1bGF0ZVgoaW5kZXgpCgkJCQkJCX0sIGVhc2luZ0RlY2ltYWwpOwoJCQkJCX0KCQkJCX0sdGhpcyk7CgoKCQkJCS8vIENvbnRyb2wgcG9pbnRzIG5lZWQgdG8gYmUgY2FsY3VsYXRlZCBpbiBhIHNlcGVyYXRlIGxvb3AsIGJlY2F1c2Ugd2UgbmVlZCB0byBrbm93IHRoZSBjdXJyZW50IHgveSBvZiB0aGUgcG9pbnQKCQkJCS8vIFRoaXMgd291bGQgY2F1c2UgaXNzdWVzIHdoZW4gdGhlcmUgaXMgbm8gYW5pbWF0aW9uLCBiZWNhdXNlIHRoZSB5IG9mIHRoZSBuZXh0IHBvaW50IHdvdWxkIGJlIDAsIHNvIGJlemllcnMgd291bGQgYmUgc2tld2VkCgkJCQlpZiAodGhpcy5vcHRpb25zLmJlemllckN1cnZlKXsKCQkJCQloZWxwZXJzLmVhY2gocG9pbnRzV2l0aFZhbHVlcywgZnVuY3Rpb24ocG9pbnQsIGluZGV4KXsKCQkJCQkJdmFyIHRlbnNpb24gPSAoaW5kZXggPiAwICYmIGluZGV4IDwgcG9pbnRzV2l0aFZhbHVlcy5sZW5ndGggLSAxKSA/IHRoaXMub3B0aW9ucy5iZXppZXJDdXJ2ZVRlbnNpb24gOiAwOwoJCQkJCQlwb2ludC5jb250cm9sUG9pbnRzID0gaGVscGVycy5zcGxpbmVDdXJ2ZSgKCQkJCQkJCXByZXZpb3VzUG9pbnQocG9pbnQsIHBvaW50c1dpdGhWYWx1ZXMsIGluZGV4KSwKCQkJCQkJCXBvaW50LAoJCQkJCQkJbmV4dFBvaW50KHBvaW50LCBwb2ludHNXaXRoVmFsdWVzLCBpbmRleCksCgkJCQkJCQl0ZW5zaW9uCgkJCQkJCSk7CgoJCQkJCQkvLyBQcmV2ZW50IHRoZSBiZXppZXIgZ29pbmcgb3V0c2lkZSBvZiB0aGUgYm91bmRzIG9mIHRoZSBncmFwaAoKCQkJCQkJLy8gQ2FwIHB1dGVyIGJlemllciBoYW5kbGVzIHRvIHRoZSB1cHBlci9sb3dlciBzY2FsZSBib3VuZHMKCQkJCQkJaWYgKHBvaW50LmNvbnRyb2xQb2ludHMub3V0ZXIueSA+IHRoaXMuc2NhbGUuZW5kUG9pbnQpewoJCQkJCQkJcG9pbnQuY29udHJvbFBvaW50cy5vdXRlci55ID0gdGhpcy5zY2FsZS5lbmRQb2ludDsKCQkJCQkJfQoJCQkJCQllbHNlIGlmIChwb2ludC5jb250cm9sUG9pbnRzLm91dGVyLnkgPCB0aGlzLnNjYWxlLnN0YXJ0UG9pbnQpewoJCQkJCQkJcG9pbnQuY29udHJvbFBvaW50cy5vdXRlci55ID0gdGhpcy5zY2FsZS5zdGFydFBvaW50OwoJCQkJCQl9CgoJCQkJCQkvLyBDYXAgaW5uZXIgYmV6aWVyIGhhbmRsZXMgdG8gdGhlIHVwcGVyL2xvd2VyIHNjYWxlIGJvdW5kcwoJCQkJCQlpZiAocG9pbnQuY29udHJvbFBvaW50cy5pbm5lci55ID4gdGhpcy5zY2FsZS5lbmRQb2ludCl7CgkJCQkJCQlwb2ludC5jb250cm9sUG9pbnRzLmlubmVyLnkgPSB0aGlzLnNjYWxlLmVuZFBvaW50OwoJCQkJCQl9CgkJCQkJCWVsc2UgaWYgKHBvaW50LmNvbnRyb2xQb2ludHMuaW5uZXIueSA8IHRoaXMuc2NhbGUuc3RhcnRQb2ludCl7CgkJCQkJCQlwb2ludC5jb250cm9sUG9pbnRzLmlubmVyLnkgPSB0aGlzLnNjYWxlLnN0YXJ0UG9pbnQ7CgkJCQkJCX0KCQkJCQl9LHRoaXMpOwoJCQkJfQoKCgkJCQkvL0RyYXcgdGhlIGxpbmUgYmV0d2VlbiBhbGwgdGhlIHBvaW50cwoJCQkJY3R4LmxpbmVXaWR0aCA9IHRoaXMub3B0aW9ucy5kYXRhc2V0U3Ryb2tlV2lkdGg7CgkJCQljdHguc3Ryb2tlU3R5bGUgPSBkYXRhc2V0LnN0cm9rZUNvbG9yOwoJCQkJY3R4LmJlZ2luUGF0aCgpOwoKCQkJCWhlbHBlcnMuZWFjaChwb2ludHNXaXRoVmFsdWVzLCBmdW5jdGlvbihwb2ludCwgaW5kZXgpewoJCQkJCWlmIChpbmRleCA9PT0gMCl7CgkJCQkJCWN0eC5tb3ZlVG8ocG9pbnQueCwgcG9pbnQueSk7CgkJCQkJfQoJCQkJCWVsc2V7CgkJCQkJCWlmKHRoaXMub3B0aW9ucy5iZXppZXJDdXJ2ZSl7CgkJCQkJCQl2YXIgcHJldmlvdXMgPSBwcmV2aW91c1BvaW50KHBvaW50LCBwb2ludHNXaXRoVmFsdWVzLCBpbmRleCk7CgoJCQkJCQkJY3R4LmJlemllckN1cnZlVG8oCgkJCQkJCQkJcHJldmlvdXMuY29udHJvbFBvaW50cy5vdXRlci54LAoJCQkJCQkJCXByZXZpb3VzLmNvbnRyb2xQb2ludHMub3V0ZXIueSwKCQkJCQkJCQlwb2ludC5jb250cm9sUG9pbnRzLmlubmVyLngsCgkJCQkJCQkJcG9pbnQuY29udHJvbFBvaW50cy5pbm5lci55LAoJCQkJCQkJCXBvaW50LngsCgkJCQkJCQkJcG9pbnQueQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCQllbHNlewoJCQkJCQkJY3R4LmxpbmVUbyhwb2ludC54LHBvaW50LnkpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSwgdGhpcyk7CgoJCQkJY3R4LnN0cm9rZSgpOwoKCQkJCWlmICh0aGlzLm9wdGlvbnMuZGF0YXNldEZpbGwgJiYgcG9pbnRzV2l0aFZhbHVlcy5sZW5ndGggPiAwKXsKCQkJCQkvL1JvdW5kIG9mZiB0aGUgbGluZSBieSBnb2luZyB0byB0aGUgYmFzZSBvZiB0aGUgY2hhcnQsIGJhY2sgdG8gdGhlIHN0YXJ0LCB0aGVuIGZpbGwuCgkJCQkJY3R4LmxpbmVUbyhwb2ludHNXaXRoVmFsdWVzW3BvaW50c1dpdGhWYWx1ZXMubGVuZ3RoIC0gMV0ueCwgdGhpcy5zY2FsZS5lbmRQb2ludCk7CgkJCQkJY3R4LmxpbmVUbyhwb2ludHNXaXRoVmFsdWVzWzBdLngsIHRoaXMuc2NhbGUuZW5kUG9pbnQpOwoJCQkJCWN0eC5maWxsU3R5bGUgPSBkYXRhc2V0LmZpbGxDb2xvcjsKCQkJCQljdHguY2xvc2VQYXRoKCk7CgkJCQkJY3R4LmZpbGwoKTsKCQkJCX0KCgkJCQkvL05vdyBkcmF3IHRoZSBwb2ludHMgb3ZlciB0aGUgbGluZQoJCQkJLy9BIGxpdHRsZSBpbmVmZmljaWVudCBkb3VibGUgbG9vcGluZywgYnV0IGJldHRlciB0aGFuIHRoZSBsaW5lCgkJCQkvL2xhZ2dpbmcgYmVoaW5kIHRoZSBwb2ludCBwb3NpdGlvbnMKCQkJCWhlbHBlcnMuZWFjaChwb2ludHNXaXRoVmFsdWVzLGZ1bmN0aW9uKHBvaW50KXsKCQkJCQlwb2ludC5kcmF3KCk7CgkJCQl9KTsKCQkJfSx0aGlzKTsKCQl9Cgl9KTsKCgp9KS5jYWxsKHRoaXMpOwoKKGZ1bmN0aW9uKCl7CgkidXNlIHN0cmljdCI7CgoJdmFyIHJvb3QgPSB0aGlzLAoJCUNoYXJ0ID0gcm9vdC5DaGFydCwKCQkvL0NhY2hlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIENoYXJ0LmhlbHBlcnMKCQloZWxwZXJzID0gQ2hhcnQuaGVscGVyczsKCgl2YXIgZGVmYXVsdENvbmZpZyA9IHsKCQkvL0Jvb2xlYW4gLSBTaG93IGEgYmFja2Ryb3AgdG8gdGhlIHNjYWxlIGxhYmVsCgkJc2NhbGVTaG93TGFiZWxCYWNrZHJvcCA6IHRydWUsCgoJCS8vU3RyaW5nIC0gVGhlIGNvbG91ciBvZiB0aGUgbGFiZWwgYmFja2Ryb3AKCQlzY2FsZUJhY2tkcm9wQ29sb3IgOiAicmdiYSgyNTUsMjU1LDI1NSwwLjc1KSIsCgoJCS8vIEJvb2xlYW4gLSBXaGV0aGVyIHRoZSBzY2FsZSBzaG91bGQgYmVnaW4gYXQgemVybwoJCXNjYWxlQmVnaW5BdFplcm8gOiB0cnVlLAoKCQkvL051bWJlciAtIFRoZSBiYWNrZHJvcCBwYWRkaW5nIGFib3ZlICYgYmVsb3cgdGhlIGxhYmVsIGluIHBpeGVscwoJCXNjYWxlQmFja2Ryb3BQYWRkaW5nWSA6IDIsCgoJCS8vTnVtYmVyIC0gVGhlIGJhY2tkcm9wIHBhZGRpbmcgdG8gdGhlIHNpZGUgb2YgdGhlIGxhYmVsIGluIHBpeGVscwoJCXNjYWxlQmFja2Ryb3BQYWRkaW5nWCA6IDIsCgoJCS8vQm9vbGVhbiAtIFNob3cgbGluZSBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgc2NhbGUKCQlzY2FsZVNob3dMaW5lIDogdHJ1ZSwKCgkJLy9Cb29sZWFuIC0gU3Ryb2tlIGEgbGluZSBhcm91bmQgZWFjaCBzZWdtZW50IGluIHRoZSBjaGFydAoJCXNlZ21lbnRTaG93U3Ryb2tlIDogdHJ1ZSwKCgkJLy9TdHJpbmcgLSBUaGUgY29sb3VyIG9mIHRoZSBzdHJva2Ugb24gZWFjaCBzZWdlbWVudC4KCQlzZWdtZW50U3Ryb2tlQ29sb3IgOiAiI2ZmZiIsCgoJCS8vTnVtYmVyIC0gVGhlIHdpZHRoIG9mIHRoZSBzdHJva2UgdmFsdWUgaW4gcGl4ZWxzCgkJc2VnbWVudFN0cm9rZVdpZHRoIDogMiwKCgkJLy9OdW1iZXIgLSBBbW91bnQgb2YgYW5pbWF0aW9uIHN0ZXBzCgkJYW5pbWF0aW9uU3RlcHMgOiAxMDAsCgoJCS8vU3RyaW5nIC0gQW5pbWF0aW9uIGVhc2luZyBlZmZlY3QuCgkJYW5pbWF0aW9uRWFzaW5nIDogImVhc2VPdXRCb3VuY2UiLAoKCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIHJvdGF0aW9uIG9mIHRoZSBjaGFydAoJCWFuaW1hdGVSb3RhdGUgOiB0cnVlLAoKCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHRvIGFuaW1hdGUgc2NhbGluZyB0aGUgY2hhcnQgZnJvbSB0aGUgY2VudHJlCgkJYW5pbWF0ZVNjYWxlIDogZmFsc2UsCgoJCS8vU3RyaW5nIC0gQSBsZWdlbmQgdGVtcGxhdGUKCQlsZWdlbmRUZW1wbGF0ZSA6ICI8dWwgY2xhc3M9XCI8JT1uYW1lLnRvTG93ZXJDYXNlKCklPi1sZWdlbmRcIj48JSBmb3IgKHZhciBpPTA7IGk8c2VnbWVudHMubGVuZ3RoOyBpKyspeyU+PGxpPjxzcGFuIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjo8JT1zZWdtZW50c1tpXS5maWxsQ29sb3IlPlwiPjwvc3Bhbj48JWlmKHNlZ21lbnRzW2ldLmxhYmVsKXslPjwlPXNlZ21lbnRzW2ldLmxhYmVsJT48JX0lPjwvbGk+PCV9JT48L3VsPiIKCX07CgoKCUNoYXJ0LlR5cGUuZXh0ZW5kKHsKCQkvL1Bhc3NpbmcgaW4gYSBuYW1lIHJlZ2lzdGVycyB0aGlzIGNoYXJ0IGluIHRoZSBDaGFydCBuYW1lc3BhY2UKCQluYW1lOiAiUG9sYXJBcmVhIiwKCQkvL1Byb3ZpZGluZyBhIGRlZmF1bHRzIHdpbGwgYWxzbyByZWdpc3RlciB0aGUgZGVhZnVsdHMgaW4gdGhlIGNoYXJ0IG5hbWVzcGFjZQoJCWRlZmF1bHRzIDogZGVmYXVsdENvbmZpZywKCQkvL0luaXRpYWxpemUgaXMgZmlyZWQgd2hlbiB0aGUgY2hhcnQgaXMgaW5pdGlhbGl6ZWQgLSBEYXRhIGlzIHBhc3NlZCBpbiBhcyBhIHBhcmFtZXRlcgoJCS8vQ29uZmlnIGlzIGF1dG9tYXRpY2FsbHkgbWVyZ2VkIGJ5IHRoZSBjb3JlIG9mIENoYXJ0LmpzLCBhbmQgaXMgYXZhaWxhYmxlIGF0IHRoaXMub3B0aW9ucwoJCWluaXRpYWxpemU6ICBmdW5jdGlvbihkYXRhKXsKCQkJdGhpcy5zZWdtZW50cyA9IFtdOwoJCQkvL0RlY2xhcmUgc2VnbWVudCBjbGFzcyBhcyBhIGNoYXJ0IGluc3RhbmNlIHNwZWNpZmljIGNsYXNzLCBzbyBpdCBjYW4gc2hhcmUgcHJvcHMgZm9yIHRoaXMgaW5zdGFuY2UKCQkJdGhpcy5TZWdtZW50QXJjID0gQ2hhcnQuQXJjLmV4dGVuZCh7CgkJCQlzaG93U3Ryb2tlIDogdGhpcy5vcHRpb25zLnNlZ21lbnRTaG93U3Ryb2tlLAoJCQkJc3Ryb2tlV2lkdGggOiB0aGlzLm9wdGlvbnMuc2VnbWVudFN0cm9rZVdpZHRoLAoJCQkJc3Ryb2tlQ29sb3IgOiB0aGlzLm9wdGlvbnMuc2VnbWVudFN0cm9rZUNvbG9yLAoJCQkJY3R4IDogdGhpcy5jaGFydC5jdHgsCgkJCQlpbm5lclJhZGl1cyA6IDAsCgkJCQl4IDogdGhpcy5jaGFydC53aWR0aC8yLAoJCQkJeSA6IHRoaXMuY2hhcnQuaGVpZ2h0LzIKCQkJfSk7CgkJCXRoaXMuc2NhbGUgPSBuZXcgQ2hhcnQuUmFkaWFsU2NhbGUoewoJCQkJZGlzcGxheTogdGhpcy5vcHRpb25zLnNob3dTY2FsZSwKCQkJCWZvbnRTdHlsZTogdGhpcy5vcHRpb25zLnNjYWxlRm9udFN0eWxlLAoJCQkJZm9udFNpemU6IHRoaXMub3B0aW9ucy5zY2FsZUZvbnRTaXplLAoJCQkJZm9udEZhbWlseTogdGhpcy5vcHRpb25zLnNjYWxlRm9udEZhbWlseSwKCQkJCWZvbnRDb2xvcjogdGhpcy5vcHRpb25zLnNjYWxlRm9udENvbG9yLAoJCQkJc2hvd0xhYmVsczogdGhpcy5vcHRpb25zLnNjYWxlU2hvd0xhYmVscywKCQkJCXNob3dMYWJlbEJhY2tkcm9wOiB0aGlzLm9wdGlvbnMuc2NhbGVTaG93TGFiZWxCYWNrZHJvcCwKCQkJCWJhY2tkcm9wQ29sb3I6IHRoaXMub3B0aW9ucy5zY2FsZUJhY2tkcm9wQ29sb3IsCgkJCQliYWNrZHJvcFBhZGRpbmdZIDogdGhpcy5vcHRpb25zLnNjYWxlQmFja2Ryb3BQYWRkaW5nWSwKCQkJCWJhY2tkcm9wUGFkZGluZ1g6IHRoaXMub3B0aW9ucy5zY2FsZUJhY2tkcm9wUGFkZGluZ1gsCgkJCQlsaW5lV2lkdGg6ICh0aGlzLm9wdGlvbnMuc2NhbGVTaG93TGluZSkgPyB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lV2lkdGggOiAwLAoJCQkJbGluZUNvbG9yOiB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lQ29sb3IsCgkJCQlsaW5lQXJjOiB0cnVlLAoJCQkJd2lkdGg6IHRoaXMuY2hhcnQud2lkdGgsCgkJCQloZWlnaHQ6IHRoaXMuY2hhcnQuaGVpZ2h0LAoJCQkJeENlbnRlcjogdGhpcy5jaGFydC53aWR0aC8yLAoJCQkJeUNlbnRlcjogdGhpcy5jaGFydC5oZWlnaHQvMiwKCQkJCWN0eCA6IHRoaXMuY2hhcnQuY3R4LAoJCQkJdGVtcGxhdGVTdHJpbmc6IHRoaXMub3B0aW9ucy5zY2FsZUxhYmVsLAoJCQkJdmFsdWVzQ291bnQ6IGRhdGEubGVuZ3RoCgkJCX0pOwoKCQkJdGhpcy51cGRhdGVTY2FsZVJhbmdlKGRhdGEpOwoKCQkJdGhpcy5zY2FsZS51cGRhdGUoKTsKCgkJCWhlbHBlcnMuZWFjaChkYXRhLGZ1bmN0aW9uKHNlZ21lbnQsaW5kZXgpewoJCQkJdGhpcy5hZGREYXRhKHNlZ21lbnQsaW5kZXgsdHJ1ZSk7CgkJCX0sdGhpcyk7CgoJCQkvL1NldCB1cCB0b29sdGlwIGV2ZW50cyBvbiB0aGUgY2hhcnQKCQkJaWYgKHRoaXMub3B0aW9ucy5zaG93VG9vbHRpcHMpewoJCQkJaGVscGVycy5iaW5kRXZlbnRzKHRoaXMsIHRoaXMub3B0aW9ucy50b29sdGlwRXZlbnRzLCBmdW5jdGlvbihldnQpewoJCQkJCXZhciBhY3RpdmVTZWdtZW50cyA9IChldnQudHlwZSAhPT0gJ21vdXNlb3V0JykgPyB0aGlzLmdldFNlZ21lbnRzQXRFdmVudChldnQpIDogW107CgkJCQkJaGVscGVycy5lYWNoKHRoaXMuc2VnbWVudHMsZnVuY3Rpb24oc2VnbWVudCl7CgkJCQkJCXNlZ21lbnQucmVzdG9yZShbImZpbGxDb2xvciJdKTsKCQkJCQl9KTsKCQkJCQloZWxwZXJzLmVhY2goYWN0aXZlU2VnbWVudHMsZnVuY3Rpb24oYWN0aXZlU2VnbWVudCl7CgkJCQkJCWFjdGl2ZVNlZ21lbnQuZmlsbENvbG9yID0gYWN0aXZlU2VnbWVudC5oaWdobGlnaHRDb2xvcjsKCQkJCQl9KTsKCQkJCQl0aGlzLnNob3dUb29sdGlwKGFjdGl2ZVNlZ21lbnRzKTsKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLnJlbmRlcigpOwoJCX0sCgkJZ2V0U2VnbWVudHNBdEV2ZW50IDogZnVuY3Rpb24oZSl7CgkJCXZhciBzZWdtZW50c0FycmF5ID0gW107CgoJCQl2YXIgbG9jYXRpb24gPSBoZWxwZXJzLmdldFJlbGF0aXZlUG9zaXRpb24oZSk7CgoJCQloZWxwZXJzLmVhY2godGhpcy5zZWdtZW50cyxmdW5jdGlvbihzZWdtZW50KXsKCQkJCWlmIChzZWdtZW50LmluUmFuZ2UobG9jYXRpb24ueCxsb2NhdGlvbi55KSkgc2VnbWVudHNBcnJheS5wdXNoKHNlZ21lbnQpOwoJCQl9LHRoaXMpOwoJCQlyZXR1cm4gc2VnbWVudHNBcnJheTsKCQl9LAoJCWFkZERhdGEgOiBmdW5jdGlvbihzZWdtZW50LCBhdEluZGV4LCBzaWxlbnQpewoJCQl2YXIgaW5kZXggPSBhdEluZGV4IHx8IHRoaXMuc2VnbWVudHMubGVuZ3RoOwoKCQkJdGhpcy5zZWdtZW50cy5zcGxpY2UoaW5kZXgsIDAsIG5ldyB0aGlzLlNlZ21lbnRBcmMoewoJCQkJZmlsbENvbG9yOiBzZWdtZW50LmNvbG9yLAoJCQkJaGlnaGxpZ2h0Q29sb3I6IHNlZ21lbnQuaGlnaGxpZ2h0IHx8IHNlZ21lbnQuY29sb3IsCgkJCQlsYWJlbDogc2VnbWVudC5sYWJlbCwKCQkJCXZhbHVlOiBzZWdtZW50LnZhbHVlLAoJCQkJb3V0ZXJSYWRpdXM6ICh0aGlzLm9wdGlvbnMuYW5pbWF0ZVNjYWxlKSA/IDAgOiB0aGlzLnNjYWxlLmNhbGN1bGF0ZUNlbnRlck9mZnNldChzZWdtZW50LnZhbHVlKSwKCQkJCWNpcmN1bWZlcmVuY2U6ICh0aGlzLm9wdGlvbnMuYW5pbWF0ZVJvdGF0ZSkgPyAwIDogdGhpcy5zY2FsZS5nZXRDaXJjdW1mZXJlbmNlKCksCgkJCQlzdGFydEFuZ2xlOiBNYXRoLlBJICogMS41CgkJCX0pKTsKCQkJaWYgKCFzaWxlbnQpewoJCQkJdGhpcy5yZWZsb3coKTsKCQkJCXRoaXMudXBkYXRlKCk7CgkJCX0KCQl9LAoJCXJlbW92ZURhdGE6IGZ1bmN0aW9uKGF0SW5kZXgpewoJCQl2YXIgaW5kZXhUb0RlbGV0ZSA9IChoZWxwZXJzLmlzTnVtYmVyKGF0SW5kZXgpKSA/IGF0SW5kZXggOiB0aGlzLnNlZ21lbnRzLmxlbmd0aC0xOwoJCQl0aGlzLnNlZ21lbnRzLnNwbGljZShpbmRleFRvRGVsZXRlLCAxKTsKCQkJdGhpcy5yZWZsb3coKTsKCQkJdGhpcy51cGRhdGUoKTsKCQl9LAoJCWNhbGN1bGF0ZVRvdGFsOiBmdW5jdGlvbihkYXRhKXsKCQkJdGhpcy50b3RhbCA9IDA7CgkJCWhlbHBlcnMuZWFjaChkYXRhLGZ1bmN0aW9uKHNlZ21lbnQpewoJCQkJdGhpcy50b3RhbCArPSBzZWdtZW50LnZhbHVlOwoJCQl9LHRoaXMpOwoJCQl0aGlzLnNjYWxlLnZhbHVlc0NvdW50ID0gdGhpcy5zZWdtZW50cy5sZW5ndGg7CgkJfSwKCQl1cGRhdGVTY2FsZVJhbmdlOiBmdW5jdGlvbihkYXRhcG9pbnRzKXsKCQkJdmFyIHZhbHVlc0FycmF5ID0gW107CgkJCWhlbHBlcnMuZWFjaChkYXRhcG9pbnRzLGZ1bmN0aW9uKHNlZ21lbnQpewoJCQkJdmFsdWVzQXJyYXkucHVzaChzZWdtZW50LnZhbHVlKTsKCQkJfSk7CgoJCQl2YXIgc2NhbGVTaXplcyA9ICh0aGlzLm9wdGlvbnMuc2NhbGVPdmVycmlkZSkgPwoJCQkJewoJCQkJCXN0ZXBzOiB0aGlzLm9wdGlvbnMuc2NhbGVTdGVwcywKCQkJCQlzdGVwVmFsdWU6IHRoaXMub3B0aW9ucy5zY2FsZVN0ZXBXaWR0aCwKCQkJCQltaW46IHRoaXMub3B0aW9ucy5zY2FsZVN0YXJ0VmFsdWUsCgkJCQkJbWF4OiB0aGlzLm9wdGlvbnMuc2NhbGVTdGFydFZhbHVlICsgKHRoaXMub3B0aW9ucy5zY2FsZVN0ZXBzICogdGhpcy5vcHRpb25zLnNjYWxlU3RlcFdpZHRoKQoJCQkJfSA6CgkJCQloZWxwZXJzLmNhbGN1bGF0ZVNjYWxlUmFuZ2UoCgkJCQkJdmFsdWVzQXJyYXksCgkJCQkJaGVscGVycy5taW4oW3RoaXMuY2hhcnQud2lkdGgsIHRoaXMuY2hhcnQuaGVpZ2h0XSkvMiwKCQkJCQl0aGlzLm9wdGlvbnMuc2NhbGVGb250U2l6ZSwKCQkJCQl0aGlzLm9wdGlvbnMuc2NhbGVCZWdpbkF0WmVybywKCQkJCQl0aGlzLm9wdGlvbnMuc2NhbGVJbnRlZ2Vyc09ubHkKCQkJCSk7CgoJCQloZWxwZXJzLmV4dGVuZCgKCQkJCXRoaXMuc2NhbGUsCgkJCQlzY2FsZVNpemVzLAoJCQkJewoJCQkJCXNpemU6IGhlbHBlcnMubWluKFt0aGlzLmNoYXJ0LndpZHRoLCB0aGlzLmNoYXJ0LmhlaWdodF0pLAoJCQkJCXhDZW50ZXI6IHRoaXMuY2hhcnQud2lkdGgvMiwKCQkJCQl5Q2VudGVyOiB0aGlzLmNoYXJ0LmhlaWdodC8yCgkJCQl9CgkJCSk7CgoJCX0sCgkJdXBkYXRlIDogZnVuY3Rpb24oKXsKCQkJdGhpcy5jYWxjdWxhdGVUb3RhbCh0aGlzLnNlZ21lbnRzKTsKCgkJCWhlbHBlcnMuZWFjaCh0aGlzLnNlZ21lbnRzLGZ1bmN0aW9uKHNlZ21lbnQpewoJCQkJc2VnbWVudC5zYXZlKCk7CgkJCX0pOwoJCQkKCQkJdGhpcy5yZWZsb3coKTsKCQkJdGhpcy5yZW5kZXIoKTsKCQl9LAoJCXJlZmxvdyA6IGZ1bmN0aW9uKCl7CgkJCWhlbHBlcnMuZXh0ZW5kKHRoaXMuU2VnbWVudEFyYy5wcm90b3R5cGUsewoJCQkJeCA6IHRoaXMuY2hhcnQud2lkdGgvMiwKCQkJCXkgOiB0aGlzLmNoYXJ0LmhlaWdodC8yCgkJCX0pOwoJCQl0aGlzLnVwZGF0ZVNjYWxlUmFuZ2UodGhpcy5zZWdtZW50cyk7CgkJCXRoaXMuc2NhbGUudXBkYXRlKCk7CgoJCQloZWxwZXJzLmV4dGVuZCh0aGlzLnNjYWxlLHsKCQkJCXhDZW50ZXI6IHRoaXMuY2hhcnQud2lkdGgvMiwKCQkJCXlDZW50ZXI6IHRoaXMuY2hhcnQuaGVpZ2h0LzIKCQkJfSk7CgoJCQloZWxwZXJzLmVhY2godGhpcy5zZWdtZW50cywgZnVuY3Rpb24oc2VnbWVudCl7CgkJCQlzZWdtZW50LnVwZGF0ZSh7CgkJCQkJb3V0ZXJSYWRpdXMgOiB0aGlzLnNjYWxlLmNhbGN1bGF0ZUNlbnRlck9mZnNldChzZWdtZW50LnZhbHVlKQoJCQkJfSk7CgkJCX0sIHRoaXMpOwoKCQl9LAoJCWRyYXcgOiBmdW5jdGlvbihlYXNlKXsKCQkJdmFyIGVhc2luZ0RlY2ltYWwgPSBlYXNlIHx8IDE7CgkJCS8vQ2xlYXIgJiBkcmF3IHRoZSBjYW52YXMKCQkJdGhpcy5jbGVhcigpOwoJCQloZWxwZXJzLmVhY2godGhpcy5zZWdtZW50cyxmdW5jdGlvbihzZWdtZW50LCBpbmRleCl7CgkJCQlzZWdtZW50LnRyYW5zaXRpb24oewoJCQkJCWNpcmN1bWZlcmVuY2UgOiB0aGlzLnNjYWxlLmdldENpcmN1bWZlcmVuY2UoKSwKCQkJCQlvdXRlclJhZGl1cyA6IHRoaXMuc2NhbGUuY2FsY3VsYXRlQ2VudGVyT2Zmc2V0KHNlZ21lbnQudmFsdWUpCgkJCQl9LGVhc2luZ0RlY2ltYWwpOwoKCQkJCXNlZ21lbnQuZW5kQW5nbGUgPSBzZWdtZW50LnN0YXJ0QW5nbGUgKyBzZWdtZW50LmNpcmN1bWZlcmVuY2U7CgoJCQkJLy8gSWYgd2UndmUgcmVtb3ZlZCB0aGUgZmlyc3Qgc2VnbWVudCB3ZSBuZWVkIHRvIHNldCB0aGUgZmlyc3Qgb25lIHRvCgkJCQkvLyBzdGFydCBhdCB0aGUgdG9wLgoJCQkJaWYgKGluZGV4ID09PSAwKXsKCQkJCQlzZWdtZW50LnN0YXJ0QW5nbGUgPSBNYXRoLlBJICogMS41OwoJCQkJfQoKCQkJCS8vQ2hlY2sgdG8gc2VlIGlmIGl0J3MgdGhlIGxhc3Qgc2VnbWVudCwgaWYgbm90IGdldCB0aGUgbmV4dCBhbmQgdXBkYXRlIHRoZSBzdGFydCBhbmdsZQoJCQkJaWYgKGluZGV4IDwgdGhpcy5zZWdtZW50cy5sZW5ndGggLSAxKXsKCQkJCQl0aGlzLnNlZ21lbnRzW2luZGV4KzFdLnN0YXJ0QW5nbGUgPSBzZWdtZW50LmVuZEFuZ2xlOwoJCQkJfQoJCQkJc2VnbWVudC5kcmF3KCk7CgkJCX0sIHRoaXMpOwoJCQl0aGlzLnNjYWxlLmRyYXcoKTsKCQl9Cgl9KTsKCn0pLmNhbGwodGhpcyk7CihmdW5jdGlvbigpewoJInVzZSBzdHJpY3QiOwoKCXZhciByb290ID0gdGhpcywKCQlDaGFydCA9IHJvb3QuQ2hhcnQsCgkJaGVscGVycyA9IENoYXJ0LmhlbHBlcnM7CgoKCglDaGFydC5UeXBlLmV4dGVuZCh7CgkJbmFtZTogIlJhZGFyIiwKCQlkZWZhdWx0czp7CgkJCS8vQm9vbGVhbiAtIFdoZXRoZXIgdG8gc2hvdyBsaW5lcyBmb3IgZWFjaCBzY2FsZSBwb2ludAoJCQlzY2FsZVNob3dMaW5lIDogdHJ1ZSwKCgkJCS8vQm9vbGVhbiAtIFdoZXRoZXIgd2Ugc2hvdyB0aGUgYW5nbGUgbGluZXMgb3V0IG9mIHRoZSByYWRhcgoJCQlhbmdsZVNob3dMaW5lT3V0IDogdHJ1ZSwKCgkJCS8vQm9vbGVhbiAtIFdoZXRoZXIgdG8gc2hvdyBsYWJlbHMgb24gdGhlIHNjYWxlCgkJCXNjYWxlU2hvd0xhYmVscyA6IGZhbHNlLAoKCQkJLy8gQm9vbGVhbiAtIFdoZXRoZXIgdGhlIHNjYWxlIHNob3VsZCBiZWdpbiBhdCB6ZXJvCgkJCXNjYWxlQmVnaW5BdFplcm8gOiB0cnVlLAoKCQkJLy9TdHJpbmcgLSBDb2xvdXIgb2YgdGhlIGFuZ2xlIGxpbmUKCQkJYW5nbGVMaW5lQ29sb3IgOiAicmdiYSgwLDAsMCwuMSkiLAoKCQkJLy9OdW1iZXIgLSBQaXhlbCB3aWR0aCBvZiB0aGUgYW5nbGUgbGluZQoJCQlhbmdsZUxpbmVXaWR0aCA6IDEsCgoJCQkvL1N0cmluZyAtIFBvaW50IGxhYmVsIGZvbnQgZGVjbGFyYXRpb24KCQkJcG9pbnRMYWJlbEZvbnRGYW1pbHkgOiAiJ0FyaWFsJyIsCgoJCQkvL1N0cmluZyAtIFBvaW50IGxhYmVsIGZvbnQgd2VpZ2h0CgkJCXBvaW50TGFiZWxGb250U3R5bGUgOiAibm9ybWFsIiwKCgkJCS8vTnVtYmVyIC0gUG9pbnQgbGFiZWwgZm9udCBzaXplIGluIHBpeGVscwoJCQlwb2ludExhYmVsRm9udFNpemUgOiAxMCwKCgkJCS8vU3RyaW5nIC0gUG9pbnQgbGFiZWwgZm9udCBjb2xvdXIKCQkJcG9pbnRMYWJlbEZvbnRDb2xvciA6ICIjNjY2IiwKCgkJCS8vQm9vbGVhbiAtIFdoZXRoZXIgdG8gc2hvdyBhIGRvdCBmb3IgZWFjaCBwb2ludAoJCQlwb2ludERvdCA6IHRydWUsCgoJCQkvL051bWJlciAtIFJhZGl1cyBvZiBlYWNoIHBvaW50IGRvdCBpbiBwaXhlbHMKCQkJcG9pbnREb3RSYWRpdXMgOiAzLAoKCQkJLy9OdW1iZXIgLSBQaXhlbCB3aWR0aCBvZiBwb2ludCBkb3Qgc3Ryb2tlCgkJCXBvaW50RG90U3Ryb2tlV2lkdGggOiAxLAoKCQkJLy9OdW1iZXIgLSBhbW91bnQgZXh0cmEgdG8gYWRkIHRvIHRoZSByYWRpdXMgdG8gY2F0ZXIgZm9yIGhpdCBkZXRlY3Rpb24gb3V0c2lkZSB0aGUgZHJhd24gcG9pbnQKCQkJcG9pbnRIaXREZXRlY3Rpb25SYWRpdXMgOiAyMCwKCgkJCS8vQm9vbGVhbiAtIFdoZXRoZXIgdG8gc2hvdyBhIHN0cm9rZSBmb3IgZGF0YXNldHMKCQkJZGF0YXNldFN0cm9rZSA6IHRydWUsCgoJCQkvL051bWJlciAtIFBpeGVsIHdpZHRoIG9mIGRhdGFzZXQgc3Ryb2tlCgkJCWRhdGFzZXRTdHJva2VXaWR0aCA6IDIsCgoJCQkvL0Jvb2xlYW4gLSBXaGV0aGVyIHRvIGZpbGwgdGhlIGRhdGFzZXQgd2l0aCBhIGNvbG91cgoJCQlkYXRhc2V0RmlsbCA6IHRydWUsCgoJCQkvL1N0cmluZyAtIEEgbGVnZW5kIHRlbXBsYXRlCgkJCWxlZ2VuZFRlbXBsYXRlIDogIjx1bCBjbGFzcz1cIjwlPW5hbWUudG9Mb3dlckNhc2UoKSU+LWxlZ2VuZFwiPjwlIGZvciAodmFyIGk9MDsgaTxkYXRhc2V0cy5sZW5ndGg7IGkrKyl7JT48bGk+PHNwYW4gc3R5bGU9XCJiYWNrZ3JvdW5kLWNvbG9yOjwlPWRhdGFzZXRzW2ldLnN0cm9rZUNvbG9yJT5cIj48L3NwYW4+PCVpZihkYXRhc2V0c1tpXS5sYWJlbCl7JT48JT1kYXRhc2V0c1tpXS5sYWJlbCU+PCV9JT48L2xpPjwlfSU+PC91bD4iCgoJCX0sCgoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKGRhdGEpewoJCQl0aGlzLlBvaW50Q2xhc3MgPSBDaGFydC5Qb2ludC5leHRlbmQoewoJCQkJc3Ryb2tlV2lkdGggOiB0aGlzLm9wdGlvbnMucG9pbnREb3RTdHJva2VXaWR0aCwKCQkJCXJhZGl1cyA6IHRoaXMub3B0aW9ucy5wb2ludERvdFJhZGl1cywKCQkJCWRpc3BsYXk6IHRoaXMub3B0aW9ucy5wb2ludERvdCwKCQkJCWhpdERldGVjdGlvblJhZGl1cyA6IHRoaXMub3B0aW9ucy5wb2ludEhpdERldGVjdGlvblJhZGl1cywKCQkJCWN0eCA6IHRoaXMuY2hhcnQuY3R4CgkJCX0pOwoKCQkJdGhpcy5kYXRhc2V0cyA9IFtdOwoKCQkJdGhpcy5idWlsZFNjYWxlKGRhdGEpOwoKCQkJLy9TZXQgdXAgdG9vbHRpcCBldmVudHMgb24gdGhlIGNoYXJ0CgkJCWlmICh0aGlzLm9wdGlvbnMuc2hvd1Rvb2x0aXBzKXsKCQkJCWhlbHBlcnMuYmluZEV2ZW50cyh0aGlzLCB0aGlzLm9wdGlvbnMudG9vbHRpcEV2ZW50cywgZnVuY3Rpb24oZXZ0KXsKCQkJCQl2YXIgYWN0aXZlUG9pbnRzQ29sbGVjdGlvbiA9IChldnQudHlwZSAhPT0gJ21vdXNlb3V0JykgPyB0aGlzLmdldFBvaW50c0F0RXZlbnQoZXZ0KSA6IFtdOwoKCQkJCQl0aGlzLmVhY2hQb2ludHMoZnVuY3Rpb24ocG9pbnQpewoJCQkJCQlwb2ludC5yZXN0b3JlKFsnZmlsbENvbG9yJywgJ3N0cm9rZUNvbG9yJ10pOwoJCQkJCX0pOwoJCQkJCWhlbHBlcnMuZWFjaChhY3RpdmVQb2ludHNDb2xsZWN0aW9uLCBmdW5jdGlvbihhY3RpdmVQb2ludCl7CgkJCQkJCWFjdGl2ZVBvaW50LmZpbGxDb2xvciA9IGFjdGl2ZVBvaW50LmhpZ2hsaWdodEZpbGw7CgkJCQkJCWFjdGl2ZVBvaW50LnN0cm9rZUNvbG9yID0gYWN0aXZlUG9pbnQuaGlnaGxpZ2h0U3Ryb2tlOwoJCQkJCX0pOwoKCQkJCQl0aGlzLnNob3dUb29sdGlwKGFjdGl2ZVBvaW50c0NvbGxlY3Rpb24pOwoJCQkJfSk7CgkJCX0KCgkJCS8vSXRlcmF0ZSB0aHJvdWdoIGVhY2ggb2YgdGhlIGRhdGFzZXRzLCBhbmQgYnVpbGQgdGhpcyBpbnRvIGEgcHJvcGVydHkgb2YgdGhlIGNoYXJ0CgkJCWhlbHBlcnMuZWFjaChkYXRhLmRhdGFzZXRzLGZ1bmN0aW9uKGRhdGFzZXQpewoKCQkJCXZhciBkYXRhc2V0T2JqZWN0ID0gewoJCQkJCWxhYmVsOiBkYXRhc2V0LmxhYmVsIHx8IG51bGwsCgkJCQkJZmlsbENvbG9yIDogZGF0YXNldC5maWxsQ29sb3IsCgkJCQkJc3Ryb2tlQ29sb3IgOiBkYXRhc2V0LnN0cm9rZUNvbG9yLAoJCQkJCXBvaW50Q29sb3IgOiBkYXRhc2V0LnBvaW50Q29sb3IsCgkJCQkJcG9pbnRTdHJva2VDb2xvciA6IGRhdGFzZXQucG9pbnRTdHJva2VDb2xvciwKCQkJCQlwb2ludHMgOiBbXQoJCQkJfTsKCgkJCQl0aGlzLmRhdGFzZXRzLnB1c2goZGF0YXNldE9iamVjdCk7CgoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQuZGF0YSxmdW5jdGlvbihkYXRhUG9pbnQsaW5kZXgpewoJCQkJCS8vQWRkIGEgbmV3IHBvaW50IGZvciBlYWNoIHBpZWNlIG9mIGRhdGEsIHBhc3NpbmcgYW55IHJlcXVpcmVkIGRhdGEgdG8gZHJhdy4KCQkJCQl2YXIgcG9pbnRQb3NpdGlvbjsKCQkJCQlpZiAoIXRoaXMuc2NhbGUuYW5pbWF0aW9uKXsKCQkJCQkJcG9pbnRQb3NpdGlvbiA9IHRoaXMuc2NhbGUuZ2V0UG9pbnRQb3NpdGlvbihpbmRleCwgdGhpcy5zY2FsZS5jYWxjdWxhdGVDZW50ZXJPZmZzZXQoZGF0YVBvaW50KSk7CgkJCQkJfQoJCQkJCWRhdGFzZXRPYmplY3QucG9pbnRzLnB1c2gobmV3IHRoaXMuUG9pbnRDbGFzcyh7CgkJCQkJCXZhbHVlIDogZGF0YVBvaW50LAoJCQkJCQlsYWJlbCA6IGRhdGEubGFiZWxzW2luZGV4XSwKCQkJCQkJZGF0YXNldExhYmVsOiBkYXRhc2V0LmxhYmVsLAoJCQkJCQl4OiAodGhpcy5vcHRpb25zLmFuaW1hdGlvbikgPyB0aGlzLnNjYWxlLnhDZW50ZXIgOiBwb2ludFBvc2l0aW9uLngsCgkJCQkJCXk6ICh0aGlzLm9wdGlvbnMuYW5pbWF0aW9uKSA/IHRoaXMuc2NhbGUueUNlbnRlciA6IHBvaW50UG9zaXRpb24ueSwKCQkJCQkJc3Ryb2tlQ29sb3IgOiBkYXRhc2V0LnBvaW50U3Ryb2tlQ29sb3IsCgkJCQkJCWZpbGxDb2xvciA6IGRhdGFzZXQucG9pbnRDb2xvciwKCQkJCQkJaGlnaGxpZ2h0RmlsbCA6IGRhdGFzZXQucG9pbnRIaWdobGlnaHRGaWxsIHx8IGRhdGFzZXQucG9pbnRDb2xvciwKCQkJCQkJaGlnaGxpZ2h0U3Ryb2tlIDogZGF0YXNldC5wb2ludEhpZ2hsaWdodFN0cm9rZSB8fCBkYXRhc2V0LnBvaW50U3Ryb2tlQ29sb3IKCQkJCQl9KSk7CgkJCQl9LHRoaXMpOwoKCQkJfSx0aGlzKTsKCgkJCXRoaXMucmVuZGVyKCk7CgkJfSwKCQllYWNoUG9pbnRzIDogZnVuY3Rpb24oY2FsbGJhY2spewoJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0KXsKCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0LnBvaW50cyxjYWxsYmFjayx0aGlzKTsKCQkJfSx0aGlzKTsKCQl9LAoKCQlnZXRQb2ludHNBdEV2ZW50IDogZnVuY3Rpb24oZXZ0KXsKCQkJdmFyIG1vdXNlUG9zaXRpb24gPSBoZWxwZXJzLmdldFJlbGF0aXZlUG9zaXRpb24oZXZ0KSwKCQkJCWZyb21DZW50ZXIgPSBoZWxwZXJzLmdldEFuZ2xlRnJvbVBvaW50KHsKCQkJCQl4OiB0aGlzLnNjYWxlLnhDZW50ZXIsCgkJCQkJeTogdGhpcy5zY2FsZS55Q2VudGVyCgkJCQl9LCBtb3VzZVBvc2l0aW9uKTsKCgkJCXZhciBhbmdsZVBlckluZGV4ID0gKE1hdGguUEkgKiAyKSAvdGhpcy5zY2FsZS52YWx1ZXNDb3VudCwKCQkJCXBvaW50SW5kZXggPSBNYXRoLnJvdW5kKChmcm9tQ2VudGVyLmFuZ2xlIC0gTWF0aC5QSSAqIDEuNSkgLyBhbmdsZVBlckluZGV4KSwKCQkJCWFjdGl2ZVBvaW50c0NvbGxlY3Rpb24gPSBbXTsKCgkJCS8vIElmIHdlJ3JlIGF0IHRoZSB0b3AsIG1ha2UgdGhlIHBvaW50SW5kZXggMCB0byBnZXQgdGhlIGZpcnN0IG9mIHRoZSBhcnJheS4KCQkJaWYgKHBvaW50SW5kZXggPj0gdGhpcy5zY2FsZS52YWx1ZXNDb3VudCB8fCBwb2ludEluZGV4IDwgMCl7CgkJCQlwb2ludEluZGV4ID0gMDsKCQkJfQoKCQkJaWYgKGZyb21DZW50ZXIuZGlzdGFuY2UgPD0gdGhpcy5zY2FsZS5kcmF3aW5nQXJlYSl7CgkJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCl7CgkJCQkJYWN0aXZlUG9pbnRzQ29sbGVjdGlvbi5wdXNoKGRhdGFzZXQucG9pbnRzW3BvaW50SW5kZXhdKTsKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gYWN0aXZlUG9pbnRzQ29sbGVjdGlvbjsKCQl9LAoKCQlidWlsZFNjYWxlIDogZnVuY3Rpb24oZGF0YSl7CgkJCXRoaXMuc2NhbGUgPSBuZXcgQ2hhcnQuUmFkaWFsU2NhbGUoewoJCQkJZGlzcGxheTogdGhpcy5vcHRpb25zLnNob3dTY2FsZSwKCQkJCWZvbnRTdHlsZTogdGhpcy5vcHRpb25zLnNjYWxlRm9udFN0eWxlLAoJCQkJZm9udFNpemU6IHRoaXMub3B0aW9ucy5zY2FsZUZvbnRTaXplLAoJCQkJZm9udEZhbWlseTogdGhpcy5vcHRpb25zLnNjYWxlRm9udEZhbWlseSwKCQkJCWZvbnRDb2xvcjogdGhpcy5vcHRpb25zLnNjYWxlRm9udENvbG9yLAoJCQkJc2hvd0xhYmVsczogdGhpcy5vcHRpb25zLnNjYWxlU2hvd0xhYmVscywKCQkJCXNob3dMYWJlbEJhY2tkcm9wOiB0aGlzLm9wdGlvbnMuc2NhbGVTaG93TGFiZWxCYWNrZHJvcCwKCQkJCWJhY2tkcm9wQ29sb3I6IHRoaXMub3B0aW9ucy5zY2FsZUJhY2tkcm9wQ29sb3IsCgkJCQliYWNrZHJvcFBhZGRpbmdZIDogdGhpcy5vcHRpb25zLnNjYWxlQmFja2Ryb3BQYWRkaW5nWSwKCQkJCWJhY2tkcm9wUGFkZGluZ1g6IHRoaXMub3B0aW9ucy5zY2FsZUJhY2tkcm9wUGFkZGluZ1gsCgkJCQlsaW5lV2lkdGg6ICh0aGlzLm9wdGlvbnMuc2NhbGVTaG93TGluZSkgPyB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lV2lkdGggOiAwLAoJCQkJbGluZUNvbG9yOiB0aGlzLm9wdGlvbnMuc2NhbGVMaW5lQ29sb3IsCgkJCQlhbmdsZUxpbmVDb2xvciA6IHRoaXMub3B0aW9ucy5hbmdsZUxpbmVDb2xvciwKCQkJCWFuZ2xlTGluZVdpZHRoIDogKHRoaXMub3B0aW9ucy5hbmdsZVNob3dMaW5lT3V0KSA/IHRoaXMub3B0aW9ucy5hbmdsZUxpbmVXaWR0aCA6IDAsCgkJCQkvLyBQb2ludCBsYWJlbHMgYXQgdGhlIGVkZ2Ugb2YgZWFjaCBsaW5lCgkJCQlwb2ludExhYmVsRm9udENvbG9yIDogdGhpcy5vcHRpb25zLnBvaW50TGFiZWxGb250Q29sb3IsCgkJCQlwb2ludExhYmVsRm9udFNpemUgOiB0aGlzLm9wdGlvbnMucG9pbnRMYWJlbEZvbnRTaXplLAoJCQkJcG9pbnRMYWJlbEZvbnRGYW1pbHkgOiB0aGlzLm9wdGlvbnMucG9pbnRMYWJlbEZvbnRGYW1pbHksCgkJCQlwb2ludExhYmVsRm9udFN0eWxlIDogdGhpcy5vcHRpb25zLnBvaW50TGFiZWxGb250U3R5bGUsCgkJCQloZWlnaHQgOiB0aGlzLmNoYXJ0LmhlaWdodCwKCQkJCXdpZHRoOiB0aGlzLmNoYXJ0LndpZHRoLAoJCQkJeENlbnRlcjogdGhpcy5jaGFydC53aWR0aC8yLAoJCQkJeUNlbnRlcjogdGhpcy5jaGFydC5oZWlnaHQvMiwKCQkJCWN0eCA6IHRoaXMuY2hhcnQuY3R4LAoJCQkJdGVtcGxhdGVTdHJpbmc6IHRoaXMub3B0aW9ucy5zY2FsZUxhYmVsLAoJCQkJbGFiZWxzOiBkYXRhLmxhYmVscywKCQkJCXZhbHVlc0NvdW50OiBkYXRhLmRhdGFzZXRzWzBdLmRhdGEubGVuZ3RoCgkJCX0pOwoKCQkJdGhpcy5zY2FsZS5zZXRTY2FsZVNpemUoKTsKCQkJdGhpcy51cGRhdGVTY2FsZVJhbmdlKGRhdGEuZGF0YXNldHMpOwoJCQl0aGlzLnNjYWxlLmJ1aWxkWUxhYmVscygpOwoJCX0sCgkJdXBkYXRlU2NhbGVSYW5nZTogZnVuY3Rpb24oZGF0YXNldHMpewoJCQl2YXIgdmFsdWVzQXJyYXkgPSAoZnVuY3Rpb24oKXsKCQkJCXZhciB0b3RhbERhdGFBcnJheSA9IFtdOwoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXRzLGZ1bmN0aW9uKGRhdGFzZXQpewoJCQkJCWlmIChkYXRhc2V0LmRhdGEpewoJCQkJCQl0b3RhbERhdGFBcnJheSA9IHRvdGFsRGF0YUFycmF5LmNvbmNhdChkYXRhc2V0LmRhdGEpOwoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQucG9pbnRzLCBmdW5jdGlvbihwb2ludCl7CgkJCQkJCQl0b3RhbERhdGFBcnJheS5wdXNoKHBvaW50LnZhbHVlKTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSk7CgkJCQlyZXR1cm4gdG90YWxEYXRhQXJyYXk7CgkJCX0pKCk7CgoKCQkJdmFyIHNjYWxlU2l6ZXMgPSAodGhpcy5vcHRpb25zLnNjYWxlT3ZlcnJpZGUpID8KCQkJCXsKCQkJCQlzdGVwczogdGhpcy5vcHRpb25zLnNjYWxlU3RlcHMsCgkJCQkJc3RlcFZhbHVlOiB0aGlzLm9wdGlvbnMuc2NhbGVTdGVwV2lkdGgsCgkJCQkJbWluOiB0aGlzLm9wdGlvbnMuc2NhbGVTdGFydFZhbHVlLAoJCQkJCW1heDogdGhpcy5vcHRpb25zLnNjYWxlU3RhcnRWYWx1ZSArICh0aGlzLm9wdGlvbnMuc2NhbGVTdGVwcyAqIHRoaXMub3B0aW9ucy5zY2FsZVN0ZXBXaWR0aCkKCQkJCX0gOgoJCQkJaGVscGVycy5jYWxjdWxhdGVTY2FsZVJhbmdlKAoJCQkJCXZhbHVlc0FycmF5LAoJCQkJCWhlbHBlcnMubWluKFt0aGlzLmNoYXJ0LndpZHRoLCB0aGlzLmNoYXJ0LmhlaWdodF0pLzIsCgkJCQkJdGhpcy5vcHRpb25zLnNjYWxlRm9udFNpemUsCgkJCQkJdGhpcy5vcHRpb25zLnNjYWxlQmVnaW5BdFplcm8sCgkJCQkJdGhpcy5vcHRpb25zLnNjYWxlSW50ZWdlcnNPbmx5CgkJCQkpOwoKCQkJaGVscGVycy5leHRlbmQoCgkJCQl0aGlzLnNjYWxlLAoJCQkJc2NhbGVTaXplcwoJCQkpOwoKCQl9LAoJCWFkZERhdGEgOiBmdW5jdGlvbih2YWx1ZXNBcnJheSxsYWJlbCl7CgkJCS8vTWFwIHRoZSB2YWx1ZXMgYXJyYXkgZm9yIGVhY2ggb2YgdGhlIGRhdGFzZXRzCgkJCXRoaXMuc2NhbGUudmFsdWVzQ291bnQrKzsKCQkJaGVscGVycy5lYWNoKHZhbHVlc0FycmF5LGZ1bmN0aW9uKHZhbHVlLGRhdGFzZXRJbmRleCl7CgkJCQl2YXIgcG9pbnRQb3NpdGlvbiA9IHRoaXMuc2NhbGUuZ2V0UG9pbnRQb3NpdGlvbih0aGlzLnNjYWxlLnZhbHVlc0NvdW50LCB0aGlzLnNjYWxlLmNhbGN1bGF0ZUNlbnRlck9mZnNldCh2YWx1ZSkpOwoJCQkJdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLnBvaW50cy5wdXNoKG5ldyB0aGlzLlBvaW50Q2xhc3MoewoJCQkJCXZhbHVlIDogdmFsdWUsCgkJCQkJbGFiZWwgOiBsYWJlbCwKCQkJCQl4OiBwb2ludFBvc2l0aW9uLngsCgkJCQkJeTogcG9pbnRQb3NpdGlvbi55LAoJCQkJCXN0cm9rZUNvbG9yIDogdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLnBvaW50U3Ryb2tlQ29sb3IsCgkJCQkJZmlsbENvbG9yIDogdGhpcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLnBvaW50Q29sb3IKCQkJCX0pKTsKCQkJfSx0aGlzKTsKCgkJCXRoaXMuc2NhbGUubGFiZWxzLnB1c2gobGFiZWwpOwoKCQkJdGhpcy5yZWZsb3coKTsKCgkJCXRoaXMudXBkYXRlKCk7CgkJfSwKCQlyZW1vdmVEYXRhIDogZnVuY3Rpb24oKXsKCQkJdGhpcy5zY2FsZS52YWx1ZXNDb3VudC0tOwoJCQl0aGlzLnNjYWxlLmxhYmVscy5zaGlmdCgpOwoJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0KXsKCQkJCWRhdGFzZXQucG9pbnRzLnNoaWZ0KCk7CgkJCX0sdGhpcyk7CgkJCXRoaXMucmVmbG93KCk7CgkJCXRoaXMudXBkYXRlKCk7CgkJfSwKCQl1cGRhdGUgOiBmdW5jdGlvbigpewoJCQl0aGlzLmVhY2hQb2ludHMoZnVuY3Rpb24ocG9pbnQpewoJCQkJcG9pbnQuc2F2ZSgpOwoJCQl9KTsKCQkJdGhpcy5yZWZsb3coKTsKCQkJdGhpcy5yZW5kZXIoKTsKCQl9LAoJCXJlZmxvdzogZnVuY3Rpb24oKXsKCQkJaGVscGVycy5leHRlbmQodGhpcy5zY2FsZSwgewoJCQkJd2lkdGggOiB0aGlzLmNoYXJ0LndpZHRoLAoJCQkJaGVpZ2h0OiB0aGlzLmNoYXJ0LmhlaWdodCwKCQkJCXNpemUgOiBoZWxwZXJzLm1pbihbdGhpcy5jaGFydC53aWR0aCwgdGhpcy5jaGFydC5oZWlnaHRdKSwKCQkJCXhDZW50ZXI6IHRoaXMuY2hhcnQud2lkdGgvMiwKCQkJCXlDZW50ZXI6IHRoaXMuY2hhcnQuaGVpZ2h0LzIKCQkJfSk7CgkJCXRoaXMudXBkYXRlU2NhbGVSYW5nZSh0aGlzLmRhdGFzZXRzKTsKCQkJdGhpcy5zY2FsZS5zZXRTY2FsZVNpemUoKTsKCQkJdGhpcy5zY2FsZS5idWlsZFlMYWJlbHMoKTsKCQl9LAoJCWRyYXcgOiBmdW5jdGlvbihlYXNlKXsKCQkJdmFyIGVhc2VEZWNpbWFsID0gZWFzZSB8fCAxLAoJCQkJY3R4ID0gdGhpcy5jaGFydC5jdHg7CgkJCXRoaXMuY2xlYXIoKTsKCQkJdGhpcy5zY2FsZS5kcmF3KCk7CgoJCQloZWxwZXJzLmVhY2godGhpcy5kYXRhc2V0cyxmdW5jdGlvbihkYXRhc2V0KXsKCgkJCQkvL1RyYW5zaXRpb24gZWFjaCBwb2ludCBmaXJzdCBzbyB0aGF0IHRoZSBsaW5lIGFuZCBwb2ludCBkcmF3aW5nIGlzbid0IG91dCBvZiBzeW5jCgkJCQloZWxwZXJzLmVhY2goZGF0YXNldC5wb2ludHMsZnVuY3Rpb24ocG9pbnQsaW5kZXgpewoJCQkJCWlmIChwb2ludC5oYXNWYWx1ZSgpKXsKCQkJCQkJcG9pbnQudHJhbnNpdGlvbih0aGlzLnNjYWxlLmdldFBvaW50UG9zaXRpb24oaW5kZXgsIHRoaXMuc2NhbGUuY2FsY3VsYXRlQ2VudGVyT2Zmc2V0KHBvaW50LnZhbHVlKSksIGVhc2VEZWNpbWFsKTsKCQkJCQl9CgkJCQl9LHRoaXMpOwoKCgoJCQkJLy9EcmF3IHRoZSBsaW5lIGJldHdlZW4gYWxsIHRoZSBwb2ludHMKCQkJCWN0eC5saW5lV2lkdGggPSB0aGlzLm9wdGlvbnMuZGF0YXNldFN0cm9rZVdpZHRoOwoJCQkJY3R4LnN0cm9rZVN0eWxlID0gZGF0YXNldC5zdHJva2VDb2xvcjsKCQkJCWN0eC5iZWdpblBhdGgoKTsKCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0LnBvaW50cyxmdW5jdGlvbihwb2ludCxpbmRleCl7CgkJCQkJaWYgKGluZGV4ID09PSAwKXsKCQkJCQkJY3R4Lm1vdmVUbyhwb2ludC54LHBvaW50LnkpOwoJCQkJCX0KCQkJCQllbHNlewoJCQkJCQljdHgubGluZVRvKHBvaW50LngscG9pbnQueSk7CgkJCQkJfQoJCQkJfSx0aGlzKTsKCQkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJCWN0eC5zdHJva2UoKTsKCgkJCQljdHguZmlsbFN0eWxlID0gZGF0YXNldC5maWxsQ29sb3I7CgkJCQljdHguZmlsbCgpOwoKCQkJCS8vTm93IGRyYXcgdGhlIHBvaW50cyBvdmVyIHRoZSBsaW5lCgkJCQkvL0EgbGl0dGxlIGluZWZmaWNpZW50IGRvdWJsZSBsb29waW5nLCBidXQgYmV0dGVyIHRoYW4gdGhlIGxpbmUKCQkJCS8vbGFnZ2luZyBiZWhpbmQgdGhlIHBvaW50IHBvc2l0aW9ucwoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQucG9pbnRzLGZ1bmN0aW9uKHBvaW50KXsKCQkJCQlpZiAocG9pbnQuaGFzVmFsdWUoKSl7CgkJCQkJCXBvaW50LmRyYXcoKTsKCQkJCQl9CgkJCQl9KTsKCgkJCX0sdGhpcyk7CgoJCX0KCgl9KTsKCgoKCgp9KS5jYWxsKHRoaXMpOw=="></script>
<script src="data:application/x-javascript;base64,SFRNTFdpZGdldHMud2lkZ2V0KHsNCg0KICBuYW1lOiAnY2hhcnRKU1JhZGFyJywNCg0KICB0eXBlOiAnb3V0cHV0JywNCg0KICBpbml0aWFsaXplOiBmdW5jdGlvbihlbCwgd2lkdGgsIGhlaWdodCkgew0KDQogICAgdmFyIENoYXJ0anMgPSBuZXcgQ2hhcnQoZWwuZ2V0Q29udGV4dCgiMmQiKSk7DQoNCiAgICByZXR1cm4gew0KICAgICAgIENoYXJ0anM6IENoYXJ0anMNCiAgICB9DQoNCiAgfSwNCg0KICByZW5kZXJWYWx1ZTogZnVuY3Rpb24oZWwsIHgsIGluc3RhbmNlKSB7DQoNCiAgICANCiAgICAvLyBHZXQgdGhlIGNvbnRleHQgb2YgdGhlIGNhbnZhcyBlbGVtZW50IHdlIHdhbnQgdG8gc2VsZWN0DQogICAgdmFyIG15UmFkYXJDaGFydCA9IGluc3RhbmNlLkNoYXJ0anMuUmFkYXIoeC5kYXRhLCB4Lm9wdGlvbnMpOw0KDQoNCiAgfSwNCg0KICByZXNpemU6IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0LCBpbnN0YW5jZSkgew0KDQogIH0NCg0KfSk7DQo="></script>

</head>
<body style="background-color:white;">
<div id="htmlwidget_container">
  <canvas id="htmlwidget-c30588bc9a103229a2c3" class="chartJSRadar html-widget" width="960" height="500"></canvas>
</div>
<script type="application/json" data-for="htmlwidget-c30588bc9a103229a2c3">{"x":{"data":{"labels":["Communicator","Data Wangler","Programmer","Technologist","Modeller","Visualizer"],"datasets":[{"label":"Rich","data":[9,7,4,5,3,7],"fillColor":"rgba(255,0,0,0.2)","strokeColor":"rgba(255,0,0,0.8)","pointColor":"rgba(255,0,0,0.8)","pointStrokeColor":"#fff","pointHighlightFill":"#fff","pointHighlightStroke":"rgba(255,0,0,0.8)"},{"label":"Andy","data":[7,6,6,2,6,9],"fillColor":"rgba(0,255,0,0.2)","strokeColor":"rgba(0,255,0,0.8)","pointColor":"rgba(0,255,0,0.8)","pointStrokeColor":"#fff","pointHighlightFill":"#fff","pointHighlightStroke":"rgba(0,255,0,0.8)"},{"label":"Aimee","data":[6,5,8,4,7,6],"fillColor":"rgba(0,0,255,0.2)","strokeColor":"rgba(0,0,255,0.8)","pointColor":"rgba(0,0,255,0.8)","pointStrokeColor":"#fff","pointHighlightFill":"#fff","pointHighlightStroke":"rgba(0,0,255,0.8)"}]},"options":{"responsive":true,"pointLabelFontSize":18,"pointDot":true,"scaleOverride":true,"scaleStepWidth":1,"scaleSteps":10,"scaleStartValue":0}},"evals":[],"jsHooks":[]}</script>
<script type="application/htmlwidget-sizing" data-for="htmlwidget-c30588bc9a103229a2c3">{"viewer":{"width":800,"height":600,"padding":0,"fill":true},"browser":{"width":800,"height":600,"padding":0,"fill":false}}</script>
</body>
</html>
